<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RabbitMQ | 小朱杂记</title>
    <meta name="description" content="My Document">
    <link rel="preload stylesheet" href="/charles-blog/assets/style.f8bbea1d.css" as="style">
    <script type="module" src="/charles-blog/assets/app.cb5cef1a.js"></script>
    <link rel="preload" href="/charles-blog/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/charles-blog/assets/chunks/framework.981adca9.js">
  <link rel="modulepreload" href="/charles-blog/assets/chunks/theme.190b9110.js">
  <link rel="modulepreload" href="/charles-blog/assets/chunks/ArticleMetadata.8b6b367a.js">
  <link rel="modulepreload" href="/charles-blog/assets/md_middleware_Rabbitmq.md.17ee6046.lean.js">
  <link rel="icon" href="/charles-blog/favicon.ico">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-fc105c82><!--[--><!--]--><!--[--><span tabindex="-1" data-v-827f7975></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-827f7975> Skip to content </a><!--]--><!----><header class="VPNav" data-v-fc105c82 data-v-4765fb17><div class="VPNavBar has-sidebar" data-v-4765fb17 data-v-c560f0cd><div class="container" data-v-c560f0cd><div class="title" data-v-c560f0cd><div class="VPNavBarTitle has-sidebar" data-v-c560f0cd data-v-ebec4beb><a class="title" href="/charles-blog/" data-v-ebec4beb><!--[--><!--]--><!----><!--[-->小朱杂记<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-c560f0cd><div class="curtain" data-v-c560f0cd></div><div class="content-body" data-v-c560f0cd><!--[--><!--]--><div class="VPNavBarSearch search" style="--vp-meta-key:&#39;Meta&#39;;" data-v-c560f0cd><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-c560f0cd data-v-8a05be25><span id="main-nav-aria-label" class="visually-hidden" data-v-8a05be25>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/java/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->Java<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/database/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->数据库<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/charles-blog/md/middleware/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->中间件<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/network/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->网络<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/environment/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->环境<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/distributed/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->分布式<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/about/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->关于我<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-c560f0cd data-v-7489216d><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-7489216d data-v-c852f474 data-v-43044c5b><span class="check" data-v-43044c5b><span class="icon" data-v-43044c5b><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-c852f474><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-c852f474><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-c560f0cd data-v-46915da0 data-v-5e7b6306><!--[--><a class="VPSocialLink" href="https://github.com/CharleZhuJJ/charles-blog" aria-label="github" target="_blank" rel="noopener" data-v-5e7b6306 data-v-5124df20><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-c560f0cd data-v-0f46c100 data-v-fa61944e><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-fa61944e><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-fa61944e><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-fa61944e><div class="VPMenu" data-v-fa61944e data-v-4eba600d><!----><!--[--><!--[--><!----><div class="group" data-v-0f46c100><div class="item appearance" data-v-0f46c100><p class="label" data-v-0f46c100>切换日光/暗黑模式</p><div class="appearance-action" data-v-0f46c100><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-0f46c100 data-v-c852f474 data-v-43044c5b><span class="check" data-v-43044c5b><span class="icon" data-v-43044c5b><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-c852f474><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-c852f474><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-0f46c100><div class="item social-links" data-v-0f46c100><div class="VPSocialLinks social-links-list" data-v-0f46c100 data-v-5e7b6306><!--[--><a class="VPSocialLink" href="https://github.com/CharleZhuJJ/charles-blog" aria-label="github" target="_blank" rel="noopener" data-v-5e7b6306 data-v-5124df20><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-c560f0cd data-v-05cc2436><span class="container" data-v-05cc2436><span class="top" data-v-05cc2436></span><span class="middle" data-v-05cc2436></span><span class="bottom" data-v-05cc2436></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-fc105c82 data-v-c9d1ee7c><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-c9d1ee7c><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-c9d1ee7c><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-c9d1ee7c>文章</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-c9d1ee7c data-v-43a3820c><button data-v-43a3820c>返回顶部</button><!----></div></div><aside class="VPSidebar" data-v-fc105c82 data-v-def99251><div class="curtain" data-v-def99251></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-def99251><span class="visually-hidden" id="sidebar-aria-label" data-v-def99251> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-def99251><section class="VPSidebarItem level-0 is-link has-active" data-v-def99251 data-v-94aa024f><div class="item" tabindex="0" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/" data-v-94aa024f data-v-a8e5736d><!--[--><h2 class="text" data-v-94aa024f>中间件</h2><!--]--><!----></a><!----></div><div class="items" data-v-94aa024f><!--[--><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Nginx.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>Nginx</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link is-active has-active" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Rabbitmq.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>RabbitMQ</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Zookeeper.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>Zookeeper</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Arthas.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>Arthas</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Jms.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>JMS</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/ActiveMq.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>ActiveMQ</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Kafka.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>Kafka</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-fc105c82 data-v-6c89610d><div class="VPDoc has-sidebar has-aside" data-v-6c89610d data-v-462c643b><!--[--><!--]--><div class="container" data-v-462c643b><div class="aside" data-v-462c643b><div class="aside-curtain" data-v-462c643b></div><div class="aside-container" data-v-462c643b><div class="aside-content" data-v-462c643b><div class="VPDocAside" data-v-462c643b data-v-eda16060><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-eda16060 data-v-5a905545><div class="content" data-v-5a905545><div class="outline-marker" data-v-5a905545></div><div class="outline-title" data-v-5a905545>目录</div><nav aria-labelledby="doc-outline-aria-label" data-v-5a905545><span class="visually-hidden" id="doc-outline-aria-label" data-v-5a905545> Table of Contents for current page </span><ul class="root" data-v-5a905545 data-v-ce114d19><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-eda16060></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-462c643b><div class="content-container" data-v-462c643b><!--[--><!--]--><!----><main class="main" data-v-462c643b><div style="position:relative;" class="vp-doc _charles-blog_md_middleware_Rabbitmq" data-v-462c643b><div><h1 id="rabbitmq" tabindex="-1">RabbitMQ <span class="VPBadge warning" data-v-b4e454e3><!--[-->持续更新<!--]--></span> <a class="header-anchor" href="#rabbitmq" aria-label="Permalink to &quot;RabbitMQ  &lt;Badge text=&quot;持续更新&quot; type=&quot;warning&quot; /&gt;&quot;">​</a></h1><!----><h2 id="为什么要用mq" tabindex="-1">为什么要用MQ <a class="header-anchor" href="#为什么要用mq" aria-label="Permalink to &quot;为什么要用MQ&quot;">​</a></h2><ol><li>流量消峰</li></ol><ul><li>举个例子，如果订单系统最多能处理一万次订单，这个处理能力应付正常时段的下单时绰绰有余，正常时段我们下单一秒后就能返回结果。但是在高峰期，如果有两万次下单操作系统是处理不了的，只能限制订单超过一万后不允许用户下单。使用消息队列做缓冲，我们可以取消这个限制，把一秒内下的订单分散成一段时间来处理，这时有些用户可能在下单十几秒后才能收到下单成功的操作，但是比不能下单的体验要好。</li></ul><ol start="2"><li>应用解耦</li></ol><ul><li>以电商应用为例，应用中有订单系统、库存系统、物流系统、支付系统。用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障，都会造成下单操作异常。当转变成基于消息队列的方式后，系统间调用的问题会减少很多，比如物流系统因为发生故障，需要几分钟来修复。在这几分钟的时间里，物流系统要处理的内存被缓存在消息队列中，用户的下单操作可以正常完成。当物流系统恢复后，继续处理订单信息即可，中单用户感受不到物流系统的故障，提升系统的可用性。 <img src="/charles-blog/assets/Mq.d4116c8e.png" alt="MQ"></li></ul><ol start="3"><li>异步处理</li></ol><ul><li>有些服务间调用是异步的，例如 A 调用 B，B 需要花费很长时间执行，但是 A 需要知道 B 什么时候可以执行完，以前一般有两种方式，A 过一段时间去调用 B 的查询 api 查询。或者 A 提供一个 callback api，B 执行完之后调用 api 通知 A 服务。这两种方式都不是很优雅，使用消息总线，可以很方便解决这个问题，A 调用 B 服务后，只需要监听 B 处理完成的消息，当 B 处理完成后，会发送一条消息给 MQ，MQ 会将此消息转发给 A 服务。这样 A 服务既不用循环调用 B 的查询 api，也不用提供 callback api。同样B 服务也不用做这些操作。A 服务还能及时的得到异步处理成功的消息。</li></ul><h2 id="rabbitmq-的概念" tabindex="-1">RabbitMQ 的概念 <a class="header-anchor" href="#rabbitmq-的概念" aria-label="Permalink to &quot;RabbitMQ 的概念&quot;">​</a></h2><p>  RabbitMQ 是一个消息中间件：它接受并转发消息。你可以把它当做一个快递站点，当你要发送一个包裹时，你把你的包裹放到快递站，快递员最终会把你的快递送到收件人那里，按照这种逻辑 RabbitMQ 是一个快递站，一个快递员帮你传递快件。RabbitMQ 与快递站的主要区别在于，它不处理快件而是接收，存储和转发消息数据。</p><h3 id="四大核心概念" tabindex="-1">四大核心概念 <a class="header-anchor" href="#四大核心概念" aria-label="Permalink to &quot;四大核心概念&quot;">​</a></h3><h4 id="生产者" tabindex="-1">生产者 <a class="header-anchor" href="#生产者" aria-label="Permalink to &quot;生产者&quot;">​</a></h4><p>  产生数据发送消息的程序是生产者</p><h4 id="交换机" tabindex="-1">交换机 <a class="header-anchor" href="#交换机" aria-label="Permalink to &quot;交换机&quot;">​</a></h4><p>  交换机是 RabbitMQ 非常重要的一个部件，一方面它接收来自生产者的消息，另一方面它将消息推送到队列中。交换机必须确切知道如何处理它接收到的消息，是将这些消息推送到特定队列还是推送到多个队列，亦或者是把消息丢弃，这个得有交换机类型决定</p><h4 id="队列" tabindex="-1">队列 <a class="header-anchor" href="#队列" aria-label="Permalink to &quot;队列&quot;">​</a></h4><p>  队列是 RabbitMQ 内部使用的一种数据结构，尽管消息流经 RabbitMQ 和应用程序，但它们只能存储在队列中。队列仅受主机的内存和磁盘限制的约束，本质上是一个大的消息缓冲区。许多生产者可以将消息发送到一个队列，许多消费者可以尝试从一个队列接收数据。这就是我们使用队列的方式</p><h4 id="消费者" tabindex="-1">消费者 <a class="header-anchor" href="#消费者" aria-label="Permalink to &quot;消费者&quot;">​</a></h4><p>  消费与接收具有相似的含义。消费者大多时候是一个等待接收消息的程序。请注意生产者，消费者和消息中间件很多时候并不在同一机器上。同一个应用程序既可以是生产者又是可以是消费者。 <img src="/charles-blog/assets/WorkingPrinciple.65c39cfa.png" alt="WorkingPrinciple"></p><h2 id="常用命令" tabindex="-1">常用命令 <a class="header-anchor" href="#常用命令" aria-label="Permalink to &quot;常用命令&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;"># 添加开机启动 RabbitMQ 服务</span></span>
<span class="line"><span style="color:#F69D50;">chkconfig</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">rabbitmq-server</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">on</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;"># 启动服务</span></span>
<span class="line"><span style="color:#F69D50;">/sbin/service</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">rabbitmq-server</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">start</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#768390;"># 查看服务状态</span></span>
<span class="line"><span style="color:#F69D50;">/sbin/service</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">rabbitmq-server</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">status</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;"># 停止服务</span></span>
<span class="line"><span style="color:#F69D50;">/sbin/service</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">rabbitmq-server</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">stop</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;"># 开启 web 管理插件</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmq-plugins</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">enable</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">rabbitmq_management</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">#### 页面访问地址的端口： 15672 ####</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 添加开机启动 RabbitMQ 服务</span></span>
<span class="line"><span style="color:#6F42C1;">chkconfig</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbitmq-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 启动服务</span></span>
<span class="line"><span style="color:#6F42C1;">/sbin/service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbitmq-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;"># 查看服务状态</span></span>
<span class="line"><span style="color:#6F42C1;">/sbin/service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbitmq-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 停止服务</span></span>
<span class="line"><span style="color:#6F42C1;">/sbin/service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbitmq-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 开启 web 管理插件</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmq-plugins</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbitmq_management</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#### 页面访问地址的端口： 15672 ####</span></span></code></pre></div><h2 id="java实现" tabindex="-1">Java实现 <a class="header-anchor" href="#java实现" aria-label="Permalink to &quot;Java实现&quot;">​</a></h2><h3 id="生产者-原生写法" tabindex="-1">生产者，原生写法 <a class="header-anchor" href="#生产者-原生写法" aria-label="Permalink to &quot;生产者，原生写法&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Producer</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">QUEUE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;hello&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">args</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//创建一个连接工厂</span></span>
<span class="line"><span style="color:#ADBAC7;">        ConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">factory</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">ConnectionFactory</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setHost</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;182.92.234.71&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setUsername</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;admin&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setPassword</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;123&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//channel 实现了自动 close 接口 自动关闭 不需要显示关闭</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> ( Connection</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connection</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> factory.</span><span style="color:#DCBDFB;">newConnection</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">            Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connection.</span><span style="color:#DCBDFB;">createChannel</span><span style="color:#ADBAC7;">() ) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">            * 生成一个队列</span></span>
<span class="line"><span style="color:#768390;">            * 1.队列名称</span></span>
<span class="line"><span style="color:#768390;">            * 2.队列里面的消息是否持久化 默认消息存储在内存中</span></span>
<span class="line"><span style="color:#768390;">            * 3.该队列是否只供一个消费者进行消费 是否进行共享 true 可以多个消费者消费</span></span>
<span class="line"><span style="color:#768390;">            * 4.是否自动删除 最后一个消费者端开连接以后 该队列是否自动删除 true 自动删除</span></span>
<span class="line"><span style="color:#768390;">            * 5.其他参数</span></span>
<span class="line"><span style="color:#768390;">            */</span></span>
<span class="line"><span style="color:#ADBAC7;">            channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(QUEUE_NAME,</span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">           </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;hello world&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">            * 发送一个消息</span></span>
<span class="line"><span style="color:#768390;">            * 1.发送到那个交换机</span></span>
<span class="line"><span style="color:#768390;">            * 2.路由的 key 是哪个</span></span>
<span class="line"><span style="color:#768390;">            * 3.其他的参数信息</span></span>
<span class="line"><span style="color:#768390;">            * 4.发送消息的消息体</span></span>
<span class="line"><span style="color:#768390;">            */</span></span>
<span class="line"><span style="color:#ADBAC7;">            channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">,QUEUE_NAME,</span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">,message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息发送完毕&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Producer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> String QUEUE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;hello&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//创建一个连接工厂</span></span>
<span class="line"><span style="color:#24292E;">        ConnectionFactory factory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConnectionFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setHost</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;182.92.234.71&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setUsername</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;admin&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setPassword</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;123&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//channel 实现了自动 close 接口 自动关闭 不需要显示关闭</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> ( Connection connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> factory.</span><span style="color:#6F42C1;">newConnection</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connection.</span><span style="color:#6F42C1;">createChannel</span><span style="color:#24292E;">() ) {</span></span>
<span class="line"><span style="color:#24292E;">            </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">            * 生成一个队列</span></span>
<span class="line"><span style="color:#6A737D;">            * 1.队列名称</span></span>
<span class="line"><span style="color:#6A737D;">            * 2.队列里面的消息是否持久化 默认消息存储在内存中</span></span>
<span class="line"><span style="color:#6A737D;">            * 3.该队列是否只供一个消费者进行消费 是否进行共享 true 可以多个消费者消费</span></span>
<span class="line"><span style="color:#6A737D;">            * 4.是否自动删除 最后一个消费者端开连接以后 该队列是否自动删除 true 自动删除</span></span>
<span class="line"><span style="color:#6A737D;">            * 5.其他参数</span></span>
<span class="line"><span style="color:#6A737D;">            */</span></span>
<span class="line"><span style="color:#24292E;">            channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(QUEUE_NAME,</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">           </span></span>
<span class="line"><span style="color:#24292E;">            String message</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;hello world&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">            * 发送一个消息</span></span>
<span class="line"><span style="color:#6A737D;">            * 1.发送到那个交换机</span></span>
<span class="line"><span style="color:#6A737D;">            * 2.路由的 key 是哪个</span></span>
<span class="line"><span style="color:#6A737D;">            * 3.其他的参数信息</span></span>
<span class="line"><span style="color:#6A737D;">            * 4.发送消息的消息体</span></span>
<span class="line"><span style="color:#6A737D;">            */</span></span>
<span class="line"><span style="color:#24292E;">            channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">,QUEUE_NAME,</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">,message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息发送完毕&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="消费者-原生写法" tabindex="-1">消费者，原生写法 <a class="header-anchor" href="#消费者-原生写法" aria-label="Permalink to &quot;消费者，原生写法&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Consumer</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">QUEUE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;hello&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">args</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception { </span></span>
<span class="line"><span style="color:#ADBAC7;">        ConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">factory</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">ConnectionFactory</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setHost</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;182.92.234.71&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setUsername</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;admin&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setPassword</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;123&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        Connection</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connection</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> factory.</span><span style="color:#DCBDFB;">newConnection</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connection.</span><span style="color:#DCBDFB;">createChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;等待接收消息 ......... &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//推送的消息如何进行消费的接口回调</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag,delivery)</span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;">{ </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(message);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//取消消费的一个回调接口 如在消费的时候队列被删除掉了</span></span>
<span class="line"><span style="color:#ADBAC7;">        CancelCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">cancelCallback</span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag)</span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;">{ </span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息消费被中断&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">        * 消费者消费消息</span></span>
<span class="line"><span style="color:#768390;">        * 1.消费哪个队列</span></span>
<span class="line"><span style="color:#768390;">        * 2.消费成功之后是否要自动应答 true 代表自动应答 false 手动应答</span></span>
<span class="line"><span style="color:#768390;">        * 3.消费者未成功消费的回调</span></span>
<span class="line"><span style="color:#768390;">        */</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(QUEUE_NAME,</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">,deliverCallback,cancelCallback);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Consumer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> String QUEUE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;hello&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception { </span></span>
<span class="line"><span style="color:#24292E;">        ConnectionFactory factory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConnectionFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setHost</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;182.92.234.71&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setUsername</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;admin&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setPassword</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;123&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        Connection connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> factory.</span><span style="color:#6F42C1;">newConnection</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connection.</span><span style="color:#6F42C1;">createChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;等待接收消息 ......... &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//推送的消息如何进行消费的接口回调</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag,delivery)</span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">{ </span></span>
<span class="line"><span style="color:#24292E;">            String message</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(message);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//取消消费的一个回调接口 如在消费的时候队列被删除掉了</span></span>
<span class="line"><span style="color:#24292E;">        CancelCallback cancelCallback</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag)</span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">{ </span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息消费被中断&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">        * 消费者消费消息</span></span>
<span class="line"><span style="color:#6A737D;">        * 1.消费哪个队列</span></span>
<span class="line"><span style="color:#6A737D;">        * 2.消费成功之后是否要自动应答 true 代表自动应答 false 手动应答</span></span>
<span class="line"><span style="color:#6A737D;">        * 3.消费者未成功消费的回调</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(QUEUE_NAME,</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,deliverCallback,cancelCallback);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="消息应答" tabindex="-1">消息应答 <a class="header-anchor" href="#消息应答" aria-label="Permalink to &quot;消息应答&quot;">​</a></h3><ul><li>为了保证消息在发送过程中不丢失，rabbitmq引入消息应答机制，消息应答就是消费者在接收到消息并且处理该消息之后，告诉 rabbitmq 它已经处理了，rabbitmq 可以把该消息删除了。</li><li>如果消费者由于某些原因失去连接(其通道已关闭，连接已关闭或 TCP 连接丢失)，导致消息未发送 ACK 确认，RabbitMQ 将了解到消息未完全处理，并将对其重新排队。如果此时其他消费者可以处理，它将很快将其重新分发给另一个消费者。这样，即使某个消费者偶尔死亡，也可以确保不会丢失任何消息。</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 消费者代码调整，生产者代码不用调整</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Work03</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">ACK_QUEUE_NAME</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;ack_queue&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">args</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception{</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitMqUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//消息消费的时候如何处理消息</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag,delivery)</span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;">{ </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;接收到消息:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">            * 1.消息标记 tag</span></span>
<span class="line"><span style="color:#768390;">            * 2.是否批量应答未应答消息</span></span>
<span class="line"><span style="color:#768390;">            */</span></span>
<span class="line"><span style="color:#ADBAC7;">            channel.</span><span style="color:#DCBDFB;">basicAck</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getEnvelope</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">getDeliveryTag</span><span style="color:#ADBAC7;">(),</span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">// Channel.basicAck(用于肯定确认) RabbitMQ 已知道该消息并且成功的处理消息，可以将其丢弃了</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">// Channel.basicNack(用于否定确认)</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">// Channel.basicReject(用于否定确认) 与 Channel.basicNack 相比少一个参数；不处理该消息了直接拒绝，可以将其丢弃了</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//采用手动应答</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">boolean</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">autoAck</span><span style="color:#F47067;">=</span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(ACK_QUEUE_NAME,autoAck,deliverCallback,</span></span>
<span class="line"><span style="color:#ADBAC7;">                            (consumerTag)</span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;">{System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(consumerTag</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot;消费者取消消费接口回调逻辑&quot;</span><span style="color:#ADBAC7;">);});</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 消费者代码调整，生产者代码不用调整</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Work03</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String ACK_QUEUE_NAME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;ack_queue&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception{</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitMqUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//消息消费的时候如何处理消息</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag,delivery)</span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">{ </span></span>
<span class="line"><span style="color:#24292E;">            String message</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;接收到消息:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">            </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">            * 1.消息标记 tag</span></span>
<span class="line"><span style="color:#6A737D;">            * 2.是否批量应答未应答消息</span></span>
<span class="line"><span style="color:#6A737D;">            */</span></span>
<span class="line"><span style="color:#24292E;">            channel.</span><span style="color:#6F42C1;">basicAck</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getEnvelope</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getDeliveryTag</span><span style="color:#24292E;">(),</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// Channel.basicAck(用于肯定确认) RabbitMQ 已知道该消息并且成功的处理消息，可以将其丢弃了</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// Channel.basicNack(用于否定确认)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// Channel.basicReject(用于否定确认) 与 Channel.basicNack 相比少一个参数；不处理该消息了直接拒绝，可以将其丢弃了</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//采用手动应答</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> autoAck</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(ACK_QUEUE_NAME,autoAck,deliverCallback,</span></span>
<span class="line"><span style="color:#24292E;">                            (consumerTag)</span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">{System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(consumerTag</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot;消费者取消消费接口回调逻辑&quot;</span><span style="color:#24292E;">);});</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="持久化" tabindex="-1">持久化 <a class="header-anchor" href="#持久化" aria-label="Permalink to &quot;持久化&quot;">​</a></h3><ul><li>确保消息不会丢失需要做两件事：我们需要将队列和消息都标记为持久化。</li><li>将消息标记为持久化并不能完全保证不会丢失消息。尽管它告诉 RabbitMQ 将消息保存到磁盘，但是这里依然存在当消息刚准备存储在磁盘的时候但是还没有存储完，消息还在缓存的一个间隔点。此时并没有真正写入磁盘。持久性保证并不强，但是对于我们的简单任务队列而言，这已经绰绰有余了。</li></ul><h4 id="队列持久化" tabindex="-1">队列持久化 <a class="header-anchor" href="#队列持久化" aria-label="Permalink to &quot;队列持久化&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 在声明队列的时候把 durable 参数设置为持久化</span></span>
<span class="line"><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">* 生成一个队列</span></span>
<span class="line"><span style="color:#768390;">* 1.队列名称</span></span>
<span class="line"><span style="color:#768390;">* 2.队列里面的消息是否持久化 默认消息存储在内存中</span></span>
<span class="line"><span style="color:#768390;">* 3.该队列是否只供一个消费者进行消费 是否进行共享 true 可以多个消费者消费</span></span>
<span class="line"><span style="color:#768390;">* 4.是否自动删除 最后一个消费者端开连接以后 该队列是否自动删除 true 自动删除</span></span>
<span class="line"><span style="color:#768390;">* 5.其他参数</span></span>
<span class="line"><span style="color:#768390;">*/</span></span>
<span class="line"><span style="color:#ADBAC7;">channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(QUEUE_NAME,</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 在声明队列的时候把 durable 参数设置为持久化</span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* 生成一个队列</span></span>
<span class="line"><span style="color:#6A737D;">* 1.队列名称</span></span>
<span class="line"><span style="color:#6A737D;">* 2.队列里面的消息是否持久化 默认消息存储在内存中</span></span>
<span class="line"><span style="color:#6A737D;">* 3.该队列是否只供一个消费者进行消费 是否进行共享 true 可以多个消费者消费</span></span>
<span class="line"><span style="color:#6A737D;">* 4.是否自动删除 最后一个消费者端开连接以后 该队列是否自动删除 true 自动删除</span></span>
<span class="line"><span style="color:#6A737D;">* 5.其他参数</span></span>
<span class="line"><span style="color:#6A737D;">*/</span></span>
<span class="line"><span style="color:#24292E;">channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(QUEUE_NAME,</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span></code></pre></div><h4 id="消息持久化" tabindex="-1">消息持久化 <a class="header-anchor" href="#消息持久化" aria-label="Permalink to &quot;消息持久化&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 添加属性 MessageProperties.PERSISTENT_TEXT_PLAIN </span></span>
<span class="line"><span style="color:#ADBAC7;">String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;hello world&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">* 发送一个消息</span></span>
<span class="line"><span style="color:#768390;">* 1.发送到那个交换机</span></span>
<span class="line"><span style="color:#768390;">* 2.路由的 key 是哪个</span></span>
<span class="line"><span style="color:#768390;">* 3.其他的参数信息</span></span>
<span class="line"><span style="color:#768390;">* 4.发送消息的消息体</span></span>
<span class="line"><span style="color:#768390;">*/</span></span>
<span class="line"><span style="color:#ADBAC7;">channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">,QUEUE_NAME,MessageProperties.PERSISTENT_TEXT_PLAIN,message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">());</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 添加属性 MessageProperties.PERSISTENT_TEXT_PLAIN </span></span>
<span class="line"><span style="color:#24292E;">String message</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;hello world&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* 发送一个消息</span></span>
<span class="line"><span style="color:#6A737D;">* 1.发送到那个交换机</span></span>
<span class="line"><span style="color:#6A737D;">* 2.路由的 key 是哪个</span></span>
<span class="line"><span style="color:#6A737D;">* 3.其他的参数信息</span></span>
<span class="line"><span style="color:#6A737D;">* 4.发送消息的消息体</span></span>
<span class="line"><span style="color:#6A737D;">*/</span></span>
<span class="line"><span style="color:#24292E;">channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">,QUEUE_NAME,MessageProperties.PERSISTENT_TEXT_PLAIN,message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span></code></pre></div><h3 id="发布确认" tabindex="-1">发布确认 <a class="header-anchor" href="#发布确认" aria-label="Permalink to &quot;发布确认&quot;">​</a></h3><p>  生产者将信道设置成 confirm 模式，一旦信道进入 confirm 模式，所有在该信道上面发布的消息都将会被指派一个唯一的 ID(从 1 开始)，一旦消息被投递到所有匹配的队列之后，broker 就会发送一个确认给生产者(包含消息的唯一 ID)，这就使得生产者知道消息已经正确到达目的队列了，如果消息和队列是可持久化的，那么确认消息会在将消息写入磁盘之后发出，broker 回传给生产者的确认消息中 delivery-tag 域包含了确认消息的序列号，此外 broker 也可以设置basic.ack 的multiple 域，表示到这个序列号之前的所有消息都已经得到了处理。</p><p>  发布确认默认是没有开启的，如果要开启需要调用方法 confirmSelect，每当你要想使用发布确认，都需要在 channel 上调用该方法。</p><h4 id="_1、单个发布确认" tabindex="-1">1、单个发布确认 <a class="header-anchor" href="#_1、单个发布确认" aria-label="Permalink to &quot;1、单个发布确认&quot;">​</a></h4><p>  一种简单的确认方式，它是一种同步确认发布的方式，也就是发布一个消息之后只有它被确认发布，后续的消息才能继续发布,waitForConfirmsOrDie(long)这个方法只有在消息被确认的时候才返回，如果在指定时间范围内这个消息没有被确认那么它将抛出异常。这种确认方式有一个最大的缺点就是:发布速度特别的慢，因为如果没有确认发布的消息就会阻塞所有后续消息的发布，这种方式最多提供每秒不超过数百条发布消息的吞吐量。当然对于某些应用程序来说这可能已经足够了。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 单个发布确认</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">publishMessageIndividually</span><span style="color:#ADBAC7;">() throws Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> (Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitMqUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">()) { </span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queueName</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> UUID.</span><span style="color:#DCBDFB;">randomUUID</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">toString</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//开启发布确认</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">confirmSelect</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">long</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">begin</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> System.</span><span style="color:#DCBDFB;">currentTimeMillis</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;"> (</span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">; i </span><span style="color:#F47067;">&lt;</span><span style="color:#ADBAC7;"> MESSAGE_COUNT; i</span><span style="color:#F47067;">++</span><span style="color:#ADBAC7;">) { </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> i </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">            channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">, queueName, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">, message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//服务端返回 false 或超时时间内未返回，生产者可以消息重发</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">boolean</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">flag</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> channel.</span><span style="color:#DCBDFB;">waitForConfirms</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;">(flag){</span></span>
<span class="line"><span style="color:#ADBAC7;">                System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息发送成功&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">long</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">end</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> System.</span><span style="color:#DCBDFB;">currentTimeMillis</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;发布&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> MESSAGE_COUNT </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;个单独确认消息,耗时&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> (end </span><span style="color:#F47067;">-</span><span style="color:#ADBAC7;"> begin) </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">  </span><span style="color:#96D0FF;">&quot;ms&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 单个发布确认</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">publishMessageIndividually</span><span style="color:#24292E;">() throws Exception {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> (Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitMqUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">()) { </span></span>
<span class="line"><span style="color:#24292E;">        String queueName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> UUID.</span><span style="color:#6F42C1;">randomUUID</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">toString</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//开启发布确认</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">confirmSelect</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> begin </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> System.</span><span style="color:#6F42C1;">currentTimeMillis</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> MESSAGE_COUNT; i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) { </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">, queueName, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//服务端返回 false 或超时时间内未返回，生产者可以消息重发</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> flag </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> channel.</span><span style="color:#6F42C1;">waitForConfirms</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(flag){</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息发送成功&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> end </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> System.</span><span style="color:#6F42C1;">currentTimeMillis</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;发布&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> MESSAGE_COUNT </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;个单独确认消息,耗时&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> (end </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> begin) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;ms&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="_2、批量确认发布" tabindex="-1">2、批量确认发布 <a class="header-anchor" href="#_2、批量确认发布" aria-label="Permalink to &quot;2、批量确认发布&quot;">​</a></h4><p>  与单个等待确认消息相比，先发布一批消息然后一起确认可以极大地提高吞吐量，当然这种方式的缺点就是:当发生故障导致发布出现问题时，不知道是哪个消息出现问题了，我们必须将整个批处理保存在内存中，以记录重要的信息而后重新发布消息。当然这种方案仍然是同步的，也一样阻塞消息的发布。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#F69D50;">//</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">批量确认同步</span></span>
<span class="line"><span style="color:#F69D50;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">publishMessageBatch</span><span style="color:#ADBAC7;">() </span><span style="color:#96D0FF;">throws</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">Exception</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">{</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F69D50;">try</span><span style="color:#ADBAC7;"> (Channel </span><span style="color:#96D0FF;">channel</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">RabbitMqUtils.getChannel</span><span style="color:#ADBAC7;">()){ </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F69D50;">String</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">queueName</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">UUID.randomUUID</span><span style="color:#ADBAC7;">()</span><span style="color:#96D0FF;">.toString</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F69D50;">channel.queueDeclare(queueName,</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">false</span><span style="color:#96D0FF;">,</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">false</span><span style="color:#96D0FF;">,</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">false</span><span style="color:#96D0FF;">,</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F69D50;">//开启发布确认</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#DCBDFB;">channel.confirmSelect</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F69D50;">//批量确认消息大小</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F69D50;">int</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">batchSize</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">100</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F69D50;">//未确认消息个数</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F69D50;">int</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">outstandingMessageCount</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F69D50;">long</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">begin</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">System.currentTimeMillis</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;"> (</span><span style="color:#F69D50;">int</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">i</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">; </span><span style="color:#F69D50;">i</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">&lt;</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">MESSAGE_COUNT</span><span style="color:#ADBAC7;">; </span><span style="color:#F69D50;">i++</span><span style="color:#ADBAC7;">){ </span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F69D50;">String</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">message</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">i</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F69D50;">channel.basicPublish(</span><span style="color:#F69D50;">&quot;&quot;</span><span style="color:#F69D50;">,</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">queueName,</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">null,</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">message.getBytes</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F69D50;">outstandingMessageCount++</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;"> (</span><span style="color:#F69D50;">outstandingMessageCount</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">==</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">batchSize</span><span style="color:#ADBAC7;">) { </span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#DCBDFB;">channel.waitForConfirms</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#F69D50;">outstandingMessageCount</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F69D50;">//为了确保还有剩余没有确认消息</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">再次确认</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;"> (</span><span style="color:#F69D50;">outstandingMessageCount</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">&gt;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">){ </span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#DCBDFB;">channel.waitForConfirms</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F69D50;">long</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">end</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">System.currentTimeMillis</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F69D50;">System.out.println(</span><span style="color:#F69D50;">&quot;发布&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">MESSAGE_COUNT</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;个批量确认消息,耗时&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">+</span><span style="color:#ADBAC7;"> (end </span><span style="color:#96D0FF;">-</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">begin</span><span style="color:#ADBAC7;">)  </span><span style="color:#96D0FF;">&quot;ms&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">//</span><span style="color:#24292E;"> </span><span style="color:#032F62;">批量确认同步</span></span>
<span class="line"><span style="color:#6F42C1;">public</span><span style="color:#24292E;"> </span><span style="color:#032F62;">static</span><span style="color:#24292E;"> </span><span style="color:#032F62;">void</span><span style="color:#24292E;"> </span><span style="color:#032F62;">publishMessageBatch</span><span style="color:#24292E;">() </span><span style="color:#032F62;">throws</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Exception</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">try</span><span style="color:#24292E;"> (Channel </span><span style="color:#032F62;">channel</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">RabbitMqUtils.getChannel</span><span style="color:#24292E;">()){ </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;"> </span><span style="color:#032F62;">queueName</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UUID.randomUUID</span><span style="color:#24292E;">()</span><span style="color:#032F62;">.toString</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">channel.queueDeclare(queueName,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">//开启发布确认</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">channel.confirmSelect</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">//批量确认消息大小</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">int</span><span style="color:#24292E;"> </span><span style="color:#032F62;">batchSize</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">//未确认消息个数</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">int</span><span style="color:#24292E;"> </span><span style="color:#032F62;">outstandingMessageCount</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">long</span><span style="color:#24292E;"> </span><span style="color:#032F62;">begin</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">System.currentTimeMillis</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">int</span><span style="color:#24292E;"> </span><span style="color:#032F62;">i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">i</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MESSAGE_COUNT</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">i++</span><span style="color:#24292E;">){ </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;"> </span><span style="color:#032F62;">message</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">channel.basicPublish(</span><span style="color:#6F42C1;">&quot;&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">queueName,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">null,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">message.getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">outstandingMessageCount++</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">outstandingMessageCount</span><span style="color:#24292E;"> </span><span style="color:#032F62;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">batchSize</span><span style="color:#24292E;">) { </span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">channel.waitForConfirms</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">outstandingMessageCount</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">//为了确保还有剩余没有确认消息</span><span style="color:#24292E;"> </span><span style="color:#032F62;">再次确认</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">outstandingMessageCount</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">){ </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">channel.waitForConfirms</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">long</span><span style="color:#24292E;"> </span><span style="color:#032F62;">end</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">System.currentTimeMillis</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">System.out.println(</span><span style="color:#6F42C1;">&quot;发布&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MESSAGE_COUNT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;个批量确认消息,耗时&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+</span><span style="color:#24292E;"> (end </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">begin</span><span style="color:#24292E;">)  </span><span style="color:#032F62;">&quot;ms&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="_3、异步确认发布" tabindex="-1">3、异步确认发布 <a class="header-anchor" href="#_3、异步确认发布" aria-label="Permalink to &quot;3、异步确认发布&quot;">​</a></h4><p><img src="/charles-blog/assets/AsynConfirm.44ba19a6.png" alt="AsynConfirm"></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">publishMessageAsync</span><span style="color:#ADBAC7;">() throws Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> (Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitMqUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">()){ </span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queueName</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> UUID.</span><span style="color:#DCBDFB;">randomUUID</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">toString</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//开启发布确认</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">confirmSelect</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">        * 线程安全有序的一个哈希表，适用于高并发的情况</span></span>
<span class="line"><span style="color:#768390;">        * 1.轻松的将序号与消息进行关联</span></span>
<span class="line"><span style="color:#768390;">        * 2.轻松批量删除条目 只要给到序列号</span></span>
<span class="line"><span style="color:#768390;">        * 3.支持并发访问</span></span>
<span class="line"><span style="color:#768390;">        */</span></span>
<span class="line"><span style="color:#ADBAC7;">        ConcurrentSkipListMap</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">Long</span><span style="color:#F69D50;">,</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">outstandingConfirms</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> ConcurrentSkipListMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">        * 确认收到消息的一个回调</span></span>
<span class="line"><span style="color:#768390;">        * 1.消息序列号</span></span>
<span class="line"><span style="color:#768390;">        * 2.true 可以确认小于等于当前序列号的消息</span></span>
<span class="line"><span style="color:#768390;">        *   false 确认当前序列号消息</span></span>
<span class="line"><span style="color:#768390;">        */</span></span>
<span class="line"><span style="color:#ADBAC7;">        ConfirmCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">ackCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (sequenceNumber, multiple) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;"> (multiple) {</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#768390;">//返回的是小于等于当前序列号的未确认消息 是一个 map</span></span>
<span class="line"><span style="color:#ADBAC7;">                ConcurrentNavigableMap</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">Long</span><span style="color:#F69D50;">,</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">confirmed</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> outstandingConfirms.</span><span style="color:#DCBDFB;">headMap</span><span style="color:#ADBAC7;">(sequenceNumber, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#768390;">//清除该部分未确认消息</span></span>
<span class="line"><span style="color:#ADBAC7;">                confirmed.</span><span style="color:#DCBDFB;">clear</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span><span style="color:#F47067;">else</span><span style="color:#ADBAC7;">{</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#768390;">//只清除当前序列号的消息</span></span>
<span class="line"><span style="color:#ADBAC7;">                outstandingConfirms.</span><span style="color:#DCBDFB;">remove</span><span style="color:#ADBAC7;">(sequenceNumber);</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        ConfirmCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">nackCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (sequenceNumber, multiple) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> { </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> outstandingConfirms.</span><span style="color:#DCBDFB;">get</span><span style="color:#ADBAC7;">(sequenceNumber);</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;发布的消息&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot;未被确认，序列号&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">sequenceNumber);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">        * 添加一个异步确认的监听器</span></span>
<span class="line"><span style="color:#768390;">        * 1.确认收到消息的回调</span></span>
<span class="line"><span style="color:#768390;">        * 2.未收到消息的回调</span></span>
<span class="line"><span style="color:#768390;">        */</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">addConfirmListener</span><span style="color:#ADBAC7;">(ackCallback, nackCallback);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">long</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">begin</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> System.</span><span style="color:#DCBDFB;">currentTimeMillis</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;"> (</span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">; i </span><span style="color:#F47067;">&lt;</span><span style="color:#ADBAC7;"> MESSAGE_COUNT; i</span><span style="color:#F47067;">++</span><span style="color:#ADBAC7;">){ </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;消息&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> i;</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">            * channel.getNextPublishSeqNo()获取下一个消息的序列号</span></span>
<span class="line"><span style="color:#768390;">            * 通过序列号与消息体进行一个关联</span></span>
<span class="line"><span style="color:#768390;">            * 全部都是未确认的消息体</span></span>
<span class="line"><span style="color:#768390;">            */</span></span>
<span class="line"><span style="color:#ADBAC7;">            outstandingConfirms.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(channel.</span><span style="color:#DCBDFB;">getNextPublishSeqNo</span><span style="color:#ADBAC7;">(), message);</span></span>
<span class="line"><span style="color:#ADBAC7;">            channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">, queueName, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">, message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">long</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">end</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> System.</span><span style="color:#DCBDFB;">currentTimeMillis</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;发布&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> MESSAGE_COUNT </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;个异步确认消息,耗时&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> (end </span><span style="color:#F47067;">-</span><span style="color:#ADBAC7;"> begin) </span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot;ms&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">publishMessageAsync</span><span style="color:#24292E;">() throws Exception {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> (Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitMqUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">()){ </span></span>
<span class="line"><span style="color:#24292E;">        String queueName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> UUID.</span><span style="color:#6F42C1;">randomUUID</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">toString</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//开启发布确认</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">confirmSelect</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">        * 线程安全有序的一个哈希表，适用于高并发的情况</span></span>
<span class="line"><span style="color:#6A737D;">        * 1.轻松的将序号与消息进行关联</span></span>
<span class="line"><span style="color:#6A737D;">        * 2.轻松批量删除条目 只要给到序列号</span></span>
<span class="line"><span style="color:#6A737D;">        * 3.支持并发访问</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#24292E;">        ConcurrentSkipListMap&lt;</span><span style="color:#D73A49;">Long</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; outstandingConfirms </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ConcurrentSkipListMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">        * 确认收到消息的一个回调</span></span>
<span class="line"><span style="color:#6A737D;">        * 1.消息序列号</span></span>
<span class="line"><span style="color:#6A737D;">        * 2.true 可以确认小于等于当前序列号的消息</span></span>
<span class="line"><span style="color:#6A737D;">        *   false 确认当前序列号消息</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#24292E;">        ConfirmCallback ackCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (sequenceNumber, multiple) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (multiple) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">//返回的是小于等于当前序列号的未确认消息 是一个 map</span></span>
<span class="line"><span style="color:#24292E;">                ConcurrentNavigableMap&lt;</span><span style="color:#D73A49;">Long</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; confirmed </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> outstandingConfirms.</span><span style="color:#6F42C1;">headMap</span><span style="color:#24292E;">(sequenceNumber, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">//清除该部分未确认消息</span></span>
<span class="line"><span style="color:#24292E;">                confirmed.</span><span style="color:#6F42C1;">clear</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            }</span><span style="color:#D73A49;">else</span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">//只清除当前序列号的消息</span></span>
<span class="line"><span style="color:#24292E;">                outstandingConfirms.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(sequenceNumber);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        ConfirmCallback nackCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (sequenceNumber, multiple) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> outstandingConfirms.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(sequenceNumber);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;发布的消息&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot;未被确认，序列号&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">sequenceNumber);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">        * 添加一个异步确认的监听器</span></span>
<span class="line"><span style="color:#6A737D;">        * 1.确认收到消息的回调</span></span>
<span class="line"><span style="color:#6A737D;">        * 2.未收到消息的回调</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">addConfirmListener</span><span style="color:#24292E;">(ackCallback, nackCallback);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> begin </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> System.</span><span style="color:#6F42C1;">currentTimeMillis</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> MESSAGE_COUNT; i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">){ </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;消息&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> i;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">            * channel.getNextPublishSeqNo()获取下一个消息的序列号</span></span>
<span class="line"><span style="color:#6A737D;">            * 通过序列号与消息体进行一个关联</span></span>
<span class="line"><span style="color:#6A737D;">            * 全部都是未确认的消息体</span></span>
<span class="line"><span style="color:#6A737D;">            */</span></span>
<span class="line"><span style="color:#24292E;">            outstandingConfirms.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(channel.</span><span style="color:#6F42C1;">getNextPublishSeqNo</span><span style="color:#24292E;">(), message);</span></span>
<span class="line"><span style="color:#24292E;">            channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">, queueName, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> end </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> System.</span><span style="color:#6F42C1;">currentTimeMillis</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;发布&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> MESSAGE_COUNT </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;个异步确认消息,耗时&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> (end </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> begin) </span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot;ms&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="预取值-channel-basicqos" tabindex="-1">预取值 （channel.basicQos） <a class="header-anchor" href="#预取值-channel-basicqos" aria-label="Permalink to &quot;预取值 （channel.basicQos）&quot;">​</a></h2><ul><li>本身消息的发送就是异步发送的，所以在任何时候，channel 上肯定不止只有一个消息；另外来自消费者的手动确认本质上也是异步的。因此这里就存在一个未确认的消息缓冲区，因此希望开发人员能限制此缓冲区的大小，以避免缓冲区里面无限制的未确认消息问题。这个时候就可以通过使用 basic.qos 方法设置“预取计数”值来完成的。该值定义通道上允许的未确认消息的最大数量。一旦数量达到配置的数量，RabbitMQ 将停止在通道上传递更多消息，除非至少有一个未处理的消息被确认。</li><li>消息应答和 QoS 预取值对用户吞吐量有重大影响。通常，增加预取将提高向消费者传递消息的速度。虽然自动应答传输消息速率是最佳的，但是，在这种情况下已传递但尚未处理的消息的数量也会增加，从而增加了消费者的 RAM 消耗(随机存取存储器)应该小心使用具有无限预处理的自动确认模式或手动确认模式，消费者消费了大量的消息如果没有确认的话，会导致消费者连接节点的内存消耗变大，所以找到合适的预取值是一个反复试验的过程。</li></ul><h2 id="交换机-exchanges" tabindex="-1">交换机（Exchanges） <a class="header-anchor" href="#交换机-exchanges" aria-label="Permalink to &quot;交换机（Exchanges）&quot;">​</a></h2><p>  RabbitMQ 消息传递模型的核心思想是: 生产者生产的消息从不会直接发送到队列。实际上，通常生产者甚至都不知道这些消息传递传递到了哪些队列中。</p><p>  相反，生产者只能将消息发送到交换机(exchange)，交换机工作的内容非常简单，一方面它接收来自生产者的消息，另一方面将它们推入队列。交换机必须确切知道如何处理收到的消息。是应该把这些消息放到特定队列还是说把他们到许多队列中还是说应该丢弃它们。这就的由交换机的类型来决定。 <img src="/charles-blog/assets/Exchanges.49e3eeeb.png" alt="Exchanges"></p><h3 id="临时队列" tabindex="-1">临时队列 <a class="header-anchor" href="#临时队列" aria-label="Permalink to &quot;临时队列&quot;">​</a></h3><p>  每当我们连接到 Rabbit 时，我们都需要一个全新的空队列，为此我们可以创建一个具有随机名称的队列，或者能让服务器为我们选择一个随机队列名称那就更好了。其次一旦我们断开了消费者的连接，队列将被自动删除。 <img src="/charles-blog/assets/TempQueue.242a245c.png" alt="TempQueue"></p><h3 id="绑定-bindings" tabindex="-1">绑定(bindings) <a class="header-anchor" href="#绑定-bindings" aria-label="Permalink to &quot;绑定(bindings)&quot;">​</a></h3><p>  binding 其实是 交换机 和 队列 之间的桥梁，它告诉我们 exchange 和那个队列进行了绑定关系。比如说下面这张图告诉我们的就是 X 与 Q1 和 Q2 进行了绑定 <img src="/charles-blog/assets/Binding.27b33c0f.png" alt="Binding"></p><h3 id="交换机类型" tabindex="-1">交换机类型 <a class="header-anchor" href="#交换机类型" aria-label="Permalink to &quot;交换机类型&quot;">​</a></h3><h4 id="_1、无名交换机" tabindex="-1">1、无名交换机 <a class="header-anchor" href="#_1、无名交换机" aria-label="Permalink to &quot;1、无名交换机&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;hello&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">,message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#768390;">// 第一个参数是交换机的名称。空字符串表示默认或无名称交换机</span></span>
<span class="line"><span style="color:#768390;">// 消息能路由发送到队列中其实是由 routingKey(bindingkey)绑定 key 指定的，如果它存在的话。</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;hello&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">,message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#6A737D;">// 第一个参数是交换机的名称。空字符串表示默认或无名称交换机</span></span>
<span class="line"><span style="color:#6A737D;">// 消息能路由发送到队列中其实是由 routingKey(bindingkey)绑定 key 指定的，如果它存在的话。</span></span></code></pre></div><h4 id="_2、-扇出-fanout" tabindex="-1">2、 扇出（fanout) <a class="header-anchor" href="#_2、-扇出-fanout" aria-label="Permalink to &quot;2、 扇出（fanout)&quot;">​</a></h4><p>  它是将接收到的所有消息广播到它知道的所有队列中。 <img src="/charles-blog/assets/Fanout.f46cadbc.png" alt="Fanout"></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ReceiveLogs01</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">EXCHANGE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;logs&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;fanout&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">        * 生成一个临时的队列 队列的名称是随机的</span></span>
<span class="line"><span style="color:#768390;">        * 当消费者断开和该队列的连接时 队列自动删除</span></span>
<span class="line"><span style="color:#768390;">        */</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queueName</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">getQueue</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//把该临时队列绑定我们的 exchange 其中 routingkey(也称之为 binding key)为空字符串</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(queueName, EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;等待接收消息,把接收到的消息打印在屏幕 ........... &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag, delivery) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> { </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">(), </span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;控制台打印接收到的消息&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, deliverCallback, consumerTag </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> { });</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ReceiveLogs02</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">EXCHANGE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;logs&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;fanout&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">        * 生成一个临时的队列 队列的名称是随机的</span></span>
<span class="line"><span style="color:#768390;">        * 当消费者断开和该队列的连接时 队列自动删除</span></span>
<span class="line"><span style="color:#768390;">        */</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queueName</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">getQueue</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//把该临时队列绑定我们的 exchange 其中 routingkey(也称之为 binding key)为空字符串</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(queueName, EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;等待接收消息,把接收到的消息写到文件 ........... &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag, delivery) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> { </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">(), </span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            File</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">file</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">File</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;C:</span><span style="color:#F47067;">\\</span><span style="color:#96D0FF;">work</span><span style="color:#F47067;">\\</span><span style="color:#96D0FF;">rabbitmq_info.txt&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            FileUtils.</span><span style="color:#DCBDFB;">writeStringToFile</span><span style="color:#ADBAC7;">(file,message,</span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;数据写入文件成功&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, deliverCallback, consumerTag </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> { });</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">EmitLog</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">EXCHANGE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;logs&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> (Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">()) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">            * 声明一个 exchange</span></span>
<span class="line"><span style="color:#768390;">            * 1.exchange 的名称</span></span>
<span class="line"><span style="color:#768390;">            * 2.exchange 的类型</span></span>
<span class="line"><span style="color:#768390;">            */</span></span>
<span class="line"><span style="color:#ADBAC7;">            channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;fanout&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            Scanner</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">sc</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">Scanner</span><span style="color:#ADBAC7;">(System.in);</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;请输入信息&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">while</span><span style="color:#ADBAC7;"> (sc.</span><span style="color:#DCBDFB;">hasNext</span><span style="color:#ADBAC7;">()) {</span></span>
<span class="line"><span style="color:#ADBAC7;">                String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> sc.</span><span style="color:#DCBDFB;">nextLine</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">                channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">, message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">));</span></span>
<span class="line"><span style="color:#ADBAC7;">                System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;生产者发出消息&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> message);</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReceiveLogs01</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String EXCHANGE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;logs&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;fanout&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">        * 生成一个临时的队列 队列的名称是随机的</span></span>
<span class="line"><span style="color:#6A737D;">        * 当消费者断开和该队列的连接时 队列自动删除</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#24292E;">        String queueName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getQueue</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//把该临时队列绑定我们的 exchange 其中 routingkey(也称之为 binding key)为空字符串</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(queueName, EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;等待接收消息,把接收到的消息打印在屏幕 ........... &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag, delivery) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;控制台打印接收到的消息&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, deliverCallback, consumerTag </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> { });</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReceiveLogs02</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String EXCHANGE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;logs&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;fanout&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">        * 生成一个临时的队列 队列的名称是随机的</span></span>
<span class="line"><span style="color:#6A737D;">        * 当消费者断开和该队列的连接时 队列自动删除</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#24292E;">        String queueName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getQueue</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//把该临时队列绑定我们的 exchange 其中 routingkey(也称之为 binding key)为空字符串</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(queueName, EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;等待接收消息,把接收到的消息写到文件 ........... &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag, delivery) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            File file </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">File</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;C:</span><span style="color:#005CC5;">\\</span><span style="color:#032F62;">work</span><span style="color:#005CC5;">\\</span><span style="color:#032F62;">rabbitmq_info.txt&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            FileUtils.</span><span style="color:#6F42C1;">writeStringToFile</span><span style="color:#24292E;">(file,message,</span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;数据写入文件成功&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, deliverCallback, consumerTag </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> { });</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">EmitLog</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String EXCHANGE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;logs&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> (Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">            * 声明一个 exchange</span></span>
<span class="line"><span style="color:#6A737D;">            * 1.exchange 的名称</span></span>
<span class="line"><span style="color:#6A737D;">            * 2.exchange 的类型</span></span>
<span class="line"><span style="color:#6A737D;">            */</span></span>
<span class="line"><span style="color:#24292E;">            channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;fanout&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            Scanner sc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Scanner</span><span style="color:#24292E;">(System.in);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;请输入信息&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (sc.</span><span style="color:#6F42C1;">hasNext</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">                String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> sc.</span><span style="color:#6F42C1;">nextLine</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;生产者发出消息&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> message);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="_3、直接交换机-direct-exchange" tabindex="-1">3、直接交换机（Direct exchange） <a class="header-anchor" href="#_3、直接交换机-direct-exchange" aria-label="Permalink to &quot;3、直接交换机（Direct exchange）&quot;">​</a></h4><p>  这种类型的工作方式是，消息只去到它绑定的routingKey 队列中去。 <img src="/charles-blog/assets/Direct.bcaf2de0.png" alt="Direct">   X 绑定了两个队列，绑定类型是 direct。队列 Q1 绑定键为 orange，队列 Q2 绑定键有两个:一个绑定键为 black，另一个绑定键为 green.在这种绑定情况下，生产者发布消息到 exchange 上，绑定键为 orange 的消息会被发布到队列Q1。绑定键为 black和green 的消息会被发布到队列 Q2，其他消息类型的消息将被丢弃。 <img src="/charles-blog/assets/DirectSameKey.bd75e246.png" alt="DirectSameKey">   多重绑定：当然如果 exchange 的绑定类型是direct，但是它绑定的多个队列的 key 如果都相同，在这种情况下虽然绑定类型是 direct 但是它表现的就和 fanout 有点类似了，就跟广播差不多。</p><p>  示例： <img src="/charles-blog/assets/DirectExample.978a61ad.png" alt="DirectExample"></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ReceiveLogsDirect01</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">EXCHANGE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;direct_logs&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queueName</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;disk&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(queueName, EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;error&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;等待接收消息 ........... &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag, delivery) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> { </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">(), </span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            message</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;接收绑定键:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">delivery.</span><span style="color:#DCBDFB;">getEnvelope</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">getRoutingKey</span><span style="color:#ADBAC7;">()</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot;,消息:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message;</span></span>
<span class="line"><span style="color:#ADBAC7;">            File</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">file</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">File</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;C:</span><span style="color:#F47067;">\\</span><span style="color:#96D0FF;">work</span><span style="color:#F47067;">\\</span><span style="color:#96D0FF;">rabbitmq_info.txt&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            FileUtils.</span><span style="color:#DCBDFB;">writeStringToFile</span><span style="color:#ADBAC7;">(file,message,</span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;错误日志已经接收&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, deliverCallback, consumerTag </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> {});</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ReceiveLogsDirect02</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">EXCHANGE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;direct_logs&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queueName</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;console&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(queueName, EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;info&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(queueName, EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;warning&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;等待接收消息 ........... &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag, delivery) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> { </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">(), </span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot; 接收绑定键 :&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">delivery.</span><span style="color:#DCBDFB;">getEnvelope</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">getRoutingKey</span><span style="color:#ADBAC7;">()</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot;, 消息:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, deliverCallback, consumerTag </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> {});</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">EmitLogDirect</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">EXCHANGE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;direct_logs&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> (Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">()) { </span></span>
<span class="line"><span style="color:#ADBAC7;">            channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//创建多个 bindingKey</span></span>
<span class="line"><span style="color:#ADBAC7;">            Map</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">, </span><span style="color:#F47067;">String</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">bindingKeyMap</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;info&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;普通 info 信息&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;warning&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;警告 warning 信息&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;error&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;错误 error 信息&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//debug 没有消费这接收这个消息 所有就丢失了</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;debug&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;调试 debug 信息&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;"> (Map</span><span style="color:#F69D50;">.</span><span style="color:#ADBAC7;">Entry</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">, </span><span style="color:#F47067;">String</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">bindingKeyEntry</span><span style="color:#F47067;">:</span><span style="color:#ADBAC7;">bindingKeyMap.</span><span style="color:#DCBDFB;">entrySet</span><span style="color:#ADBAC7;">()){ </span></span>
<span class="line"><span style="color:#ADBAC7;">                String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">bindingKey</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> bindingKeyEntry.</span><span style="color:#DCBDFB;">getKey</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">                String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> bindingKeyEntry.</span><span style="color:#DCBDFB;">getValue</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">                channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(EXCHANGE_NAME,bindingKey, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">,  message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">));</span></span>
<span class="line"><span style="color:#ADBAC7;">                System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;生产者发出消息:&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> message);</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReceiveLogsDirect01</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String EXCHANGE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;direct_logs&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">        String queueName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;disk&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(queueName, EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;error&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;等待接收消息 ........... &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag, delivery) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            message</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;接收绑定键:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">delivery.</span><span style="color:#6F42C1;">getEnvelope</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getRoutingKey</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot;,消息:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message;</span></span>
<span class="line"><span style="color:#24292E;">            File file </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">File</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;C:</span><span style="color:#005CC5;">\\</span><span style="color:#032F62;">work</span><span style="color:#005CC5;">\\</span><span style="color:#032F62;">rabbitmq_info.txt&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            FileUtils.</span><span style="color:#6F42C1;">writeStringToFile</span><span style="color:#24292E;">(file,message,</span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;错误日志已经接收&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, deliverCallback, consumerTag </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {});</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReceiveLogsDirect02</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String EXCHANGE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;direct_logs&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">        String queueName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;console&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(queueName, EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(queueName, EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;warning&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;等待接收消息 ........... &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag, delivery) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot; 接收绑定键 :&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">delivery.</span><span style="color:#6F42C1;">getEnvelope</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getRoutingKey</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot;, 消息:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, deliverCallback, consumerTag </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {});</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">EmitLogDirect</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String EXCHANGE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;direct_logs&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> (Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">()) { </span></span>
<span class="line"><span style="color:#24292E;">            channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//创建多个 bindingKey</span></span>
<span class="line"><span style="color:#24292E;">            Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; bindingKeyMap </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;普通 info 信息&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;warning&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;警告 warning 信息&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;error&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;错误 error 信息&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//debug 没有消费这接收这个消息 所有就丢失了</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;debug&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;调试 debug 信息&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (Map.Entry&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; bindingKeyEntry</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">bindingKeyMap.</span><span style="color:#6F42C1;">entrySet</span><span style="color:#24292E;">()){ </span></span>
<span class="line"><span style="color:#24292E;">                String bindingKey </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> bindingKeyEntry.</span><span style="color:#6F42C1;">getKey</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> bindingKeyEntry.</span><span style="color:#6F42C1;">getValue</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(EXCHANGE_NAME,bindingKey, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">,  message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;生产者发出消息:&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> message);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="_4、主题交换机-topic" tabindex="-1">4、主题交换机（Topic） <a class="header-anchor" href="#_4、主题交换机-topic" aria-label="Permalink to &quot;4、主题交换机（Topic）&quot;">​</a></h4><p>  发送到类型是 topic 交换机的消息的 routing_key 不能随意写，必须满足一定的要求，它必须是一个单词列表，以点号分隔开。这些单词可以是任意单词，比如说：&quot;stock.usd.nyse&quot;, &quot;nyse.vmw&quot;,&quot;quick.orange.rabbit&quot;.这种类型的。当然这个单词列表最多不能超过 255 个字节。</p><p>  在这个规则列表中，其中有两个替换符是大家需要注意的：</p><ul><li>*(星号)可以代替一个单词</li><li>#(井号)可以替代零个或多个单词</li></ul><p>  当一个队列绑定键是#,那么这个队列将接收所有数据，就有点像 fanout 了</p><p>  如果队列绑定键当中没有#和*出现，那么该队列绑定类型就是 direct 了 <img src="/charles-blog/assets/Topic.2832b5a9.png" alt="Topic"></p><ul><li>Q1--&gt;绑定的是 <ul><li>中间带 orange 带 3 个单词的字符串(<em>.orange.</em>)</li></ul></li><li>Q2--&gt;绑定的是 <ul><li>最后一个单词是 rabbit 的 3 个单词(<em>.</em>.rabbit)</li><li>第一个单词是 lazy 的多个单词(lazy.#)</li></ul></li><li>数据接收情况 <ul><li>quick.orange.rabbit 被队列 Q1Q2 接收到</li><li>lazy.orange.elephant 被队列 Q1Q2 接收到</li><li>quick.orange.fox 被队列 Q1 接收到</li><li>lazy.brown.fox 被队列 Q2 接收到</li><li>lazy.pink.rabbit 虽然满足两个绑定但只被队列 Q2 接收一次</li><li>quick.brown.fox 不匹配任何绑定不会被任何队列接收到会被丢弃</li><li>quick.orange.male.rabbit 是四个单词不匹配任何绑定会被丢弃</li><li>lazy.orange.male.rabbit 是四个单词但匹配 Q2</li></ul></li></ul><p>  示例 <img src="/charles-blog/assets/TopicExample.0953cfab.png" alt="TopicExample"></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">EmitLogTopic</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">EXCHANGE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;topic_logs&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> (Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">()) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;topic&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">            * Q1--&gt;绑定的是</span></span>
<span class="line"><span style="color:#768390;">                中间带 orange 带 3 个单词的字符串(*.orange.*)</span></span>
<span class="line"><span style="color:#768390;">            * Q2--&gt;绑定的是 </span></span>
<span class="line"><span style="color:#768390;">                最后一个单词是 rabbit 的 3 个单词(*.*.rabbit)</span></span>
<span class="line"><span style="color:#768390;">                第一个单词是 lazy 的多个单词(lazy.#)</span></span>
<span class="line"><span style="color:#768390;">            */</span></span>
<span class="line"><span style="color:#ADBAC7;">            Map</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">, </span><span style="color:#F47067;">String</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">bindingKeyMap</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;quick.orange.rabbit&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;被队列 Q1Q2 接收到&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;lazy.orange.elephant&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;被队列 Q1Q2 接收到&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;quick.orange.fox&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;被队列 Q1 接收到&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;lazy.brown.fox&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;被队列 Q2 接收到&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;lazy.pink.rabbit&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;虽然满足两个绑定但只被队列 Q2 接收一次&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;quick.brown.fox&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;不匹配任何绑定不会被任何队列接收到会被丢弃&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;quick.orange.male.rabbit&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;是四个单词不匹配任何绑定会被丢弃&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            bindingKeyMap.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;lazy.orange.male.rabbit&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#96D0FF;">&quot;是四个单词但匹配 Q2&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;"> (Map</span><span style="color:#F69D50;">.</span><span style="color:#ADBAC7;">Entry</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">, </span><span style="color:#F47067;">String</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">bindingKeyEntry</span><span style="color:#F47067;">:</span><span style="color:#ADBAC7;"> bindingKeyMap.</span><span style="color:#DCBDFB;">entrySet</span><span style="color:#ADBAC7;">()){ </span></span>
<span class="line"><span style="color:#ADBAC7;">                String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">bindingKey</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> bindingKeyEntry.</span><span style="color:#DCBDFB;">getKey</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">                String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> bindingKeyEntry.</span><span style="color:#DCBDFB;">getValue</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">                channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(EXCHANGE_NAME,bindingKey, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">,message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">));</span></span>
<span class="line"><span style="color:#ADBAC7;">                System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;生产者发出消息&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> message);</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ReceiveLogsTopic01</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">EXCHANGE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;topic_logs&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;topic&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明 Q1 队列与绑定关系</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queueName</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;Q1&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(queueName, EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;*.orange.*&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;等待接收消息 ........... &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag, delivery) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> { </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">(), </span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;接收队列:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">queueName</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot;绑定键:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">delivery.</span><span style="color:#DCBDFB;">getEnvelope</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">getRoutingKey</span><span style="color:#ADBAC7;">()</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot;,消息:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, deliverCallback, consumerTag </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> {});</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ReceiveLogsTopic02</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">EXCHANGE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;topic_logs&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;topic&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明 Q2 队列与绑定关系</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queueName</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;Q2&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(queueName, EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;*.*.rabbit&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(queueName, EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;lazy.#&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;等待接收消息 ........... &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag, delivery) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> { </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">(), </span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;接收队列:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">queueName</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot;绑定键:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">delivery.</span><span style="color:#DCBDFB;">getEnvelope</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">getRoutingKey</span><span style="color:#ADBAC7;">()</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot;,消息:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(queueName, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, deliverCallback, consumerTag </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> {});</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">EmitLogTopic</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String EXCHANGE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;topic_logs&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> (Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">            channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;topic&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">            * Q1--&gt;绑定的是</span></span>
<span class="line"><span style="color:#6A737D;">                中间带 orange 带 3 个单词的字符串(*.orange.*)</span></span>
<span class="line"><span style="color:#6A737D;">            * Q2--&gt;绑定的是 </span></span>
<span class="line"><span style="color:#6A737D;">                最后一个单词是 rabbit 的 3 个单词(*.*.rabbit)</span></span>
<span class="line"><span style="color:#6A737D;">                第一个单词是 lazy 的多个单词(lazy.#)</span></span>
<span class="line"><span style="color:#6A737D;">            */</span></span>
<span class="line"><span style="color:#24292E;">            Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; bindingKeyMap </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;quick.orange.rabbit&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;被队列 Q1Q2 接收到&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lazy.orange.elephant&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;被队列 Q1Q2 接收到&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;quick.orange.fox&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;被队列 Q1 接收到&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lazy.brown.fox&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;被队列 Q2 接收到&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lazy.pink.rabbit&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;虽然满足两个绑定但只被队列 Q2 接收一次&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;quick.brown.fox&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;不匹配任何绑定不会被任何队列接收到会被丢弃&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;quick.orange.male.rabbit&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;是四个单词不匹配任何绑定会被丢弃&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            bindingKeyMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;lazy.orange.male.rabbit&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;是四个单词但匹配 Q2&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (Map.Entry&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; bindingKeyEntry</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> bindingKeyMap.</span><span style="color:#6F42C1;">entrySet</span><span style="color:#24292E;">()){ </span></span>
<span class="line"><span style="color:#24292E;">                String bindingKey </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> bindingKeyEntry.</span><span style="color:#6F42C1;">getKey</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> bindingKeyEntry.</span><span style="color:#6F42C1;">getValue</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(EXCHANGE_NAME,bindingKey, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">,message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;生产者发出消息&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> message);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReceiveLogsTopic01</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String EXCHANGE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;topic_logs&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;topic&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明 Q1 队列与绑定关系</span></span>
<span class="line"><span style="color:#24292E;">        String queueName</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Q1&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(queueName, EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;*.orange.*&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;等待接收消息 ........... &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag, delivery) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;接收队列:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">queueName</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot;绑定键:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">delivery.</span><span style="color:#6F42C1;">getEnvelope</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getRoutingKey</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot;,消息:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, deliverCallback, consumerTag </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {});</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReceiveLogsTopic02</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String EXCHANGE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;topic_logs&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;topic&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明 Q2 队列与绑定关系</span></span>
<span class="line"><span style="color:#24292E;">        String queueName</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;Q2&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(queueName, EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;*.*.rabbit&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(queueName, EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;lazy.#&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;等待接收消息 ........... &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag, delivery) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;接收队列:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">queueName</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot;绑定键:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">delivery.</span><span style="color:#6F42C1;">getEnvelope</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getRoutingKey</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot;,消息:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(queueName, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, deliverCallback, consumerTag </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {});</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="死信队列" tabindex="-1">死信队列 <a class="header-anchor" href="#死信队列" aria-label="Permalink to &quot;死信队列&quot;">​</a></h2><p>  死信，顾名思义就是无法被消费的消息；一般来说，producer 将消息投递到 broker 或者直接到queue 里了，consumer 从 queue 取出消息进行消费，但某些时候由于特定的原因导致 queue 中的某些消息无法被消费，这样的消息如果没有后续的处理，就变成了死信，有死信自然就有了死信队列。</p><p>  应用场景:为了保证订单业务的消息数据不丢失，需要使用到 RabbitMQ 的死信队列机制，当消息消费发生异常时，将消息投入死信队列中.还有比如说: 用户在商城下单成功并点击去支付后在指定时间未支付时自动失效。</p><h3 id="死信的来源" tabindex="-1">死信的来源 <a class="header-anchor" href="#死信的来源" aria-label="Permalink to &quot;死信的来源&quot;">​</a></h3><ul><li>消息 TTL 过期</li><li>队列达到最大长度(队列满了，无法再添加数据到 mq 中)</li><li>消息被拒绝(basic.reject 或 basic.nack)并且 requeue=false. <img src="/charles-blog/assets/DeadLetterQueue.35451147.png" alt="DeadLetterQueue"></li></ul><h4 id="消息ttl过期" tabindex="-1">消息TTL过期 <a class="header-anchor" href="#消息ttl过期" aria-label="Permalink to &quot;消息TTL过期&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 生产者</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Producer</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">NORMAL_EXCHANGE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;normal_exchange&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> (Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitMqUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">()){ </span></span>
<span class="line"><span style="color:#ADBAC7;">            channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//设置消息的 TTL 时间</span></span>
<span class="line"><span style="color:#ADBAC7;">            AMQP</span><span style="color:#F69D50;">.</span><span style="color:#ADBAC7;">BasicProperties</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">properties</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> AMQP.</span><span style="color:#DCBDFB;">BasicProperties</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">builder</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">expiration</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;10000&quot;</span><span style="color:#ADBAC7;">).</span><span style="color:#DCBDFB;">build</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//该信息是用作演示队列个数限制</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;"> (</span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">; i </span><span style="color:#F47067;">&lt;</span><span style="color:#6CB6FF;">11</span><span style="color:#ADBAC7;"> ; i</span><span style="color:#F47067;">++</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">                String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;info&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">i;</span></span>
<span class="line"><span style="color:#ADBAC7;">                channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(NORMAL_EXCHANGE,message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">                System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;生产者发送消息:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 消费者C1 （启动之后关闭该消费者 模拟其接收不到消息）</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Consumer01</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//普通交换机名称</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">NORMAL_EXCHANGE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;normal_exchange&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//死信交换机名称</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">DEAD_EXCHANGE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;dead_exchange&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明死信和普通交换机 类型为 direct</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明死信队列</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deadQueue</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;dead-queue&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(deadQueue, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//死信队列绑定死信交换机与 routingkey</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(deadQueue, DEAD_EXCHANGE, </span><span style="color:#96D0FF;">&quot;lisi&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//正常队列绑定死信队列信息</span></span>
<span class="line"><span style="color:#ADBAC7;">        Map</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">, </span><span style="color:#F47067;">Object</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">params</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//正常队列设置死信交换机 参数 key 是固定值</span></span>
<span class="line"><span style="color:#ADBAC7;">        params.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#ADBAC7;">, DEAD_EXCHANGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//正常队列设置死信 routing-key 参数 key 是固定值</span></span>
<span class="line"><span style="color:#ADBAC7;">        params.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;lisi&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">normalQueue</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;normal-queue&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(normalQueue, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, params);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(normalQueue, NORMAL_EXCHANGE, </span><span style="color:#96D0FF;">&quot;zhangsan&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;等待接收消息 ........... &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag, delivery) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;">{ </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">(), </span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;Consumer01 接收到消息&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(normalQueue, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, deliverCallback, consumerTag </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> {});</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 消费者 C2 (死信队列)</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Consumer02</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">DEAD_EXCHANGE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;dead_exchange&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deadQueue</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;dead-queue&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(deadQueue, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(deadQueue, DEAD_EXCHANGE, </span><span style="color:#96D0FF;">&quot;lisi&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;等待接收死信队列消息 ........... &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag, delivery) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;">{ </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">(), </span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;Consumer02 接收死信队列的消息&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> message);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(deadQueue, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, deliverCallback, consumerTag </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> {});</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 生产者</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Producer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String NORMAL_EXCHANGE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;normal_exchange&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> (Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitMqUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">()){ </span></span>
<span class="line"><span style="color:#24292E;">            channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//设置消息的 TTL 时间</span></span>
<span class="line"><span style="color:#24292E;">            AMQP.BasicProperties properties </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> AMQP.</span><span style="color:#6F42C1;">BasicProperties</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">builder</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">expiration</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;10000&quot;</span><span style="color:#24292E;">).</span><span style="color:#6F42C1;">build</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//该信息是用作演示队列个数限制</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#005CC5;">11</span><span style="color:#24292E;"> ; i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                String message</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">i;</span></span>
<span class="line"><span style="color:#24292E;">                channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(NORMAL_EXCHANGE,message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;生产者发送消息:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 消费者C1 （启动之后关闭该消费者 模拟其接收不到消息）</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Consumer01</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//普通交换机名称</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String NORMAL_EXCHANGE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;normal_exchange&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//死信交换机名称</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String DEAD_EXCHANGE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;dead_exchange&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明死信和普通交换机 类型为 direct</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明死信队列</span></span>
<span class="line"><span style="color:#24292E;">        String deadQueue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;dead-queue&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(deadQueue, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//死信队列绑定死信交换机与 routingkey</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(deadQueue, DEAD_EXCHANGE, </span><span style="color:#032F62;">&quot;lisi&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//正常队列绑定死信队列信息</span></span>
<span class="line"><span style="color:#24292E;">        Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; params </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//正常队列设置死信交换机 参数 key 是固定值</span></span>
<span class="line"><span style="color:#24292E;">        params.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#24292E;">, DEAD_EXCHANGE);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//正常队列设置死信 routing-key 参数 key 是固定值</span></span>
<span class="line"><span style="color:#24292E;">        params.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;lisi&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        String normalQueue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;normal-queue&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(normalQueue, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, params);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(normalQueue, NORMAL_EXCHANGE, </span><span style="color:#032F62;">&quot;zhangsan&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;等待接收消息 ........... &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag, delivery) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">{ </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Consumer01 接收到消息&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(normalQueue, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, deliverCallback, consumerTag </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {});</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 消费者 C2 (死信队列)</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Consumer02</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String DEAD_EXCHANGE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;dead_exchange&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">        String deadQueue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;dead-queue&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(deadQueue, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(deadQueue, DEAD_EXCHANGE, </span><span style="color:#032F62;">&quot;lisi&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;等待接收死信队列消息 ........... &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag, delivery) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">{ </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Consumer02 接收死信队列的消息&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> message);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(deadQueue, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, deliverCallback, consumerTag </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {});</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="队列达到最大长度" tabindex="-1">队列达到最大长度 <a class="header-anchor" href="#队列达到最大长度" aria-label="Permalink to &quot;队列达到最大长度&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 生产者</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Producer</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">NORMAL_EXCHANGE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;normal_exchange&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> (Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitMqUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">()){ </span></span>
<span class="line"><span style="color:#ADBAC7;">            channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//该信息是用作演示队列个数限制</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;"> (</span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">; i </span><span style="color:#F47067;">&lt;</span><span style="color:#6CB6FF;">11</span><span style="color:#ADBAC7;"> ; i</span><span style="color:#F47067;">++</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">                 String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;info&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">i;</span></span>
<span class="line"><span style="color:#ADBAC7;">                channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(NORMAL_EXCHANGE,</span><span style="color:#96D0FF;">&quot;zhangsan&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">, message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">                System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;生产者发送消息:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 消费者C1</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Consumer01</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">NORMAL_EXCHANGE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;normal_exchange&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">DEAD_EXCHANGE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;dead_exchange&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deadQueue</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;dead-queue&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(deadQueue, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(deadQueue, DEAD_EXCHANGE, </span><span style="color:#96D0FF;">&quot;lisi&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        Map</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">, </span><span style="color:#F47067;">Object</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">params</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#ADBAC7;">        params.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#ADBAC7;">, DEAD_EXCHANGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">        params.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;lisi&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">// 设置正常队列长度的限制</span></span>
<span class="line"><span style="color:#ADBAC7;">        params.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-max-length&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">6</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">normalQueue</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;normal-queue&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(normalQueue, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, params);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(normalQueue, NORMAL_EXCHANGE, </span><span style="color:#96D0FF;">&quot;zhangsan&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;等待接收消息 ........... &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag, delivery) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;">{ </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">(), </span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;Consumer01 接收到消息&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(normalQueue, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, deliverCallback, consumerTag </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> {});</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 消费者C2同上</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 生产者</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Producer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String NORMAL_EXCHANGE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;normal_exchange&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> (Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitMqUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">()){ </span></span>
<span class="line"><span style="color:#24292E;">            channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//该信息是用作演示队列个数限制</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#005CC5;">11</span><span style="color:#24292E;"> ; i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                 String message</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">i;</span></span>
<span class="line"><span style="color:#24292E;">                channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(NORMAL_EXCHANGE,</span><span style="color:#032F62;">&quot;zhangsan&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;生产者发送消息:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 消费者C1</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Consumer01</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String NORMAL_EXCHANGE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;normal_exchange&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String DEAD_EXCHANGE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;dead_exchange&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">        String deadQueue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;dead-queue&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(deadQueue, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(deadQueue, DEAD_EXCHANGE, </span><span style="color:#032F62;">&quot;lisi&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; params </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">        params.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#24292E;">, DEAD_EXCHANGE);</span></span>
<span class="line"><span style="color:#24292E;">        params.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;lisi&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 设置正常队列长度的限制</span></span>
<span class="line"><span style="color:#24292E;">        params.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-max-length&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">6</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        String normalQueue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;normal-queue&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(normalQueue, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, params);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(normalQueue, NORMAL_EXCHANGE, </span><span style="color:#032F62;">&quot;zhangsan&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;等待接收消息 ........... &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag, delivery) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">{ </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Consumer01 接收到消息&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(normalQueue, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, deliverCallback, consumerTag </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {});</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 消费者C2同上</span></span></code></pre></div><h4 id="消息被拒" tabindex="-1">消息被拒 <a class="header-anchor" href="#消息被拒" aria-label="Permalink to &quot;消息被拒&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 生产者同上</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 消费者C1</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Consumer01</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//普通交换机名称</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">NORMAL_EXCHANGE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;normal_exchange&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//死信交换机名称</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">DEAD_EXCHANGE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;dead_exchange&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">argv</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明死信和普通交换机 类型为 direct</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">exchangeDeclare</span><span style="color:#ADBAC7;">(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明死信队列</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deadQueue</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;dead-queue&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(deadQueue, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//死信队列绑定死信交换机与 routingkey</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(deadQueue, DEAD_EXCHANGE, </span><span style="color:#96D0FF;">&quot;lisi&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//正常队列绑定死信队列信息</span></span>
<span class="line"><span style="color:#ADBAC7;">        Map</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">, </span><span style="color:#F47067;">Object</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">params</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//正常队列设置死信交换机 参数 key 是固定值</span></span>
<span class="line"><span style="color:#ADBAC7;">        params.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#ADBAC7;">, DEAD_EXCHANGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//正常队列设置死信 routing-key 参数 key 是固定值</span></span>
<span class="line"><span style="color:#ADBAC7;">        params.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;lisi&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">normalQueue</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;normal-queue&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(normalQueue, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, params);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueBind</span><span style="color:#ADBAC7;">(normalQueue, NORMAL_EXCHANGE, </span><span style="color:#96D0FF;">&quot;zhangsan&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;等待接收消息 ........... &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (consumerTag, delivery) </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> { </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">(), </span><span style="color:#96D0FF;">&quot;UTF-8&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;">(message.</span><span style="color:#DCBDFB;">equals</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;info5&quot;</span><span style="color:#ADBAC7;">)){</span></span>
<span class="line"><span style="color:#ADBAC7;">                System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;Consumer01 接收到消息&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> message </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;并拒绝签收该消息&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#768390;">//requeue 设置为 false 代表拒绝重新入队 该队列如果配置了死信交换机将发送到死信队列中</span></span>
<span class="line"><span style="color:#ADBAC7;">                channel.</span><span style="color:#DCBDFB;">basicReject</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getEnvelope</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">getDeliveryTag</span><span style="color:#ADBAC7;">(), </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span><span style="color:#F47067;">else</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">                System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;Consumer01 接收到消息&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">                channel.</span><span style="color:#DCBDFB;">basicAck</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getEnvelope</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">getDeliveryTag</span><span style="color:#ADBAC7;">(), </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">boolean</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">autoAck</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(normalQueue, autoAck, deliverCallback, consumerTag </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;"> {});</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 消费者C2同上</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 生产者同上</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 消费者C1</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Consumer01</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//普通交换机名称</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String NORMAL_EXCHANGE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;normal_exchange&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//死信交换机名称</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String DEAD_EXCHANGE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;dead_exchange&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">argv</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明死信和普通交换机 类型为 direct</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明死信队列</span></span>
<span class="line"><span style="color:#24292E;">        String deadQueue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;dead-queue&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(deadQueue, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//死信队列绑定死信交换机与 routingkey</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(deadQueue, DEAD_EXCHANGE, </span><span style="color:#032F62;">&quot;lisi&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//正常队列绑定死信队列信息</span></span>
<span class="line"><span style="color:#24292E;">        Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; params </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//正常队列设置死信交换机 参数 key 是固定值</span></span>
<span class="line"><span style="color:#24292E;">        params.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#24292E;">, DEAD_EXCHANGE);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//正常队列设置死信 routing-key 参数 key 是固定值</span></span>
<span class="line"><span style="color:#24292E;">        params.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;lisi&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        String normalQueue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;normal-queue&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(normalQueue, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, params);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueBind</span><span style="color:#24292E;">(normalQueue, NORMAL_EXCHANGE, </span><span style="color:#032F62;">&quot;zhangsan&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;等待接收消息 ........... &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (consumerTag, delivery) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">            String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;UTF-8&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(message.</span><span style="color:#6F42C1;">equals</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;info5&quot;</span><span style="color:#24292E;">)){</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Consumer01 接收到消息&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> message </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;并拒绝签收该消息&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">//requeue 设置为 false 代表拒绝重新入队 该队列如果配置了死信交换机将发送到死信队列中</span></span>
<span class="line"><span style="color:#24292E;">                channel.</span><span style="color:#6F42C1;">basicReject</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getEnvelope</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getDeliveryTag</span><span style="color:#24292E;">(), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            }</span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Consumer01 接收到消息&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">                channel.</span><span style="color:#6F42C1;">basicAck</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getEnvelope</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getDeliveryTag</span><span style="color:#24292E;">(), </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> autoAck </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(normalQueue, autoAck, deliverCallback, consumerTag </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {});</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 消费者C2同上</span></span></code></pre></div><h2 id="延迟队列" tabindex="-1">延迟队列 <a class="header-anchor" href="#延迟队列" aria-label="Permalink to &quot;延迟队列&quot;">​</a></h2><p>  延时队列,队列内部是有序的，最重要的特性就体现在它的延时属性上，延时队列中的元素是希望在指定时间到了以后或之前取出和处理，简单来说，延时队列就是用来存放需要在指定时间被处理的元素的队列。</p><h3 id="使用场景" tabindex="-1">使用场景 <a class="header-anchor" href="#使用场景" aria-label="Permalink to &quot;使用场景&quot;">​</a></h3><ol><li>订单在十分钟之内未支付则自动取消</li><li>新创建的店铺，如果在十天内都没有上传过商品，则自动发送消息提醒。</li><li>用户注册成功后，如果三天内没有登陆则进行短信提醒。</li><li>用户发起退款，如果三天内没有得到处理则通知相关运营人员。</li><li>预定会议后，需要在预定的时间点前十分钟通知各个与会人员参加会议</li></ol><h3 id="示例" tabindex="-1">示例 <a class="header-anchor" href="#示例" aria-label="Permalink to &quot;示例&quot;">​</a></h3><p><img src="/charles-blog/assets/DelayQueue.03e4105a.png" alt="DelayQueue"></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 配置文件类</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Configuration</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">TtlQueueConfig</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">X_EXCHANGE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;X&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">QUEUE_A</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;QA&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">QUEUE_B</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;QB&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">Y_DEAD_LETTER_EXCHANGE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;Y&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">DEAD_LETTER_QUEUE</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;QD&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 声明 xExchange</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;xExchange&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> DirectExchange </span><span style="color:#DCBDFB;">xExchange</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">DirectExchange</span><span style="color:#ADBAC7;">(X_EXCHANGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 声明 yExchange</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;yExchange&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> DirectExchange </span><span style="color:#DCBDFB;">yExchange</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">DirectExchange</span><span style="color:#ADBAC7;">(Y_DEAD_LETTER_EXCHANGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//声明队列 A ttl 为 10s 并绑定到对应的死信交换机</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;queueA&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> Queue </span><span style="color:#DCBDFB;">queueA</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">        Map</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">, </span><span style="color:#F47067;">Object</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">args</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> HashMap&lt;&gt;(</span><span style="color:#6CB6FF;">3</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明当前队列绑定的死信交换机</span></span>
<span class="line"><span style="color:#ADBAC7;">        args.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#ADBAC7;">, Y_DEAD_LETTER_EXCHANGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明当前队列的死信路由 key</span></span>
<span class="line"><span style="color:#ADBAC7;">        args.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;YD&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明队列的 TTL</span></span>
<span class="line"><span style="color:#ADBAC7;">        args.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-message-ttl&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">10000</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> QueueBuilder.</span><span style="color:#DCBDFB;">durable</span><span style="color:#ADBAC7;">(QUEUE_A).</span><span style="color:#DCBDFB;">withArguments</span><span style="color:#ADBAC7;">(args).</span><span style="color:#DCBDFB;">build</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 声明队列 A 绑定 X 交换机</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> Binding </span><span style="color:#DCBDFB;">queueaBindingX</span><span style="color:#ADBAC7;">(@</span><span style="color:#F47067;">Qualifier</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;queueA&quot;</span><span style="color:#ADBAC7;">) Queue </span><span style="color:#F69D50;">queueA</span><span style="color:#ADBAC7;">, @</span><span style="color:#F47067;">Qualifier</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;xExchange&quot;</span><span style="color:#ADBAC7;">) DirectExchange </span><span style="color:#F69D50;">xExchange</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> BindingBuilder.</span><span style="color:#DCBDFB;">bind</span><span style="color:#ADBAC7;">(queueA).</span><span style="color:#DCBDFB;">to</span><span style="color:#ADBAC7;">(xExchange).</span><span style="color:#DCBDFB;">with</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;XA&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//声明队列 B ttl 为 40s 并绑定到对应的死信交换机</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;queueB&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> Queue </span><span style="color:#DCBDFB;">queueB</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">        Map</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">, </span><span style="color:#F47067;">Object</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">args</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> HashMap&lt;&gt;(</span><span style="color:#6CB6FF;">3</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明当前队列绑定的死信交换机</span></span>
<span class="line"><span style="color:#ADBAC7;">        args.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#ADBAC7;">, Y_DEAD_LETTER_EXCHANGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明当前队列的死信路由 key</span></span>
<span class="line"><span style="color:#ADBAC7;">        args.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;YD&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//声明队列的 TTL</span></span>
<span class="line"><span style="color:#ADBAC7;">        args.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-message-ttl&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">40000</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> QueueBuilder.</span><span style="color:#DCBDFB;">durable</span><span style="color:#ADBAC7;">(QUEUE_B).</span><span style="color:#DCBDFB;">withArguments</span><span style="color:#ADBAC7;">(args).</span><span style="color:#DCBDFB;">build</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//声明队列 B 绑定 X 交换机</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> Binding </span><span style="color:#DCBDFB;">queuebBindingX</span><span style="color:#ADBAC7;">(@</span><span style="color:#F47067;">Qualifier</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;queueB&quot;</span><span style="color:#ADBAC7;">) Queue </span><span style="color:#F69D50;">queue1B</span><span style="color:#ADBAC7;">, @</span><span style="color:#F47067;">Qualifier</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;xExchange&quot;</span><span style="color:#ADBAC7;">) DirectExchange </span><span style="color:#F69D50;">xExchange</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> BindingBuilder.</span><span style="color:#DCBDFB;">bind</span><span style="color:#ADBAC7;">(queue1B).</span><span style="color:#DCBDFB;">to</span><span style="color:#ADBAC7;">(xExchange).</span><span style="color:#DCBDFB;">with</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;XB&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//声明死信队列 QD</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;queueD&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> Queue </span><span style="color:#DCBDFB;">queueD</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">Queue</span><span style="color:#ADBAC7;">(DEAD_LETTER_QUEUE);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//声明死信队列 QD 绑定关系</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> Binding </span><span style="color:#DCBDFB;">deadLetterBindingQAD</span><span style="color:#ADBAC7;">(@</span><span style="color:#F47067;">Qualifier</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;queueD&quot;</span><span style="color:#ADBAC7;">) Queue </span><span style="color:#F69D50;">queueD</span><span style="color:#ADBAC7;">,@</span><span style="color:#F47067;">Qualifier</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;yExchange&quot;</span><span style="color:#ADBAC7;">) DirectExchange </span><span style="color:#F69D50;">yExchange</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> BindingBuilder.</span><span style="color:#DCBDFB;">bind</span><span style="color:#ADBAC7;">(queueD).</span><span style="color:#DCBDFB;">to</span><span style="color:#ADBAC7;">(yExchange).</span><span style="color:#DCBDFB;">with</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;YD&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 生产者</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Slf4j</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">RequestMapping</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;ttl&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">RestController</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">SendMsgController</span><span style="color:#ADBAC7;">{ </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Autowired</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> RabbitTemplate</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">rabbitTemplate;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">GetMapping</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;sendMsg/{message}&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">sendMsg</span><span style="color:#ADBAC7;">(@</span><span style="color:#F47067;">PathVariable</span><span style="color:#ADBAC7;"> String </span><span style="color:#F69D50;">message</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">        log.</span><span style="color:#DCBDFB;">info</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;当前时间：{},发送一条信息给两个 TTL 队列:{}&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">Date</span><span style="color:#ADBAC7;">(), message);</span></span>
<span class="line"><span style="color:#ADBAC7;">        rabbitTemplate.</span><span style="color:#DCBDFB;">convertAndSend</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;X&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;XA&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;消息来自 ttl 为 10S 的队列: &quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">        rabbitTemplate.</span><span style="color:#DCBDFB;">convertAndSend</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;X&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;XB&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;消息来自 ttl 为 40S 的队列: &quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">message);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 消费者</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Slf4j</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Component</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">DeadLetterQueueConsumer</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">RabbitListener</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">queues</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;QD&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">receiveD</span><span style="color:#ADBAC7;">(Message </span><span style="color:#F69D50;">message</span><span style="color:#ADBAC7;">, Channel </span><span style="color:#F69D50;">channel</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> IOException{ </span></span>
<span class="line"><span style="color:#ADBAC7;">        String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">msg</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(message.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">        log.</span><span style="color:#DCBDFB;">info</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;当前时间：{},收到死信队列信息{}&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">Date</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">toString</span><span style="color:#ADBAC7;">(), msg);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 配置文件类</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Configuration</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TtlQueueConfig</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String X_EXCHANGE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;X&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String QUEUE_A </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;QA&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String QUEUE_B </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;QB&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String Y_DEAD_LETTER_EXCHANGE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Y&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String DEAD_LETTER_QUEUE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;QD&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 声明 xExchange</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;xExchange&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> DirectExchange </span><span style="color:#6F42C1;">xExchange</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DirectExchange</span><span style="color:#24292E;">(X_EXCHANGE);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 声明 yExchange</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;yExchange&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> DirectExchange </span><span style="color:#6F42C1;">yExchange</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DirectExchange</span><span style="color:#24292E;">(Y_DEAD_LETTER_EXCHANGE);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//声明队列 A ttl 为 10s 并绑定到对应的死信交换机</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;queueA&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Queue </span><span style="color:#6F42C1;">queueA</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;(</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明当前队列绑定的死信交换机</span></span>
<span class="line"><span style="color:#24292E;">        args.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#24292E;">, Y_DEAD_LETTER_EXCHANGE);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明当前队列的死信路由 key</span></span>
<span class="line"><span style="color:#24292E;">        args.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;YD&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明队列的 TTL</span></span>
<span class="line"><span style="color:#24292E;">        args.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-message-ttl&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">10000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> QueueBuilder.</span><span style="color:#6F42C1;">durable</span><span style="color:#24292E;">(QUEUE_A).</span><span style="color:#6F42C1;">withArguments</span><span style="color:#24292E;">(args).</span><span style="color:#6F42C1;">build</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 声明队列 A 绑定 X 交换机</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Binding </span><span style="color:#6F42C1;">queueaBindingX</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">Qualifier</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;queueA&quot;</span><span style="color:#24292E;">) Queue </span><span style="color:#E36209;">queueA</span><span style="color:#24292E;">, @</span><span style="color:#D73A49;">Qualifier</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;xExchange&quot;</span><span style="color:#24292E;">) DirectExchange </span><span style="color:#E36209;">xExchange</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> BindingBuilder.</span><span style="color:#6F42C1;">bind</span><span style="color:#24292E;">(queueA).</span><span style="color:#6F42C1;">to</span><span style="color:#24292E;">(xExchange).</span><span style="color:#6F42C1;">with</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;XA&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//声明队列 B ttl 为 40s 并绑定到对应的死信交换机</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;queueB&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Queue </span><span style="color:#6F42C1;">queueB</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;(</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明当前队列绑定的死信交换机</span></span>
<span class="line"><span style="color:#24292E;">        args.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#24292E;">, Y_DEAD_LETTER_EXCHANGE);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明当前队列的死信路由 key</span></span>
<span class="line"><span style="color:#24292E;">        args.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;YD&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//声明队列的 TTL</span></span>
<span class="line"><span style="color:#24292E;">        args.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-message-ttl&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">40000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> QueueBuilder.</span><span style="color:#6F42C1;">durable</span><span style="color:#24292E;">(QUEUE_B).</span><span style="color:#6F42C1;">withArguments</span><span style="color:#24292E;">(args).</span><span style="color:#6F42C1;">build</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//声明队列 B 绑定 X 交换机</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Binding </span><span style="color:#6F42C1;">queuebBindingX</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">Qualifier</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;queueB&quot;</span><span style="color:#24292E;">) Queue </span><span style="color:#E36209;">queue1B</span><span style="color:#24292E;">, @</span><span style="color:#D73A49;">Qualifier</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;xExchange&quot;</span><span style="color:#24292E;">) DirectExchange </span><span style="color:#E36209;">xExchange</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> BindingBuilder.</span><span style="color:#6F42C1;">bind</span><span style="color:#24292E;">(queue1B).</span><span style="color:#6F42C1;">to</span><span style="color:#24292E;">(xExchange).</span><span style="color:#6F42C1;">with</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;XB&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//声明死信队列 QD</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;queueD&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Queue </span><span style="color:#6F42C1;">queueD</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Queue</span><span style="color:#24292E;">(DEAD_LETTER_QUEUE);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//声明死信队列 QD 绑定关系</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Binding </span><span style="color:#6F42C1;">deadLetterBindingQAD</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">Qualifier</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;queueD&quot;</span><span style="color:#24292E;">) Queue </span><span style="color:#E36209;">queueD</span><span style="color:#24292E;">,@</span><span style="color:#D73A49;">Qualifier</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;yExchange&quot;</span><span style="color:#24292E;">) DirectExchange </span><span style="color:#E36209;">yExchange</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> BindingBuilder.</span><span style="color:#6F42C1;">bind</span><span style="color:#24292E;">(queueD).</span><span style="color:#6F42C1;">to</span><span style="color:#24292E;">(yExchange).</span><span style="color:#6F42C1;">with</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;YD&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 生产者</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Slf4j</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">RequestMapping</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;ttl&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">RestController</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SendMsgController</span><span style="color:#24292E;">{ </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> RabbitTemplate rabbitTemplate;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">GetMapping</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;sendMsg/{message}&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sendMsg</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">PathVariable</span><span style="color:#24292E;"> String </span><span style="color:#E36209;">message</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        log.</span><span style="color:#6F42C1;">info</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;当前时间：{},发送一条信息给两个 TTL 队列:{}&quot;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Date</span><span style="color:#24292E;">(), message);</span></span>
<span class="line"><span style="color:#24292E;">        rabbitTemplate.</span><span style="color:#6F42C1;">convertAndSend</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;X&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;XA&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;消息来自 ttl 为 10S 的队列: &quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">        rabbitTemplate.</span><span style="color:#6F42C1;">convertAndSend</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;X&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;XB&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;消息来自 ttl 为 40S 的队列: &quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">message);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 消费者</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Slf4j</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Component</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DeadLetterQueueConsumer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">RabbitListener</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">queues</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;QD&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">receiveD</span><span style="color:#24292E;">(Message </span><span style="color:#E36209;">message</span><span style="color:#24292E;">, Channel </span><span style="color:#E36209;">channel</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> IOException{ </span></span>
<span class="line"><span style="color:#24292E;">        String msg </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(message.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        log.</span><span style="color:#6F42C1;">info</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;当前时间：{},收到死信队列信息{}&quot;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Date</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">toString</span><span style="color:#24292E;">(), msg);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="rabbitmq-插件实现延迟队列" tabindex="-1">Rabbitmq 插件实现延迟队列 <a class="header-anchor" href="#rabbitmq-插件实现延迟队列" aria-label="Permalink to &quot;Rabbitmq 插件实现延迟队列&quot;">​</a></h3><p>  rabbitmq_delayed_message_exchange 插件，然后解压放置到 RabbitMQ 的插件目录。</p><p>  该类型消息支持延迟投递机制 消息传递后并不会立即投递到目标队列中，而是存储在 mnesia(一个分布式数据系统)表中，当达到投递时间时，才投递到目标队列中。</p><p>  示例 <img src="/charles-blog/assets/DelayedMessageExchange.d60ceb1c.png" alt="DelayedMessageExchange"></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 配置文件</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Configuration</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">DelayedQueueConfig</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">DELAYED_QUEUE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;delayed.queue&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">DELAYED_EXCHANGE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;delayed.exchange&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">DELAYED_ROUTING_KEY</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;delayed.routingkey&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> Queue </span><span style="color:#DCBDFB;">delayedQueue</span><span style="color:#ADBAC7;">() {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">Queue</span><span style="color:#ADBAC7;">(DELAYED_QUEUE_NAME);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//自定义交换机 我们在这里定义的是一个延迟交换机</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> CustomExchange </span><span style="color:#DCBDFB;">delayedExchange</span><span style="color:#ADBAC7;">(){ </span></span>
<span class="line"><span style="color:#ADBAC7;">        Map</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">, </span><span style="color:#F47067;">Object</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">args</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//自定义交换机的类型</span></span>
<span class="line"><span style="color:#ADBAC7;">        args.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-delayed-type&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;direct&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">CustomExchange</span><span style="color:#ADBAC7;">(DELAYED_EXCHANGE_NAME, </span><span style="color:#96D0FF;">&quot;x-delayed-message&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, args);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> Binding </span><span style="color:#DCBDFB;">bindingDelayedQueue</span><span style="color:#ADBAC7;">(@</span><span style="color:#F47067;">Qualifier</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;delayedQueue&quot;</span><span style="color:#ADBAC7;">) Queue </span><span style="color:#F69D50;">queue</span><span style="color:#ADBAC7;">, </span></span>
<span class="line"><span style="color:#ADBAC7;">        @</span><span style="color:#F47067;">Qualifier</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;delayedExchange&quot;</span><span style="color:#ADBAC7;">)CustomExchange </span><span style="color:#F69D50;">delayedExchange</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;">  BindingBuilder.</span><span style="color:#DCBDFB;">bind</span><span style="color:#ADBAC7;">(queue).</span><span style="color:#DCBDFB;">to</span><span style="color:#ADBAC7;">(delayedExchange).</span><span style="color:#DCBDFB;">with</span><span style="color:#ADBAC7;">(DELAYED_ROUTING_KEY).</span><span style="color:#DCBDFB;">noargs</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 生产者</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">DELAYED_EXCHANGE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;delayed.exchange&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">DELAYED_ROUTING_KEY</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;delayed.routingkey&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">GetMapping</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;sendDelayMsg/{message}/{delayTime}&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">sendMsg</span><span style="color:#ADBAC7;">(@</span><span style="color:#F47067;">PathVariable</span><span style="color:#ADBAC7;"> String message,@</span><span style="color:#F47067;">PathVariable</span><span style="color:#ADBAC7;"> Integer delayTime) {</span></span>
<span class="line"><span style="color:#ADBAC7;">    rabbitTemplate.</span><span style="color:#DCBDFB;">convertAndSend</span><span style="color:#ADBAC7;">(DELAYED_EXCHANGE_NAME, DELAYED_ROUTING_KEY, message,correlationData </span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;">{</span></span>
<span class="line"><span style="color:#ADBAC7;">        correlationData.</span><span style="color:#DCBDFB;">getMessageProperties</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">setDelay</span><span style="color:#ADBAC7;">(delayTime);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> correlationData;</span></span>
<span class="line"><span style="color:#ADBAC7;">    });</span></span>
<span class="line"><span style="color:#ADBAC7;">    log.</span><span style="color:#DCBDFB;">info</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot; 当 前 时 间 ： {}, 发 送 一 条 延 迟 {} 毫 秒 的 信 息 给 队 列 delayed.queue:{}&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">Date</span><span style="color:#ADBAC7;">(),delayTime, message);</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 消费者</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">DELAYED_QUEUE_NAME</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;delayed.queue&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">RabbitListener</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">queues</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> DELAYED_QUEUE_NAME)</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">receiveDelayedQueue</span><span style="color:#ADBAC7;">(Message message){ </span></span>
<span class="line"><span style="color:#ADBAC7;">    String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">msg</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(message.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">    log.</span><span style="color:#DCBDFB;">info</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;当前时间：{},收到延时队列的消息：{}&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">Date</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">toString</span><span style="color:#ADBAC7;">(), msg);</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 配置文件</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Configuration</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DelayedQueueConfig</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String DELAYED_QUEUE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;delayed.queue&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String DELAYED_EXCHANGE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;delayed.exchange&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String DELAYED_ROUTING_KEY </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;delayed.routingkey&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Queue </span><span style="color:#6F42C1;">delayedQueue</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Queue</span><span style="color:#24292E;">(DELAYED_QUEUE_NAME);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//自定义交换机 我们在这里定义的是一个延迟交换机</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> CustomExchange </span><span style="color:#6F42C1;">delayedExchange</span><span style="color:#24292E;">(){ </span></span>
<span class="line"><span style="color:#24292E;">        Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//自定义交换机的类型</span></span>
<span class="line"><span style="color:#24292E;">        args.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-delayed-type&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;direct&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CustomExchange</span><span style="color:#24292E;">(DELAYED_EXCHANGE_NAME, </span><span style="color:#032F62;">&quot;x-delayed-message&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, args);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Binding </span><span style="color:#6F42C1;">bindingDelayedQueue</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">Qualifier</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;delayedQueue&quot;</span><span style="color:#24292E;">) Queue </span><span style="color:#E36209;">queue</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @</span><span style="color:#D73A49;">Qualifier</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;delayedExchange&quot;</span><span style="color:#24292E;">)CustomExchange </span><span style="color:#E36209;">delayedExchange</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">  BindingBuilder.</span><span style="color:#6F42C1;">bind</span><span style="color:#24292E;">(queue).</span><span style="color:#6F42C1;">to</span><span style="color:#24292E;">(delayedExchange).</span><span style="color:#6F42C1;">with</span><span style="color:#24292E;">(DELAYED_ROUTING_KEY).</span><span style="color:#6F42C1;">noargs</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 生产者</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String DELAYED_EXCHANGE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;delayed.exchange&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String DELAYED_ROUTING_KEY </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;delayed.routingkey&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">GetMapping</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;sendDelayMsg/{message}/{delayTime}&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sendMsg</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">PathVariable</span><span style="color:#24292E;"> String message,@</span><span style="color:#D73A49;">PathVariable</span><span style="color:#24292E;"> Integer delayTime) {</span></span>
<span class="line"><span style="color:#24292E;">    rabbitTemplate.</span><span style="color:#6F42C1;">convertAndSend</span><span style="color:#24292E;">(DELAYED_EXCHANGE_NAME, DELAYED_ROUTING_KEY, message,correlationData </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">        correlationData.</span><span style="color:#6F42C1;">getMessageProperties</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">setDelay</span><span style="color:#24292E;">(delayTime);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> correlationData;</span></span>
<span class="line"><span style="color:#24292E;">    });</span></span>
<span class="line"><span style="color:#24292E;">    log.</span><span style="color:#6F42C1;">info</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot; 当 前 时 间 ： {}, 发 送 一 条 延 迟 {} 毫 秒 的 信 息 给 队 列 delayed.queue:{}&quot;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Date</span><span style="color:#24292E;">(),delayTime, message);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 消费者</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String DELAYED_QUEUE_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;delayed.queue&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">RabbitListener</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">queues</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> DELAYED_QUEUE_NAME)</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">receiveDelayedQueue</span><span style="color:#24292E;">(Message message){ </span></span>
<span class="line"><span style="color:#24292E;">    String msg </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(message.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">    log.</span><span style="color:#6F42C1;">info</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;当前时间：{},收到延时队列的消息：{}&quot;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Date</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">toString</span><span style="color:#24292E;">(), msg);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="优先级队列" tabindex="-1">优先级队列 <a class="header-anchor" href="#优先级队列" aria-label="Permalink to &quot;优先级队列&quot;">​</a></h2><p>  要让队列实现优先级需要做的事情有如下事情:队列需要设置为优先级队列，消息需要设置消息的优先级，消费者需要等待消息已经发送到队列中才去消费因为，这样才有机会对消息进行排序。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 生产者</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Producer</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">QUEUE_NAME</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;hello&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">args</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> (Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitMqUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//给消息赋予一个 priority 属性</span></span>
<span class="line"><span style="color:#ADBAC7;">            AMQP</span><span style="color:#F69D50;">.</span><span style="color:#ADBAC7;">BasicProperties</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">properties</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> AMQP.</span><span style="color:#DCBDFB;">BasicProperties</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">builder</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">priority</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">5</span><span style="color:#ADBAC7;">).</span><span style="color:#DCBDFB;">build</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;"> (</span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">; i </span><span style="color:#F47067;">&lt;</span><span style="color:#6CB6FF;">11</span><span style="color:#ADBAC7;">; i</span><span style="color:#F47067;">++</span><span style="color:#ADBAC7;">){ </span></span>
<span class="line"><span style="color:#ADBAC7;">                String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">message</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;info&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">i;</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;">(i</span><span style="color:#F47067;">==</span><span style="color:#6CB6FF;">5</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">                    channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">, QUEUE_NAME, properties, message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">                }</span><span style="color:#F47067;">else</span><span style="color:#ADBAC7;">{</span></span>
<span class="line"><span style="color:#ADBAC7;">                    channel.</span><span style="color:#DCBDFB;">basicPublish</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">, QUEUE_NAME, </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">, message.</span><span style="color:#DCBDFB;">getBytes</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">                }</span></span>
<span class="line"><span style="color:#ADBAC7;">                System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;发送消息完成:&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> message);</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 消费者</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Consumer</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">final</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">QUEUE_NAME</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;hello&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">args</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> Exception{ </span></span>
<span class="line"><span style="color:#ADBAC7;">        Channel</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">channel</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> RabbitMqUtils.</span><span style="color:#DCBDFB;">getChannel</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">// 设置队列的最大优先级 最大可以设置到 255 官网推荐 1-10 如果设置太高比较吃内存和 CPU</span></span>
<span class="line"><span style="color:#ADBAC7;">        Map</span><span style="color:#F69D50;">&lt;</span><span style="color:#F47067;">String</span><span style="color:#F69D50;">, </span><span style="color:#F47067;">Object</span><span style="color:#F69D50;">&gt; </span><span style="color:#ADBAC7;">params</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">HashMap</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        params.</span><span style="color:#DCBDFB;">put</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;x-max-priority&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">10</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">queueDeclare</span><span style="color:#ADBAC7;">(QUEUE_NAME, </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">, params);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消费者启动等待消费 .............. &quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        DeliverCallback</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">deliverCallback</span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;">(consumerTag, delivery)</span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;">{ </span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">receivedMessage</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">String</span><span style="color:#ADBAC7;">(delivery.</span><span style="color:#DCBDFB;">getBody</span><span style="color:#ADBAC7;">()); </span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;接收到消息:&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">receivedMessage);</span></span>
<span class="line"><span style="color:#ADBAC7;">        };</span></span>
<span class="line"><span style="color:#ADBAC7;">        channel.</span><span style="color:#DCBDFB;">basicConsume</span><span style="color:#ADBAC7;">(QUEUE_NAME,</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">,deliverCallback,(consumerTag)</span><span style="color:#F47067;">-&gt;</span><span style="color:#ADBAC7;">{ </span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消费者无法消费消息时调用，如队列被删除&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        });</span></span>
<span class="line"><span style="color:#ADBAC7;">    }    </span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 生产者</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Producer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String QUEUE_NAME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;hello&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> (Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitMqUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//给消息赋予一个 priority 属性</span></span>
<span class="line"><span style="color:#24292E;">            AMQP.BasicProperties properties </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> AMQP.</span><span style="color:#6F42C1;">BasicProperties</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">builder</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">priority</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">).</span><span style="color:#6F42C1;">build</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#005CC5;">11</span><span style="color:#24292E;">; i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">){ </span></span>
<span class="line"><span style="color:#24292E;">                String message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">i;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(i</span><span style="color:#D73A49;">==</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">                    channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">, QUEUE_NAME, properties, message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">                }</span><span style="color:#D73A49;">else</span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">                    channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">, QUEUE_NAME, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, message.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;发送消息完成:&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> message);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 消费者</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Consumer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String QUEUE_NAME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;hello&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception{ </span></span>
<span class="line"><span style="color:#24292E;">        Channel channel </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> RabbitMqUtils.</span><span style="color:#6F42C1;">getChannel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 设置队列的最大优先级 最大可以设置到 255 官网推荐 1-10 如果设置太高比较吃内存和 CPU</span></span>
<span class="line"><span style="color:#24292E;">        Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; params </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">HashMap</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        params.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;x-max-priority&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(QUEUE_NAME, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, params);</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消费者启动等待消费 .............. &quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        DeliverCallback deliverCallback</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(consumerTag, delivery)</span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">{ </span></span>
<span class="line"><span style="color:#24292E;">            String receivedMessage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(delivery.</span><span style="color:#6F42C1;">getBody</span><span style="color:#24292E;">()); </span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;接收到消息:&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">receivedMessage);</span></span>
<span class="line"><span style="color:#24292E;">        };</span></span>
<span class="line"><span style="color:#24292E;">        channel.</span><span style="color:#6F42C1;">basicConsume</span><span style="color:#24292E;">(QUEUE_NAME,</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,deliverCallback,(consumerTag)</span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">{ </span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消费者无法消费消息时调用，如队列被删除&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        });</span></span>
<span class="line"><span style="color:#24292E;">    }    </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="集群" tabindex="-1">集群 <a class="header-anchor" href="#集群" aria-label="Permalink to &quot;集群&quot;">​</a></h2><p>  集群配置</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;"># 1、配置各个节点的 hosts 文件，让各个节点都能互相识别对方</span></span>
<span class="line"><span style="color:#F47067;">&gt;</span><span style="color:#ADBAC7;"> vim /etc/hosts</span></span>
<span class="line"><span style="color:#F69D50;">10.211.55.74</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">node1</span></span>
<span class="line"><span style="color:#F69D50;">10.211.55.75</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">node2</span></span>
<span class="line"><span style="color:#F69D50;">10.211.55.76</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">node3</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#768390;"># 2、确保各个节点的 cookie 文件使用的是同一个值</span></span>
<span class="line"><span style="color:#768390;"># 在 node1 上执行远程操作命令</span></span>
<span class="line"><span style="color:#F69D50;">scp</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">/var/lib/rabbitmq/.erlang.cookie</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">root@node2:/var/lib/rabbitmq/.erlang.cookie</span></span>
<span class="line"><span style="color:#F69D50;">scp</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">/var/lib/rabbitmq/.erlang.cookie</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">root@node3:/var/lib/rabbitmq/.erlang.cookie</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;"># 3、启动 RabbitMQ 服务,顺带启动 Erlang 虚拟机和 RbbitMQ 应用服务(在三台节点上分别执行以下命令)</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmq-server</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">-detached</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;"># 4、在节点 2 执行</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">stop_app</span><span style="color:#ADBAC7;">  </span><span style="color:#768390;"># rabbitmqctl stop 会将Erlang 虚拟机关闭，rabbitmqctl stop_app 只关闭 RabbitMQ 服务</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">reset</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">join_cluster</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">rabbit@node1</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">start_app</span><span style="color:#ADBAC7;"> </span><span style="color:#768390;"># 只启动应用服务</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;"># 5、在节点 3 执行</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">stop_app</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">reset</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">join_cluster</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">rabbit@node2</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">start_app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;"># 6、集群状态</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">cluster_status</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;"># 7、重新设置用户</span></span>
<span class="line"><span style="color:#768390;"># 7.1、创建账号</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">add_user</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">admin</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">123</span></span>
<span class="line"><span style="color:#768390;"># 7.2、设置用户角色</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">set_user_tags</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">admin</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">administrator</span></span>
<span class="line"><span style="color:#768390;"># 7.3、设置用户权限</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">set_permissions</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">-p</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;/&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">admin</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;.*&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;.*&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;.*&quot;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#768390;"># 8、解除集群节点(node2 和 node3 机器分别执行)</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">stop_app</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">reset</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">start_app</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">cluster_status</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;"># node1 机器上执行</span></span>
<span class="line"><span style="color:#F69D50;">rabbitmqctl</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">forget_cluster_node</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">rabbit@node2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 1、配置各个节点的 hosts 文件，让各个节点都能互相识别对方</span></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> vim /etc/hosts</span></span>
<span class="line"><span style="color:#6F42C1;">10.211.55.74</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node1</span></span>
<span class="line"><span style="color:#6F42C1;">10.211.55.75</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node2</span></span>
<span class="line"><span style="color:#6F42C1;">10.211.55.76</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node3</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;"># 2、确保各个节点的 cookie 文件使用的是同一个值</span></span>
<span class="line"><span style="color:#6A737D;"># 在 node1 上执行远程操作命令</span></span>
<span class="line"><span style="color:#6F42C1;">scp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/rabbitmq/.erlang.cookie</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root@node2:/var/lib/rabbitmq/.erlang.cookie</span></span>
<span class="line"><span style="color:#6F42C1;">scp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/rabbitmq/.erlang.cookie</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root@node3:/var/lib/rabbitmq/.erlang.cookie</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 3、启动 RabbitMQ 服务,顺带启动 Erlang 虚拟机和 RbbitMQ 应用服务(在三台节点上分别执行以下命令)</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmq-server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-detached</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 4、在节点 2 执行</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop_app</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># rabbitmqctl stop 会将Erlang 虚拟机关闭，rabbitmqctl stop_app 只关闭 RabbitMQ 服务</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reset</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join_cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbit@node1</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start_app</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 只启动应用服务</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 5、在节点 3 执行</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop_app</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reset</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join_cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbit@node2</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start_app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 6、集群状态</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster_status</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 7、重新设置用户</span></span>
<span class="line"><span style="color:#6A737D;"># 7.1、创建账号</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">add_user</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">123</span></span>
<span class="line"><span style="color:#6A737D;"># 7.2、设置用户角色</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set_user_tags</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin</span><span style="color:#24292E;"> </span><span style="color:#032F62;">administrator</span></span>
<span class="line"><span style="color:#6A737D;"># 7.3、设置用户权限</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set_permissions</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.*&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.*&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.*&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;"># 8、解除集群节点(node2 和 node3 机器分别执行)</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop_app</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reset</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start_app</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster_status</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># node1 机器上执行</span></span>
<span class="line"><span style="color:#6F42C1;">rabbitmqctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">forget_cluster_node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbit@node2</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-462c643b data-v-f6bde3e6><!--[--><!--]--><div class="edit-info" data-v-f6bde3e6><!----><div class="last-updated" data-v-f6bde3e6><p class="VPLastUpdated" data-v-f6bde3e6 data-v-cfcf869c>最后更新: <time datetime="2023-08-26T10:08:35.000Z" data-v-cfcf869c></time></p></div></div><div class="prev-next" data-v-f6bde3e6><div class="pager" data-v-f6bde3e6><a class="pager-link prev" href="/charles-blog/md/middleware/Nginx.html" data-v-f6bde3e6><span class="desc" data-v-f6bde3e6>上一篇</span><span class="title" data-v-f6bde3e6>Nginx</span></a></div><div class="has-prev pager" data-v-f6bde3e6><a class="pager-link next" href="/charles-blog/md/middleware/Zookeeper.html" data-v-f6bde3e6><span class="desc" data-v-f6bde3e6>下一篇</span><span class="title" data-v-f6bde3e6>Zookeeper</span></a></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"md_test_lin_index.md\":\"706ea71f\",\"md_test_index.md\":\"a179ba4f\",\"index.md\":\"4503a516\",\"md_about_index.md\":\"4984c4d8\",\"md_java_javaunderlayer_hash.md\":\"e1bfbdd6\",\"md_java_javaunderlayer_gc.md\":\"8b102f85\",\"md_database_cache.md\":\"ee1e9375\",\"md_test_zhu_index.md\":\"2c99a562\",\"md_test_child1.md\":\"6f9aed24\",\"md_database_index.md\":\"8ef353e5\",\"md_distributed_index.md\":\"85eafa6b\",\"md_environment_docker.md\":\"6d9d0c36\",\"md_distributed_singlesignon.md\":\"e9469380\",\"md_environment_linux.md\":\"9e61f6d8\",\"md_java_javaunderlayer_memoryleak.md\":\"0d57ac68\",\"md_environment_index.md\":\"4e1f2168\",\"md_java_javaunderlayer_jvm.md\":\"4a6ccd9b\",\"md_database_mongodb.md\":\"ed78548e\",\"md_java_javaunderlayer_classloader.md\":\"a28e97d8\",\"md_java_javaother_javainterviewquestions.md\":\"e3e5f22f\",\"md_database_oracle.md\":\"7147de3e\",\"md_java_javaother_synchronized.md\":\"ee25ab08\",\"md_java_index.md\":\"8e3f7d5f\",\"md_environment_shell.md\":\"779c4602\",\"md_java_javaother_lock.md\":\"1b11e871\",\"md_java_javaother_regularexpression.md\":\"dbb63f3f\",\"md_database_redis.md\":\"2eb607ad\",\"md_java_javaother_thread.md\":\"2ad6e1e2\",\"md_java_javaother_java8.md\":\"98624343\",\"md_database_mysql.md\":\"c1f317d9\",\"md_database_elkstack.md\":\"ca5582c6\",\"md_java_javaother_designpatterns.md\":\"0858d58e\",\"md_java_javaweb_javaweb.md\":\"cc6cf75c\",\"md_java_mybatis_mybatis.md\":\"d9803a83\",\"md_java_spring_springannotations.md\":\"89640029\",\"md_java_mybatis_mybatisplus.md\":\"a46e638f\",\"md_java_spring_spring.md\":\"a80a4f49\",\"md_java_spring_springmvc.md\":\"d3ce0b21\",\"md_java_spring_springtransaction.md\":\"ef9c6d8a\",\"md_java_spring_springboot.md\":\"5bba519d\",\"md_middleware_activemq.md\":\"45ec1a9b\",\"md_middleware_nginx.md\":\"2bf5bd09\",\"md_middleware_index.md\":\"1c4b5f2c\",\"md_middleware_kafka.md\":\"3238de67\",\"md_middleware_arthas.md\":\"ed6d7630\",\"md_network_https.md\":\"1fbe42dd\",\"md_network_ip.md\":\"b8f18932\",\"md_network_loadbalance.md\":\"1714c06e\",\"md_network_mac.md\":\"992dbcbd\",\"md_network_model.md\":\"7a0f94c4\",\"md_network_networkdevices.md\":\"7a850f72\",\"md_network_tcp.md\":\"fcf7ac1f\",\"md_network_conversationtechnolog.md\":\"f21c82a7\",\"md_network_dns.md\":\"7a6bd009\",\"md_network_http.md\":\"fa7644b0\",\"md_network_index.md\":\"09603bc1\",\"md_middleware_jms.md\":\"ac6f5658\",\"md_middleware_zookeeper.md\":\"7a7e70a5\",\"md_middleware_rabbitmq.md\":\"17ee6046\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"小朱杂记\",\"description\":\"My Document\",\"base\":\"/charles-blog/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Java\",\"link\":\"/md/java/\",\"activeMatch\":\"/md/java/\"},{\"text\":\"数据库\",\"link\":\"/md/database/\",\"activeMatch\":\"/md/database/\"},{\"text\":\"中间件\",\"link\":\"/md/middleware/\",\"activeMatch\":\"/md/middleware/\"},{\"text\":\"网络\",\"link\":\"/md/network/\",\"activeMatch\":\"/md/network/\"},{\"text\":\"环境\",\"link\":\"/md/environment/\",\"activeMatch\":\"/md/environment/\"},{\"text\":\"分布式\",\"link\":\"/md/distributed/\",\"activeMatch\":\"/md/distributed/\"},{\"text\":\"关于我\",\"link\":\"/md/about/\"}],\"sidebar\":{\"/md/java/\":[{\"text\":\"Java\",\"link\":\"/md/java/\",\"items\":[{\"text\":\"Spring \",\"collapsed\":true,\"items\":[{\"text\":\"Spring杂叙\",\"link\":\"/md/java/spring/Spring\"},{\"text\":\"SpringMvc\",\"link\":\"/md/java/spring/SpringMVC\"},{\"text\":\"SpringBoot\",\"link\":\"/md/java/spring/SpringBoot\"},{\"text\":\"Spring事务\",\"link\":\"/md/java/spring/SpringTransaction\"},{\"text\":\"Spring注解\",\"link\":\"/md/java/spring/SpringAnnotations\"}]},{\"text\":\"Java底层\",\"collapsed\":true,\"items\":[{\"text\":\"JVM\",\"link\":\"/md/java/javaUnderlayer/JVM\"},{\"text\":\"GC\",\"link\":\"/md/java/javaUnderlayer/GC\"},{\"text\":\"内存泄漏\",\"link\":\"/md/java/javaUnderlayer/MemoryLeak\"},{\"text\":\"哈希(Hash)\",\"link\":\"/md/java/javaUnderlayer/Hash\"},{\"text\":\"类加载器\",\"link\":\"/md/java/javaUnderlayer/ClassLoader\"}]},{\"text\":\"JavaWeb\",\"collapsed\":true,\"items\":[{\"text\":\"JavaWeb杂叙\",\"link\":\"/md/java/javaWeb/JavaWeb\"}]},{\"text\":\"Java其他\",\"collapsed\":true,\"items\":[{\"text\":\"Java8\",\"link\":\"/md/java/javaOther/Java8\"},{\"text\":\"锁\",\"link\":\"/md/java/javaOther/Lock\"},{\"text\":\"Synchronized\",\"link\":\"/md/java/javaOther/Synchronized\"},{\"text\":\"浅谈设计模式\",\"link\":\"/md/java/javaOther/DesignPatterns\"},{\"text\":\"进程，线程，线程池，调度\",\"link\":\"/md/java/javaOther/Thread\"},{\"text\":\"正则表达式\",\"link\":\"/md/java/javaOther/RegularExpression\"},{\"text\":\"Java面试题\",\"link\":\"/md/java/javaOther/JavaInterviewQuestions\"}]},{\"text\":\"Mybatis\",\"collapsed\":true,\"items\":[{\"text\":\"Mybatis杂叙\",\"link\":\"/md/java/mybatis/Mybatis\"},{\"text\":\"Mybatis-Plus\",\"link\":\"/md/java/mybatis/MybatisPlus\"}]}]}],\"/md/database/\":[{\"text\":\"数据库\",\"link\":\"/md/database/\",\"items\":[{\"text\":\"MySQL\",\"link\":\"/md/database/Mysql\"},{\"text\":\"Oracle\",\"link\":\"/md/database/Oracle\"},{\"text\":\"Redis\",\"link\":\"/md/database/Redis\"},{\"text\":\"ELK Stack\",\"link\":\"/md/database/ElkStack\"},{\"text\":\"MongoDB\",\"link\":\"/md/database/MongoDB\"},{\"text\":\"缓存\",\"link\":\"/md/database/Cache\"}]}],\"/md/network/\":[{\"text\":\"网络\",\"link\":\"/md/network/\",\"items\":[{\"text\":\"网络模型\",\"link\":\"/md/network/Model\"},{\"text\":\"HTTP\",\"link\":\"/md/network/Http\"},{\"text\":\"HTTPS\",\"link\":\"/md/network/Https\"},{\"text\":\"TCP\",\"link\":\"/md/network/Tcp\"},{\"text\":\"IP\",\"link\":\"/md/network/Ip\"},{\"text\":\"MAC\",\"link\":\"/md/network/Mac\"},{\"text\":\"DNS\",\"link\":\"/md/network/Dns\"},{\"text\":\"会话技术\",\"link\":\"/md/network/ConversationTechnolog\"},{\"text\":\"常见的网络设备\",\"link\":\"/md/network/NetworkDevices\"},{\"text\":\"负载均衡\",\"link\":\"/md/network/LoadBalance\"}]}],\"/md/environment/\":[{\"text\":\"环境\",\"link\":\"/md/environment/\",\"items\":[{\"text\":\"Linux\",\"link\":\"/md/environment/Linux\"},{\"text\":\"Shell\",\"link\":\"/md/environment/Shell\"},{\"text\":\"Docker\",\"link\":\"/md/environment/Docker\"}]}],\"/md/distributed/\":[{\"text\":\"分布式\",\"items\":[{\"text\":\"单点登陆\",\"link\":\"/md/distributed/SingleSignOn\"},{\"text\":\"分布式系统\",\"link\":\"/md/distributed/\"}]}],\"/md/middleware/\":[{\"text\":\"中间件\",\"link\":\"/md/middleware/\",\"items\":[{\"text\":\"Nginx\",\"link\":\"/md/middleware/Nginx\"},{\"text\":\"RabbitMQ\",\"link\":\"/md/middleware/Rabbitmq\"},{\"text\":\"Zookeeper\",\"link\":\"/md/middleware/Zookeeper\"},{\"text\":\"Arthas\",\"link\":\"/md/middleware/Arthas\"},{\"text\":\"JMS\",\"link\":\"/md/middleware/Jms\"},{\"text\":\"ActiveMQ\",\"link\":\"/md/middleware/ActiveMq\"},{\"text\":\"Kafka\",\"link\":\"/md/middleware/Kafka\"}]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/CharleZhuJJ/charles-blog\"}],\"outline\":{\"level\":\"deep\",\"label\":\"目录\"},\"darkModeSwitchLabel\":\"切换日光/暗黑模式\",\"sidebarMenuLabel\":\"文章\",\"returnToTopLabel\":\"返回顶部\",\"lastUpdatedText\":\"最后更新\",\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"search\":{\"provider\":\"local\"}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>