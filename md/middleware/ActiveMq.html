<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ActiveMQ | 小朱杂记</title>
    <meta name="description" content="My Document">
    <link rel="preload stylesheet" href="/charles-blog/assets/style.ae2285a1.css" as="style">
    <script type="module" src="/charles-blog/assets/app.271f994f.js"></script>
    <link rel="preload" href="/charles-blog/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/charles-blog/assets/chunks/framework.981adca9.js">
  <link rel="modulepreload" href="/charles-blog/assets/chunks/theme.39e5fc6f.js">
  <link rel="modulepreload" href="/charles-blog/assets/chunks/ArticleMetadata.8b6b367a.js">
  <link rel="modulepreload" href="/charles-blog/assets/md_middleware_ActiveMq.md.45ec1a9b.lean.js">
  <link rel="icon" href="/charles-blog/favicon.ico">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-fc105c82><!--[--><!--]--><!--[--><span tabindex="-1" data-v-827f7975></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-827f7975> Skip to content </a><!--]--><!----><header class="VPNav" data-v-fc105c82 data-v-4765fb17><div class="VPNavBar has-sidebar" data-v-4765fb17 data-v-c560f0cd><div class="container" data-v-c560f0cd><div class="title" data-v-c560f0cd><div class="VPNavBarTitle has-sidebar" data-v-c560f0cd data-v-ebec4beb><a class="title" href="/charles-blog/" data-v-ebec4beb><!--[--><!--]--><!----><!--[-->小朱杂记<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-c560f0cd><div class="curtain" data-v-c560f0cd></div><div class="content-body" data-v-c560f0cd><!--[--><!--]--><div class="VPNavBarSearch search" style="--vp-meta-key:&#39;Meta&#39;;" data-v-c560f0cd><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-c560f0cd data-v-8a05be25><span id="main-nav-aria-label" class="visually-hidden" data-v-8a05be25>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/java/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->Java<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/database/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->数据库<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/charles-blog/md/middleware/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->中间件<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/network/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->网络<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/environment/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->环境<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/distributed/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->分布式<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/charles-blog/md/about/" tabindex="0" data-v-8a05be25 data-v-f5f69d10 data-v-a8e5736d><!--[-->关于我<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-c560f0cd data-v-7489216d><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-7489216d data-v-c852f474 data-v-43044c5b><span class="check" data-v-43044c5b><span class="icon" data-v-43044c5b><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-c852f474><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-c852f474><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-c560f0cd data-v-46915da0 data-v-5e7b6306><!--[--><a class="VPSocialLink" href="https://github.com/CharleZhuJJ/charles-blog" aria-label="github" target="_blank" rel="noopener" data-v-5e7b6306 data-v-5124df20><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-c560f0cd data-v-0f46c100 data-v-fa61944e><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-fa61944e><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-fa61944e><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-fa61944e><div class="VPMenu" data-v-fa61944e data-v-4eba600d><!----><!--[--><!--[--><!----><div class="group" data-v-0f46c100><div class="item appearance" data-v-0f46c100><p class="label" data-v-0f46c100>切换日光/暗黑模式</p><div class="appearance-action" data-v-0f46c100><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-0f46c100 data-v-c852f474 data-v-43044c5b><span class="check" data-v-43044c5b><span class="icon" data-v-43044c5b><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-c852f474><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-c852f474><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-0f46c100><div class="item social-links" data-v-0f46c100><div class="VPSocialLinks social-links-list" data-v-0f46c100 data-v-5e7b6306><!--[--><a class="VPSocialLink" href="https://github.com/CharleZhuJJ/charles-blog" aria-label="github" target="_blank" rel="noopener" data-v-5e7b6306 data-v-5124df20><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-c560f0cd data-v-05cc2436><span class="container" data-v-05cc2436><span class="top" data-v-05cc2436></span><span class="middle" data-v-05cc2436></span><span class="bottom" data-v-05cc2436></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-fc105c82 data-v-c9d1ee7c><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-c9d1ee7c><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-c9d1ee7c><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-c9d1ee7c>文章</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-c9d1ee7c data-v-43a3820c><button data-v-43a3820c>返回顶部</button><!----></div></div><aside class="VPSidebar" data-v-fc105c82 data-v-def99251><div class="curtain" data-v-def99251></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-def99251><span class="visually-hidden" id="sidebar-aria-label" data-v-def99251> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-def99251><section class="VPSidebarItem level-0 is-link has-active" data-v-def99251 data-v-94aa024f><div class="item" tabindex="0" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/" data-v-94aa024f data-v-a8e5736d><!--[--><h2 class="text" data-v-94aa024f>中间件</h2><!--]--><!----></a><!----></div><div class="items" data-v-94aa024f><!--[--><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Nginx.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>Nginx</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Rabbitmq.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>RabbitMQ</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Zookeeper.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>Zookeeper</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Arthas.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>Arthas</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Jms.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>JMS</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link is-active has-active" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/ActiveMq.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>ActiveMQ</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-94aa024f data-v-94aa024f><div class="item" data-v-94aa024f><div class="indicator" data-v-94aa024f></div><a class="VPLink link link" href="/charles-blog/md/middleware/Kafka.html" data-v-94aa024f data-v-a8e5736d><!--[--><p class="text" data-v-94aa024f>Kafka</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-fc105c82 data-v-6c89610d><div class="VPDoc has-sidebar has-aside" data-v-6c89610d data-v-462c643b><!--[--><!--]--><div class="container" data-v-462c643b><div class="aside" data-v-462c643b><div class="aside-curtain" data-v-462c643b></div><div class="aside-container" data-v-462c643b><div class="aside-content" data-v-462c643b><div class="VPDocAside" data-v-462c643b data-v-eda16060><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-eda16060 data-v-5a905545><div class="content" data-v-5a905545><div class="outline-marker" data-v-5a905545></div><div class="outline-title" data-v-5a905545>目录</div><nav aria-labelledby="doc-outline-aria-label" data-v-5a905545><span class="visually-hidden" id="doc-outline-aria-label" data-v-5a905545> Table of Contents for current page </span><ul class="root" data-v-5a905545 data-v-ce114d19><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-eda16060></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-462c643b><div class="content-container" data-v-462c643b><!--[--><!--]--><!----><main class="main" data-v-462c643b><div style="position:relative;" class="vp-doc _charles-blog_md_middleware_ActiveMq" data-v-462c643b><div><h1 id="activemq" tabindex="-1">ActiveMQ <a class="header-anchor" href="#activemq" aria-label="Permalink to &quot;ActiveMQ&quot;">​</a></h1><!----><p>  Apache ActiveMQ是Apache软件基金会所研发的开放源代码消息中间件；由于ActiveMQ是一个纯Java程序，因此只需要操作系统支持Java虚拟机，ActiveMQ便可执行。</p><h2 id="消息持久化" tabindex="-1">消息持久化 <a class="header-anchor" href="#消息持久化" aria-label="Permalink to &quot;消息持久化&quot;">​</a></h2><p>  ActiveMQ提供了以下三种的消息存储方式：</p><ol><li>Memory 消息存储-基于内存的消息存储。</li><li>基于日志消息存储方式，KahaDB是ActiveMQ的默认日志存储方式，它提供了容量的提升和恢复能力。</li><li>基于JDBC的消息存储方式-数据存储于数据库（例如：MySQL）中。</li></ol><h3 id="activemq持久化机制流程图" tabindex="-1">ActiveMQ持久化机制流程图 <a class="header-anchor" href="#activemq持久化机制流程图" aria-label="Permalink to &quot;ActiveMQ持久化机制流程图&quot;">​</a></h3><p><img src="/charles-blog/assets/Persistence.9985f8c2.png" alt="Persistence"></p><h3 id="基于jdbc的消息持久化实现" tabindex="-1">基于jdbc的消息持久化实现 <a class="header-anchor" href="#基于jdbc的消息持久化实现" aria-label="Permalink to &quot;基于jdbc的消息持久化实现&quot;">​</a></h3><ol><li>application.yml</li></ol><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#8DDB8C;">server</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">port</span><span style="color:#ADBAC7;">: </span><span style="color:#6CB6FF;">9001</span></span>
<span class="line"><span style="color:#8DDB8C;">spring</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">activemq</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#8DDB8C;">broker-url</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">tcp://192.168.66.133:61616</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#8DDB8C;">user</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">admin</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#8DDB8C;">password</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">admin</span></span>
<span class="line"><span style="color:#8DDB8C;">jms</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">pub-sub-domain</span><span style="color:#ADBAC7;">: </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;"> </span><span style="color:#768390;"># false：点对点队列模式， true：发布/订阅模式</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">template</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#8DDB8C;">delivery-mode</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">persistent</span><span style="color:#ADBAC7;"> </span><span style="color:#768390;"># 持久化</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#8DDB8C;">activemq</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">name</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">springboot-queue01</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">server</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9001</span></span>
<span class="line"><span style="color:#22863A;">spring</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">activemq</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">broker-url</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tcp://192.168.66.133:61616</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">user</span><span style="color:#24292E;">: </span><span style="color:#032F62;">admin</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">password</span><span style="color:#24292E;">: </span><span style="color:#032F62;">admin</span></span>
<span class="line"><span style="color:#22863A;">jms</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">pub-sub-domain</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># false：点对点队列模式， true：发布/订阅模式</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">delivery-mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">persistent</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 持久化</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#22863A;">activemq</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">springboot-queue01</span></span></code></pre></div><ol start="2"><li>activemq.xml</li></ol><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">&lt;!--配置数据库连接池--&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;</span><span style="color:#8DDB8C;">bean</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">name</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;mysql-ds&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">class</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">destroy-method</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;close&quot;</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">property</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">name</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;driverClassName&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">value</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;com.mysql.jdbc.Driver&quot;</span><span style="color:#ADBAC7;"> /&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">property</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">name</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;url&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">value</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;jdbc:mysql://192.168.66.133:3306/db_activemq&quot;</span><span style="color:#ADBAC7;"> /&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">property</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">name</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;username&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">value</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;root&quot;</span><span style="color:#ADBAC7;"> /&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">property</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">name</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;password&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">value</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;123456&quot;</span><span style="color:#ADBAC7;">/&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;/</span><span style="color:#8DDB8C;">bean</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">&lt;!--JDBC Jdbc用于master/slave模式的数据库分享 --&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;</span><span style="color:#8DDB8C;">persistenceAdapter</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">jdbcPersistenceAdapter</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">dataSource</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;#mysql-ds&quot;</span><span style="color:#ADBAC7;">/&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;/</span><span style="color:#8DDB8C;">persistenceAdapter</span><span style="color:#ADBAC7;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">&lt;!--配置数据库连接池--&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">bean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;mysql-ds&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">class</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">destroy-method</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;close&quot;</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">property</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;driverClassName&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;com.mysql.jdbc.Driver&quot;</span><span style="color:#24292E;"> /&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">property</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;url&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;jdbc:mysql://192.168.66.133:3306/db_activemq&quot;</span><span style="color:#24292E;"> /&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">property</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;username&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;root&quot;</span><span style="color:#24292E;"> /&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">property</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;password&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;123456&quot;</span><span style="color:#24292E;">/&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">bean</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">&lt;!--JDBC Jdbc用于master/slave模式的数据库分享 --&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">persistenceAdapter</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">jdbcPersistenceAdapter</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">dataSource</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;#mysql-ds&quot;</span><span style="color:#24292E;">/&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">persistenceAdapter</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><ol start="3"><li>拷贝mysql及durid数据源的jar包到activemq的lib目录下</li><li>重启activemq</li></ol><h2 id="消息事务" tabindex="-1">消息事务 <a class="header-anchor" href="#消息事务" aria-label="Permalink to &quot;消息事务&quot;">​</a></h2><p>  消息事务，是保证消息传递原子性的一个重要特征，和JDBC的事务特征类似。</p><p>  一个事务性发送，其中一组消息要么能够全部保证到达服务器，要么都不到达服务器。</p><p>  生产者、消费者与消息服务器直接都支持事务性；ActionMQ的事务主要偏向在生产者的应用。</p><p><img src="/charles-blog/assets/Transaction.8aa289ff.png" alt="Transaction"></p><h3 id="生产者事务-一" tabindex="-1">生产者事务（一） <a class="header-anchor" href="#生产者事务-一" aria-label="Permalink to &quot;生产者事务（一）&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">sendMessageTx</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">    ConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> jmsMessagingTemplate.</span><span style="color:#DCBDFB;">getConnectionFactory</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    Session</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">session</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Connection</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connection</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connectionFactory.</span><span style="color:#DCBDFB;">createConnection</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">        * 参数一：是否开启消息事务</span></span>
<span class="line"><span style="color:#768390;">        */</span></span>
<span class="line"><span style="color:#ADBAC7;">        session </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connection.</span><span style="color:#DCBDFB;">createSession</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">        MessageProducer</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">producer</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;">  session.</span><span style="color:#DCBDFB;">createProducer</span><span style="color:#ADBAC7;">(session.</span><span style="color:#DCBDFB;">createQueue</span><span style="color:#ADBAC7;">(name));</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F47067;">=</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">;i</span><span style="color:#F47067;">&lt;=</span><span style="color:#6CB6FF;">10</span><span style="color:#ADBAC7;">;i</span><span style="color:#F47067;">++</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//模拟异常</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;">(i</span><span style="color:#F47067;">==</span><span style="color:#6CB6FF;">4</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">a</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">10</span><span style="color:#F47067;">/</span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">            TextMessage</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">textMessage</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createTextMessage</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息--&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">  i);</span></span>
<span class="line"><span style="color:#ADBAC7;">            producer.</span><span style="color:#DCBDFB;">send</span><span style="color:#ADBAC7;">(textMessage);</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//注意：一旦开启事务发送，那么就必须使用commit方法进行事务提交，否则消息无法到达MQ服务器</span></span>
<span class="line"><span style="color:#ADBAC7;">        session.</span><span style="color:#DCBDFB;">commit</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//消息事务回滚</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">            session.</span><span style="color:#DCBDFB;">rollback</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e1</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            e1.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sendMessageTx</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">    ConnectionFactory connectionFactory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> jmsMessagingTemplate.</span><span style="color:#6F42C1;">getConnectionFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    Session session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        Connection connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connectionFactory.</span><span style="color:#6F42C1;">createConnection</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">        * 参数一：是否开启消息事务</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#24292E;">        session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connection.</span><span style="color:#6F42C1;">createSession</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#24292E;">        MessageProducer producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  session.</span><span style="color:#6F42C1;">createProducer</span><span style="color:#24292E;">(session.</span><span style="color:#6F42C1;">createQueue</span><span style="color:#24292E;">(name));</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;i</span><span style="color:#D73A49;">&lt;=</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//模拟异常</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(i</span><span style="color:#D73A49;">==</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            TextMessage textMessage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createTextMessage</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息--&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;">  i);</span></span>
<span class="line"><span style="color:#24292E;">            producer.</span><span style="color:#6F42C1;">send</span><span style="color:#24292E;">(textMessage);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//注意：一旦开启事务发送，那么就必须使用commit方法进行事务提交，否则消息无法到达MQ服务器</span></span>
<span class="line"><span style="color:#24292E;">        session.</span><span style="color:#6F42C1;">commit</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//消息事务回滚</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            session.</span><span style="color:#6F42C1;">rollback</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e1</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            e1.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="生产者事务-二" tabindex="-1">生产者事务（二） <a class="header-anchor" href="#生产者事务-二" aria-label="Permalink to &quot;生产者事务（二）&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 配置类</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Configuration</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ActiveMqConfig</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> PlatformTransactionManager </span><span style="color:#DCBDFB;">transactionManager</span><span style="color:#ADBAC7;">(ConnectionFactory </span><span style="color:#F69D50;">connectionFactory</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">JmsTransactionManager</span><span style="color:#ADBAC7;">(connectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 业务类</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Service</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">MessageService</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Autowired</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> JmsMessagingTemplate</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">jmsMessagingTemplate;</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Value</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;${activemq.name}&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">name;</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Transactional</span><span style="color:#ADBAC7;"> </span><span style="color:#768390;">// 对消息发送加入事务管理（同时也对JDBC数据库的事务生效）</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">sendMessage</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F47067;">=</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">;i</span><span style="color:#F47067;">&lt;=</span><span style="color:#6CB6FF;">10</span><span style="color:#ADBAC7;">;i</span><span style="color:#F47067;">++</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//模拟异常</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;">(i</span><span style="color:#F47067;">==</span><span style="color:#6CB6FF;">4</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">a</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">10</span><span style="color:#F47067;">/</span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">        jmsMessagingTemplate.</span><span style="color:#DCBDFB;">convertAndSend</span><span style="color:#ADBAC7;">(name, </span><span style="color:#96D0FF;">&quot;消息---&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">i);</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 配置类</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Configuration</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ActiveMqConfig</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> PlatformTransactionManager </span><span style="color:#6F42C1;">transactionManager</span><span style="color:#24292E;">(ConnectionFactory </span><span style="color:#E36209;">connectionFactory</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JmsTransactionManager</span><span style="color:#24292E;">(connectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 业务类</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Service</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MessageService</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> JmsMessagingTemplate jmsMessagingTemplate;</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;${activemq.name}&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> String name;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Transactional</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 对消息发送加入事务管理（同时也对JDBC数据库的事务生效）</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sendMessage</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;i</span><span style="color:#D73A49;">&lt;=</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//模拟异常</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(i</span><span style="color:#D73A49;">==</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        jmsMessagingTemplate.</span><span style="color:#6F42C1;">convertAndSend</span><span style="color:#24292E;">(name, </span><span style="color:#032F62;">&quot;消息---&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">i);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="消费者事务" tabindex="-1">消费者事务 <a class="header-anchor" href="#消费者事务" aria-label="Permalink to &quot;消费者事务&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Component</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Consumer</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#768390;">    /**</span></span>
<span class="line"><span style="color:#768390;">    * 接收消息的方法</span></span>
<span class="line"><span style="color:#768390;">    */</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">JmsListener</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">destination</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;${activemq.name}&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">containerFactory</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">receiveMessage</span><span style="color:#ADBAC7;">(TextMessage </span><span style="color:#F69D50;">textMessage</span><span style="color:#ADBAC7;">,Session </span><span style="color:#F69D50;">session</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> JMSException {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息内容：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getText</span><span style="color:#ADBAC7;">() </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;,是否重发：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getJMSRedelivered</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">100</span><span style="color:#F47067;">/</span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">; </span><span style="color:#768390;">//模拟异常</span></span>
<span class="line"><span style="color:#ADBAC7;">            session.</span><span style="color:#DCBDFB;">commit</span><span style="color:#ADBAC7;">();</span><span style="color:#768390;">//提交事务</span></span>
<span class="line"><span style="color:#ADBAC7;">        } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">                session.</span><span style="color:#DCBDFB;">rollback</span><span style="color:#ADBAC7;">();</span><span style="color:#768390;">//回滚事务</span></span>
<span class="line"><span style="color:#ADBAC7;">            } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e1</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">            e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Component</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Consumer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#6A737D;">    /**</span></span>
<span class="line"><span style="color:#6A737D;">    * 接收消息的方法</span></span>
<span class="line"><span style="color:#6A737D;">    */</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">JmsListener</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">destination</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;${activemq.name}&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">containerFactory</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">receiveMessage</span><span style="color:#24292E;">(TextMessage </span><span style="color:#E36209;">textMessage</span><span style="color:#24292E;">,Session </span><span style="color:#E36209;">session</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> JMSException {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息内容：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getText</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;,是否重发：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getJMSRedelivered</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">//模拟异常</span></span>
<span class="line"><span style="color:#24292E;">            session.</span><span style="color:#6F42C1;">commit</span><span style="color:#24292E;">();</span><span style="color:#6A737D;">//提交事务</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                session.</span><span style="color:#6F42C1;">rollback</span><span style="color:#24292E;">();</span><span style="color:#6A737D;">//回滚事务</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e1</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="消息确认机制" tabindex="-1">消息确认机制 <a class="header-anchor" href="#消息确认机制" aria-label="Permalink to &quot;消息确认机制&quot;">​</a></h2><p>  JMS消息只有在被确认之后，才认为已经被成功地消费了。消息的成功消费通常包含三个阶段：客户接收消息、客户处理消息和消息被确认。在事务性会话中，当一个事务被提交的时候，确认自动发生。在非事务性会话中，消息何时被确认取决于创建会话时的应答模式（acknowledgement mode）。该参数有以下三个可选值：</p><table><thead><tr><th>值</th><th>描述</th></tr></thead><tbody><tr><td>Session.AUTO_ACKNOWLEDGE</td><td>当客户成功的从receive方法返回的时候，或者从MessageListener.onMessage方法成功返回的时候，会话自动确认客户收到的消息</td></tr><tr><td>Session.CLIENT_ACKNOWLEDGE</td><td>客户通过消息的acknowledge方法确认消息。需要注意的是，在这种模式中，确认是在会话层上进行：确认一个被消费的消息将自动确认所有已被会话消费的消息。例如，如果一个消息消费者消费了10个消息，然后确认第5个消息，那么所有10个消息都被确认</td></tr><tr><td>Session.DUPS_ACKNOWLEDGE</td><td>该选择只是会话迟钝确认消息的提交。如果JMS provider失败，那么可能会导致一些重复的消息。如果是重复的消息，那么JMS provider必须把消息头的MSRedelivered字段设置为true</td></tr></tbody></table><p>  注意：消息确认机制与事务机制是冲突的，只能选其中一种。所以演示消息确认前，先关闭事务。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 配置类</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Configuration</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ActiveMqConfig</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">name</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> DefaultJmsListenerContainerFactory </span><span style="color:#DCBDFB;">jmsListenerContainerFactory</span><span style="color:#ADBAC7;">(ConnectionFactory </span><span style="color:#F69D50;">connectionFactory</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">        DefaultJmsListenerContainerFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">factory</span><span style="color:#F47067;">=new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">DefaultJmsListenerContainerFactory</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setConnectionFactory</span><span style="color:#ADBAC7;">(connectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setSessionTransacted</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">); </span><span style="color:#768390;">// 不开启事务操作</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setSessionAcknowledgeMode</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">); </span><span style="color:#768390;">//自动确认</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">// factory.setSessionAcknowledgeMode(4); //手动确认</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> factory;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// auto_acknowledge 自动确认</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">JmsListener</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">destination</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;${activemq.name}&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">containerFactory</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">receiveMessage</span><span style="color:#ADBAC7;">(TextMessage textMessage){</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息内容：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getText</span><span style="color:#ADBAC7;">() </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;,是否重发：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getJMSRedelivered</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">throw</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">RuntimeException</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;test&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// client_acknowledge 手动确认</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">JmsListener</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">destination</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;${activemq.name}&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">containerFactory</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">receiveMessage</span><span style="color:#ADBAC7;">(TextMessage textMessage){</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息内容：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getText</span><span style="color:#ADBAC7;">() </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;,是否重发：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getJMSRedelivered</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">        textMessage.</span><span style="color:#DCBDFB;">acknowledge</span><span style="color:#ADBAC7;">(); </span><span style="color:#768390;">// 确认收到消息，一旦消息确认，消息不会重新发送</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">throw</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">RuntimeException</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;test&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 配置类</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Configuration</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ActiveMqConfig</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> DefaultJmsListenerContainerFactory </span><span style="color:#6F42C1;">jmsListenerContainerFactory</span><span style="color:#24292E;">(ConnectionFactory </span><span style="color:#E36209;">connectionFactory</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        DefaultJmsListenerContainerFactory factory</span><span style="color:#D73A49;">=new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DefaultJmsListenerContainerFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setConnectionFactory</span><span style="color:#24292E;">(connectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setSessionTransacted</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// 不开启事务操作</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setSessionAcknowledgeMode</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">//自动确认</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// factory.setSessionAcknowledgeMode(4); //手动确认</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> factory;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// auto_acknowledge 自动确认</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">JmsListener</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">destination</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;${activemq.name}&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">containerFactory</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">receiveMessage</span><span style="color:#24292E;">(TextMessage textMessage){</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息内容：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getText</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;,是否重发：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getJMSRedelivered</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RuntimeException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// client_acknowledge 手动确认</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">JmsListener</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">destination</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;${activemq.name}&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">containerFactory</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">receiveMessage</span><span style="color:#24292E;">(TextMessage textMessage){</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息内容：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getText</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;,是否重发：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getJMSRedelivered</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        textMessage.</span><span style="color:#6F42C1;">acknowledge</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 确认收到消息，一旦消息确认，消息不会重新发送</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RuntimeException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="消息投递方式" tabindex="-1">消息投递方式 <a class="header-anchor" href="#消息投递方式" aria-label="Permalink to &quot;消息投递方式&quot;">​</a></h2><h3 id="同步发送" tabindex="-1">同步发送 <a class="header-anchor" href="#同步发送" aria-label="Permalink to &quot;同步发送&quot;">​</a></h3><p>  消息生产者使用持久（Persistent）传递模式发送消息的时候，Producer.send() 方法会被阻塞，直到broker 发送一个确认消息给生产者(ProducerAck)，这个确认消息暗示broker已经成功接收到消息并把消息保存到二级存储中。</p><h3 id="异步发送" tabindex="-1">异步发送 <a class="header-anchor" href="#异步发送" aria-label="Permalink to &quot;异步发送&quot;">​</a></h3><p>  如果应用程序能够容忍一些消息的丢失，那么可以使用异步发送。异步发送不会在受到broker的确认之前一直阻塞 Producer.send方法。</p><p>  默认情况(alwaysSyncSend=false,useAsyncSend=false)，非持久化消息、事务内的消息均采用异步发送；对于持久化消息采用同步发送。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Configuration</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ActiveConfig</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#768390;">    /**</span></span>
<span class="line"><span style="color:#768390;">    * 配置用于异步发送的非持久化JmsTemplate</span></span>
<span class="line"><span style="color:#768390;">    */</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Autowired</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> JmsTemplate </span><span style="color:#DCBDFB;">asynJmsTemplate</span><span style="color:#ADBAC7;">(PooledConnectionFactory </span><span style="color:#F69D50;">pooledConnectionFactory</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        JmsTemplate</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">template</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">JmsTemplate</span><span style="color:#ADBAC7;">(pooledConnectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">        template.</span><span style="color:#DCBDFB;">setExplicitQosEnabled</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        template.</span><span style="color:#DCBDFB;">setDeliveryMode</span><span style="color:#ADBAC7;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> template;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#768390;">    /**</span></span>
<span class="line"><span style="color:#768390;">    * 配置用于同步发送的持久化JmsTemplate</span></span>
<span class="line"><span style="color:#768390;">    */</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Autowired</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> JmsTemplate </span><span style="color:#DCBDFB;">synJmsTemplate</span><span style="color:#ADBAC7;">(PooledConnectionFactory </span><span style="color:#F69D50;">pooledConnectionFactory</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        JmsTemplate</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">template</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">JmsTemplate</span><span style="color:#ADBAC7;">(pooledConnectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> template;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">* 异步投递，回调函数，以确认消息是否发送成功！</span></span>
<span class="line"><span style="color:#768390;">* </span><span style="color:#F47067;">@return</span></span>
<span class="line"><span style="color:#768390;">*/</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">RequestMapping</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;/send&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> String </span><span style="color:#DCBDFB;">sendQueue</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">    Connection</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connection</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    Session</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">session</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    ActiveMQMessageProducer</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">producer</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 获取连接工厂</span></span>
<span class="line"><span style="color:#ADBAC7;">    ConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> jmsMessagingTemplate.</span><span style="color:#DCBDFB;">getConnectionFactory</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">        connection </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connectionFactory.</span><span style="color:#DCBDFB;">createConnection</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        session </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connection.</span><span style="color:#DCBDFB;">createSession</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">        Queue</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queue</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createQueue</span><span style="color:#ADBAC7;">(name);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">count</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">10</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        producer </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createProducer</span><span style="color:#ADBAC7;">(queue);</span></span>
<span class="line"><span style="color:#ADBAC7;">        producer.</span><span style="color:#DCBDFB;">setDeliveryMode</span><span style="color:#ADBAC7;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">long</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">start</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> System.</span><span style="color:#DCBDFB;">currentTimeMillis</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;"> (</span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">; i </span><span style="color:#F47067;">&lt;</span><span style="color:#ADBAC7;"> count; i</span><span style="color:#F47067;">++</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//创建需要发送的消息</span></span>
<span class="line"><span style="color:#ADBAC7;">            TextMessage</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">textMessage</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createTextMessage</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;Hello&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//设置消息唯一ID</span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">msgid</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> UUID.</span><span style="color:#DCBDFB;">randomUUID</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">toString</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">            textMessage.</span><span style="color:#DCBDFB;">setJMSMessageID</span><span style="color:#ADBAC7;">(msgid);</span></span>
<span class="line"><span style="color:#ADBAC7;">            producer.</span><span style="color:#DCBDFB;">send</span><span style="color:#ADBAC7;">(textMessage, </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">AsyncCallback</span><span style="color:#ADBAC7;">() {</span></span>
<span class="line"><span style="color:#ADBAC7;">                @</span><span style="color:#F47067;">Override</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">onSuccess</span><span style="color:#ADBAC7;">() {</span></span>
<span class="line"><span style="color:#ADBAC7;">                    </span><span style="color:#768390;">// 使用msgid标识来进行消息发送成功的处理</span></span>
<span class="line"><span style="color:#ADBAC7;">                    System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(msgid</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot; 消息发送成功&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">                }</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span></span>
<span class="line"><span style="color:#ADBAC7;">                @</span><span style="color:#F47067;">Override</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">onException</span><span style="color:#ADBAC7;">(JMSException </span><span style="color:#F69D50;">exception</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">                    </span><span style="color:#768390;">// 使用msgid表示进行消息发送失败的处理</span></span>
<span class="line"><span style="color:#ADBAC7;">                    System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(msgid</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot; 消息发送失败&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">                    exception.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">                }</span></span>
<span class="line"><span style="color:#ADBAC7;">            });</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">        session.</span><span style="color:#DCBDFB;">commit</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (Exception </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;ok&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Configuration</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ActiveConfig</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#6A737D;">    /**</span></span>
<span class="line"><span style="color:#6A737D;">    * 配置用于异步发送的非持久化JmsTemplate</span></span>
<span class="line"><span style="color:#6A737D;">    */</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> JmsTemplate </span><span style="color:#6F42C1;">asynJmsTemplate</span><span style="color:#24292E;">(PooledConnectionFactory </span><span style="color:#E36209;">pooledConnectionFactory</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        JmsTemplate template </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JmsTemplate</span><span style="color:#24292E;">(pooledConnectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">        template.</span><span style="color:#6F42C1;">setExplicitQosEnabled</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        template.</span><span style="color:#6F42C1;">setDeliveryMode</span><span style="color:#24292E;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> template;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;">    /**</span></span>
<span class="line"><span style="color:#6A737D;">    * 配置用于同步发送的持久化JmsTemplate</span></span>
<span class="line"><span style="color:#6A737D;">    */</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> JmsTemplate </span><span style="color:#6F42C1;">synJmsTemplate</span><span style="color:#24292E;">(PooledConnectionFactory </span><span style="color:#E36209;">pooledConnectionFactory</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        JmsTemplate template </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JmsTemplate</span><span style="color:#24292E;">(pooledConnectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> template;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* 异步投递，回调函数，以确认消息是否发送成功！</span></span>
<span class="line"><span style="color:#6A737D;">* </span><span style="color:#D73A49;">@return</span></span>
<span class="line"><span style="color:#6A737D;">*/</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">RequestMapping</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/send&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> String </span><span style="color:#6F42C1;">sendQueue</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">    Connection connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    Session session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    ActiveMQMessageProducer producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取连接工厂</span></span>
<span class="line"><span style="color:#24292E;">    ConnectionFactory connectionFactory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> jmsMessagingTemplate.</span><span style="color:#6F42C1;">getConnectionFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connectionFactory.</span><span style="color:#6F42C1;">createConnection</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connection.</span><span style="color:#6F42C1;">createSession</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#24292E;">        Queue queue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createQueue</span><span style="color:#24292E;">(name);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> count </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createProducer</span><span style="color:#24292E;">(queue);</span></span>
<span class="line"><span style="color:#24292E;">        producer.</span><span style="color:#6F42C1;">setDeliveryMode</span><span style="color:#24292E;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> start </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> System.</span><span style="color:#6F42C1;">currentTimeMillis</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> count; i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//创建需要发送的消息</span></span>
<span class="line"><span style="color:#24292E;">            TextMessage textMessage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createTextMessage</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Hello&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//设置消息唯一ID</span></span>
<span class="line"><span style="color:#24292E;">            String msgid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> UUID.</span><span style="color:#6F42C1;">randomUUID</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">toString</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            textMessage.</span><span style="color:#6F42C1;">setJMSMessageID</span><span style="color:#24292E;">(msgid);</span></span>
<span class="line"><span style="color:#24292E;">            producer.</span><span style="color:#6F42C1;">send</span><span style="color:#24292E;">(textMessage, </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AsyncCallback</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">                @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">onSuccess</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 使用msgid标识来进行消息发送成功的处理</span></span>
<span class="line"><span style="color:#24292E;">                    System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(msgid</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot; 消息发送成功&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                </span></span>
<span class="line"><span style="color:#24292E;">                @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">onException</span><span style="color:#24292E;">(JMSException </span><span style="color:#E36209;">exception</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 使用msgid表示进行消息发送失败的处理</span></span>
<span class="line"><span style="color:#24292E;">                    System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(msgid</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot; 消息发送失败&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                    exception.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            });</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        session.</span><span style="color:#6F42C1;">commit</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Exception </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ok&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="延迟投递" tabindex="-1">延迟投递 <a class="header-anchor" href="#延迟投递" aria-label="Permalink to &quot;延迟投递&quot;">​</a></h3><p>  生产者提供两个发送消息的方法，一个是即时发送消息，一个是延时发送消息。</p><ol><li>修改activemq.xml</li></ol><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">&lt;</span><span style="color:#8DDB8C;">broker</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">xmlns</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;http://activemq.apache.org/schema/core&quot;</span><span style="color:#ADBAC7;"> ...</span></span>
<span class="line"><span style="color:#6CB6FF;">schedulerSupport</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;true&quot;</span><span style="color:#ADBAC7;"> &gt;  </span><span style="color:#768390;">&lt;!-- 添加schedulerSupport=&quot;true&quot;配置 --&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">......</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;/</span><span style="color:#8DDB8C;">broker</span><span style="color:#ADBAC7;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">broker</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">xmlns</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;http://activemq.apache.org/schema/core&quot;</span><span style="color:#24292E;"> ...</span></span>
<span class="line"><span style="color:#6F42C1;">schedulerSupport</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;"> &gt;  </span><span style="color:#6A737D;">&lt;!-- 添加schedulerSupport=&quot;true&quot;配置 --&gt;</span></span>
<span class="line"><span style="color:#24292E;">......</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">broker</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><ol start="2"><li>在代码中设置延迟时长</li></ol><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">* 延时投递</span></span>
<span class="line"><span style="color:#768390;">*/</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> String </span><span style="color:#DCBDFB;">sendQueue</span><span style="color:#ADBAC7;">() {</span></span>
<span class="line"><span style="color:#ADBAC7;">    Connection</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connection</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    Session</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">session</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    ActiveMQMessageProducer</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">producer</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 获取连接工厂</span></span>
<span class="line"><span style="color:#ADBAC7;">    ConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> jmsMessagingTemplate.</span><span style="color:#DCBDFB;">getConnectionFactory</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">        connection </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connectionFactory.</span><span style="color:#DCBDFB;">createConnection</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        session </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connection.</span><span style="color:#DCBDFB;">createSession</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">        Queue</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queue</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createQueue</span><span style="color:#ADBAC7;">(name);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">count</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">10</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        producer </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (ActiveMQMessageProducer) session.</span><span style="color:#DCBDFB;">createProducer</span><span style="color:#ADBAC7;">(queue);</span></span>
<span class="line"><span style="color:#ADBAC7;">        producer.</span><span style="color:#DCBDFB;">setDeliveryMode</span><span style="color:#ADBAC7;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//创建需要发送的消息</span></span>
<span class="line"><span style="color:#ADBAC7;">        TextMessage</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">textMessage</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createTextMessage</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;Hello&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//设置延时时长(延时10秒)</span></span>
<span class="line"><span style="color:#ADBAC7;">        textMessage.</span><span style="color:#DCBDFB;">setLongProperty</span><span style="color:#ADBAC7;">(ScheduledMessage.AMQ_SCHEDULED_DELAY, </span><span style="color:#6CB6FF;">10000</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        producer.</span><span style="color:#DCBDFB;">send</span><span style="color:#ADBAC7;">(textMessage);</span></span>
<span class="line"><span style="color:#ADBAC7;">        session.</span><span style="color:#DCBDFB;">commit</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (Exception </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;ok&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* 延时投递</span></span>
<span class="line"><span style="color:#6A737D;">*/</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> String </span><span style="color:#6F42C1;">sendQueue</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    Connection connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    Session session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    ActiveMQMessageProducer producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取连接工厂</span></span>
<span class="line"><span style="color:#24292E;">    ConnectionFactory connectionFactory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> jmsMessagingTemplate.</span><span style="color:#6F42C1;">getConnectionFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connectionFactory.</span><span style="color:#6F42C1;">createConnection</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connection.</span><span style="color:#6F42C1;">createSession</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#24292E;">        Queue queue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createQueue</span><span style="color:#24292E;">(name);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> count </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (ActiveMQMessageProducer) session.</span><span style="color:#6F42C1;">createProducer</span><span style="color:#24292E;">(queue);</span></span>
<span class="line"><span style="color:#24292E;">        producer.</span><span style="color:#6F42C1;">setDeliveryMode</span><span style="color:#24292E;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//创建需要发送的消息</span></span>
<span class="line"><span style="color:#24292E;">        TextMessage textMessage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createTextMessage</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Hello&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//设置延时时长(延时10秒)</span></span>
<span class="line"><span style="color:#24292E;">        textMessage.</span><span style="color:#6F42C1;">setLongProperty</span><span style="color:#24292E;">(ScheduledMessage.AMQ_SCHEDULED_DELAY, </span><span style="color:#005CC5;">10000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        producer.</span><span style="color:#6F42C1;">send</span><span style="color:#24292E;">(textMessage);</span></span>
<span class="line"><span style="color:#24292E;">        session.</span><span style="color:#6F42C1;">commit</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Exception </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ok&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="定时投递" tabindex="-1">定时投递 <a class="header-anchor" href="#定时投递" aria-label="Permalink to &quot;定时投递&quot;">​</a></h3><ol><li>启动类添加定时注解</li></ol><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">SpringBootApplication</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">EnableScheduling</span><span style="color:#ADBAC7;"> </span><span style="color:#768390;">// 开启定时功能</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">MyActiveMQApplication</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">args</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        SpringApplication.</span><span style="color:#DCBDFB;">run</span><span style="color:#ADBAC7;">(MyActiveMQApplication.class,args);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">SpringBootApplication</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">EnableScheduling</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 开启定时功能</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MyActiveMQApplication</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        SpringApplication.</span><span style="color:#6F42C1;">run</span><span style="color:#24292E;">(MyActiveMQApplication.class,args);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ol start="2"><li>在生产者添加@Scheduled设置定时</li></ol><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 消息生产者</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Component</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ProducerController3</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Value</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;${activemq.name}&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">name;</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Autowired</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> JmsMessagingTemplate</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">jmsMessagingTemplate;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 设置延时投递，每隔3秒定投</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Scheduled</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">fixedDelay</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">3000</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">sendQueue</span><span style="color:#ADBAC7;">() {</span></span>
<span class="line"><span style="color:#ADBAC7;">        jmsMessagingTemplate.</span><span style="color:#DCBDFB;">convertAndSend</span><span style="color:#ADBAC7;">(name, </span><span style="color:#96D0FF;">&quot;消息ID:&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> UUID.</span><span style="color:#DCBDFB;">randomUUID</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">toString</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">substring</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">6</span><span style="color:#ADBAC7;">));</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息发送成功...&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 消息生产者</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Component</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ProducerController3</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;${activemq.name}&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> String name;</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> JmsMessagingTemplate jmsMessagingTemplate;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 设置延时投递，每隔3秒定投</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Scheduled</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">fixedDelay</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sendQueue</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">        jmsMessagingTemplate.</span><span style="color:#6F42C1;">convertAndSend</span><span style="color:#24292E;">(name, </span><span style="color:#032F62;">&quot;消息ID:&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> UUID.</span><span style="color:#6F42C1;">randomUUID</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">toString</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">substring</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">6</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息发送成功...&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="死信队列" tabindex="-1">死信队列 <a class="header-anchor" href="#死信队列" aria-label="Permalink to &quot;死信队列&quot;">​</a></h2><p>  DLQ-Dead Letter Queue，死信队列，用来保存处理失败或者过期的消息。</p><p>  出现以下情况时，消息会被重发：</p><ul><li>A transacted session is used and rollback() is called.</li><li>A transacted session is closed before commit is called.</li><li>A session is using CLIENT_ACKNOWLEDGE and Session.recover() is called.</li></ul><p>  当一个消息被重发超过6(缺省为6次)次数时，会给broker发送一个&quot;Poison ack&quot;，这个消息被认为是apoison pill，这时broker会将这个消息发送到死信队列，以便后续处理。</p><p>  注意两点：</p><ol><li>缺省持久消息过期，会被送到DLQ，非持久消息不会送到DLQ</li><li>缺省的死信队列是ActiveMQ.DLQ，如果没有特别指定，死信都会被发送到这个队列。可以通过配置文件(activemq.xml)来调整死信发送策略。</li></ol><h3 id="java代码" tabindex="-1">java代码 <a class="header-anchor" href="#java代码" aria-label="Permalink to &quot;java代码&quot;">​</a></h3><ol><li>activemq.xml，为每个队列建立独立的死信队列</li></ol><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">&lt;</span><span style="color:#8DDB8C;">destinationPolicy</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">policyMap</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">        &lt;</span><span style="color:#8DDB8C;">policyEntries</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">            &lt;</span><span style="color:#8DDB8C;">policyEntry</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">queue</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;&gt;&quot;</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                &lt;</span><span style="color:#8DDB8C;">deadLetterStrategy</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                    &lt;</span><span style="color:#8DDB8C;">individualDeadLetterStrategy</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">queuePrefix</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;DLQ.&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">useQueueForQueueMessages</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;true&quot;</span><span style="color:#ADBAC7;"> /&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                &lt;/</span><span style="color:#8DDB8C;">deadLetterStrategy</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">            &lt;/</span><span style="color:#8DDB8C;">policyEntry</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span></span>
<span class="line"><span style="color:#ADBAC7;">            &lt;</span><span style="color:#8DDB8C;">policyEntry</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">topic</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;&gt;&quot;</span><span style="color:#ADBAC7;"> &gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                &lt;</span><span style="color:#8DDB8C;">pendingMessageLimitStrategy</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                    &lt;</span><span style="color:#8DDB8C;">constantPendingMessageLimitStrategy</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">limit</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;1000&quot;</span><span style="color:#ADBAC7;">/&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                &lt;/</span><span style="color:#8DDB8C;">pendingMessageLimitStrategy</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">            &lt;/</span><span style="color:#8DDB8C;">policyEntry</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">        &lt;/</span><span style="color:#8DDB8C;">policyEntries</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;/</span><span style="color:#8DDB8C;">policyMap</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;/</span><span style="color:#8DDB8C;">destinationPolicy</span><span style="color:#ADBAC7;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">destinationPolicy</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">policyMap</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">        &lt;</span><span style="color:#22863A;">policyEntries</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">            &lt;</span><span style="color:#22863A;">policyEntry</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">queue</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;&gt;&quot;</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">                &lt;</span><span style="color:#22863A;">deadLetterStrategy</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">                    &lt;</span><span style="color:#22863A;">individualDeadLetterStrategy</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">queuePrefix</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;DLQ.&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">useQueueForQueueMessages</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;"> /&gt;</span></span>
<span class="line"><span style="color:#24292E;">                &lt;/</span><span style="color:#22863A;">deadLetterStrategy</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">            &lt;/</span><span style="color:#22863A;">policyEntry</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">            </span></span>
<span class="line"><span style="color:#24292E;">            &lt;</span><span style="color:#22863A;">policyEntry</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">topic</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;&gt;&quot;</span><span style="color:#24292E;"> &gt;</span></span>
<span class="line"><span style="color:#24292E;">                &lt;</span><span style="color:#22863A;">pendingMessageLimitStrategy</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">                    &lt;</span><span style="color:#22863A;">constantPendingMessageLimitStrategy</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">limit</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;1000&quot;</span><span style="color:#24292E;">/&gt;</span></span>
<span class="line"><span style="color:#24292E;">                &lt;/</span><span style="color:#22863A;">pendingMessageLimitStrategy</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">            &lt;/</span><span style="color:#22863A;">policyEntry</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">        &lt;/</span><span style="color:#22863A;">policyEntries</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;/</span><span style="color:#22863A;">policyMap</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">destinationPolicy</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><ol start="2"><li>RedeliveryPolicy重发策略设置</li></ol><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Configuration</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ActiveMqConfig</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//RedeliveryPolicy重发策略设置</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> RedeliveryPolicy </span><span style="color:#DCBDFB;">redeliveryPolicy</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">        RedeliveryPolicy</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">redeliveryPolicy</span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">RedeliveryPolicy</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//是否在每次尝试重新发送失败后,增长这个等待时间</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setUseExponentialBackOff</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//重发次数,默认为6次 这里设置为10次</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setMaximumRedeliveries</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">10</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//重发时间间隔,默认为1秒</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setInitialRedeliveryDelay</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//第一次失败后重新发送之前等待500毫秒,第二次失败再等待500 * 2毫秒,这里的2就是value</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setBackOffMultiplier</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">2</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//是否避免消息碰撞</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setUseCollisionAvoidance</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//设置重发最大拖延时间-1 表示没有拖延只有UseExponentialBackOff(true)为true时生效</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setMaximumRedeliveryDelay</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">-</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> redeliveryPolicy;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> ActiveMQConnectionFactory </span><span style="color:#DCBDFB;">activeMQConnectionFactory</span><span style="color:#ADBAC7;"> (</span></span>
<span class="line"><span style="color:#ADBAC7;">        @</span><span style="color:#F47067;">Value</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;${spring.activemq.broker-url}&quot;</span><span style="color:#ADBAC7;">)String </span><span style="color:#F69D50;">url</span><span style="color:#ADBAC7;">,RedeliveryPolicy </span><span style="color:#F69D50;">redeliveryPolicy</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        ActiveMQConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">activeMQConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">ActiveMQConnectionFactory</span><span style="color:#ADBAC7;">( </span><span style="color:#96D0FF;">&quot;admin&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;admin&quot;</span><span style="color:#ADBAC7;">, url);</span></span>
<span class="line"><span style="color:#ADBAC7;">        activeMQConnectionFactory.</span><span style="color:#DCBDFB;">setRedeliveryPolicy</span><span style="color:#ADBAC7;">(redeliveryPolicy);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> activeMQConnectionFactory;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> PlatformTransactionManager </span><span style="color:#DCBDFB;">transactionManager</span><span style="color:#ADBAC7;">(ConnectionFactory </span><span style="color:#F69D50;">connectionFactory</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">JmsTransactionManager</span><span style="color:#ADBAC7;">(connectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">name</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> DefaultJmsListenerContainerFactory </span><span style="color:#DCBDFB;">jmsListenerContainerFactory</span><span style="color:#ADBAC7;">(</span></span>
<span class="line"><span style="color:#ADBAC7;">        ConnectionFactory </span><span style="color:#F69D50;">connectionFactory</span><span style="color:#ADBAC7;">,PlatformTransactionManager </span><span style="color:#F69D50;">transactionManager</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        DefaultJmsListenerContainerFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">factory</span><span style="color:#F47067;">=new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">DefaultJmsListenerContainerFactory</span><span style="color:#ADBAC7;"> ();</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setTransactionManager</span><span style="color:#ADBAC7;">(transactionManager);</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setConnectionFactory</span><span style="color:#ADBAC7;">(connectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setSessionTransacted</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">); </span><span style="color:#768390;">// 开启事务</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setSessionAcknowledgeMode</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> factory;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Configuration</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ActiveMqConfig</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//RedeliveryPolicy重发策略设置</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> RedeliveryPolicy </span><span style="color:#6F42C1;">redeliveryPolicy</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        RedeliveryPolicy redeliveryPolicy</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RedeliveryPolicy</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//是否在每次尝试重新发送失败后,增长这个等待时间</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setUseExponentialBackOff</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//重发次数,默认为6次 这里设置为10次</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setMaximumRedeliveries</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//重发时间间隔,默认为1秒</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setInitialRedeliveryDelay</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//第一次失败后重新发送之前等待500毫秒,第二次失败再等待500 * 2毫秒,这里的2就是value</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setBackOffMultiplier</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//是否避免消息碰撞</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setUseCollisionAvoidance</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//设置重发最大拖延时间-1 表示没有拖延只有UseExponentialBackOff(true)为true时生效</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setMaximumRedeliveryDelay</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> redeliveryPolicy;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> ActiveMQConnectionFactory </span><span style="color:#6F42C1;">activeMQConnectionFactory</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">        @</span><span style="color:#D73A49;">Value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;${spring.activemq.broker-url}&quot;</span><span style="color:#24292E;">)String </span><span style="color:#E36209;">url</span><span style="color:#24292E;">,RedeliveryPolicy </span><span style="color:#E36209;">redeliveryPolicy</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        ActiveMQConnectionFactory activeMQConnectionFactory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ActiveMQConnectionFactory</span><span style="color:#24292E;">( </span><span style="color:#032F62;">&quot;admin&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;admin&quot;</span><span style="color:#24292E;">, url);</span></span>
<span class="line"><span style="color:#24292E;">        activeMQConnectionFactory.</span><span style="color:#6F42C1;">setRedeliveryPolicy</span><span style="color:#24292E;">(redeliveryPolicy);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> activeMQConnectionFactory;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> PlatformTransactionManager </span><span style="color:#6F42C1;">transactionManager</span><span style="color:#24292E;">(ConnectionFactory </span><span style="color:#E36209;">connectionFactory</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JmsTransactionManager</span><span style="color:#24292E;">(connectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> DefaultJmsListenerContainerFactory </span><span style="color:#6F42C1;">jmsListenerContainerFactory</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        ConnectionFactory </span><span style="color:#E36209;">connectionFactory</span><span style="color:#24292E;">,PlatformTransactionManager </span><span style="color:#E36209;">transactionManager</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        DefaultJmsListenerContainerFactory factory</span><span style="color:#D73A49;">=new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DefaultJmsListenerContainerFactory</span><span style="color:#24292E;"> ();</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setTransactionManager</span><span style="color:#24292E;">(transactionManager);</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setConnectionFactory</span><span style="color:#24292E;">(connectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setSessionTransacted</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// 开启事务</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setSessionAcknowledgeMode</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> factory;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-462c643b data-v-f6bde3e6><!--[--><!--]--><div class="edit-info" data-v-f6bde3e6><!----><div class="last-updated" data-v-f6bde3e6><p class="VPLastUpdated" data-v-f6bde3e6 data-v-cfcf869c>最后更新: <time datetime="2023-09-24T09:25:48.000Z" data-v-cfcf869c></time></p></div></div><div class="prev-next" data-v-f6bde3e6><div class="pager" data-v-f6bde3e6><a class="pager-link prev" href="/charles-blog/md/middleware/Jms.html" data-v-f6bde3e6><span class="desc" data-v-f6bde3e6>上一篇</span><span class="title" data-v-f6bde3e6>JMS</span></a></div><div class="has-prev pager" data-v-f6bde3e6><a class="pager-link next" href="/charles-blog/md/middleware/Kafka.html" data-v-f6bde3e6><span class="desc" data-v-f6bde3e6>下一篇</span><span class="title" data-v-f6bde3e6>Kafka</span></a></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"md_test_lin_index.md\":\"706ea71f\",\"md_test_zhu_index.md\":\"2c99a562\",\"index.md\":\"4503a516\",\"md_test_child1.md\":\"6f9aed24\",\"md_about_index.md\":\"4984c4d8\",\"md_database_cache.md\":\"ee1e9375\",\"md_test_index.md\":\"a179ba4f\",\"md_database_index.md\":\"8ef353e5\",\"md_database_oracle.md\":\"7147de3e\",\"md_distributed_singlesignon.md\":\"e9469380\",\"md_environment_docker.md\":\"6d9d0c36\",\"md_distributed_index.md\":\"85eafa6b\",\"md_java_index.md\":\"8e3f7d5f\",\"md_environment_shell.md\":\"779c4602\",\"md_environment_linux.md\":\"9e61f6d8\",\"md_environment_index.md\":\"4e1f2168\",\"md_java_javaother_javainterviewquestions.md\":\"b05c4f2a\",\"md_database_mongodb.md\":\"ed78548e\",\"md_database_redis.md\":\"2eb607ad\",\"md_database_mysql.md\":\"c1f317d9\",\"md_java_javaother_lock.md\":\"1b11e871\",\"md_java_javaother_java8.md\":\"98624343\",\"md_java_javaother_designpatterns.md\":\"0858d58e\",\"md_database_elkstack.md\":\"ca5582c6\",\"md_java_javaother_regularexpression.md\":\"dbb63f3f\",\"md_java_javaunderlayer_hash.md\":\"e1bfbdd6\",\"md_java_javaunderlayer_classloader.md\":\"a28e97d8\",\"md_java_javaunderlayer_gc.md\":\"8b102f85\",\"md_java_javaother_thread.md\":\"2ad6e1e2\",\"md_java_javaother_synchronized.md\":\"ee25ab08\",\"md_java_javaunderlayer_jvm.md\":\"4a6ccd9b\",\"md_java_javaweb_javaweb.md\":\"cc6cf75c\",\"md_java_mybatis_mybatis.md\":\"d9803a83\",\"md_java_javaunderlayer_memoryleak.md\":\"0d57ac68\",\"md_java_spring_springannotations.md\":\"89640029\",\"md_java_spring_spring.md\":\"a80a4f49\",\"md_java_mybatis_mybatisplus.md\":\"a46e638f\",\"md_java_spring_springmvc.md\":\"d3ce0b21\",\"md_java_spring_springtransaction.md\":\"ef9c6d8a\",\"md_java_spring_springboot.md\":\"5bba519d\",\"md_middleware_activemq.md\":\"45ec1a9b\",\"md_middleware_arthas.md\":\"ed6d7630\",\"md_middleware_jms.md\":\"ac6f5658\",\"md_middleware_kafka.md\":\"3238de67\",\"md_middleware_nginx.md\":\"2bf5bd09\",\"md_middleware_index.md\":\"1c4b5f2c\",\"md_network_conversationtechnolog.md\":\"f21c82a7\",\"md_network_https.md\":\"1fbe42dd\",\"md_network_networkdevices.md\":\"7a850f72\",\"md_network_ip.md\":\"b8f18932\",\"md_network_index.md\":\"09603bc1\",\"md_network_mac.md\":\"992dbcbd\",\"md_middleware_zookeeper.md\":\"7a7e70a5\",\"md_network_tcp.md\":\"fcf7ac1f\",\"md_network_loadbalance.md\":\"1714c06e\",\"md_network_model.md\":\"7a0f94c4\",\"md_network_http.md\":\"fa7644b0\",\"md_network_dns.md\":\"7a6bd009\",\"md_middleware_rabbitmq.md\":\"17ee6046\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"小朱杂记\",\"description\":\"My Document\",\"base\":\"/charles-blog/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Java\",\"link\":\"/md/java/\",\"activeMatch\":\"/md/java/\"},{\"text\":\"数据库\",\"link\":\"/md/database/\",\"activeMatch\":\"/md/database/\"},{\"text\":\"中间件\",\"link\":\"/md/middleware/\",\"activeMatch\":\"/md/middleware/\"},{\"text\":\"网络\",\"link\":\"/md/network/\",\"activeMatch\":\"/md/network/\"},{\"text\":\"环境\",\"link\":\"/md/environment/\",\"activeMatch\":\"/md/environment/\"},{\"text\":\"分布式\",\"link\":\"/md/distributed/\",\"activeMatch\":\"/md/distributed/\"},{\"text\":\"关于我\",\"link\":\"/md/about/\"}],\"sidebar\":{\"/md/java/\":[{\"text\":\"Java\",\"link\":\"/md/java/\",\"items\":[{\"text\":\"Spring \",\"collapsed\":true,\"items\":[{\"text\":\"Spring杂叙\",\"link\":\"/md/java/spring/Spring\"},{\"text\":\"SpringMvc\",\"link\":\"/md/java/spring/SpringMVC\"},{\"text\":\"SpringBoot\",\"link\":\"/md/java/spring/SpringBoot\"},{\"text\":\"Spring事务\",\"link\":\"/md/java/spring/SpringTransaction\"},{\"text\":\"Spring注解\",\"link\":\"/md/java/spring/SpringAnnotations\"}]},{\"text\":\"Java底层\",\"collapsed\":true,\"items\":[{\"text\":\"JVM\",\"link\":\"/md/java/javaUnderlayer/JVM\"},{\"text\":\"GC\",\"link\":\"/md/java/javaUnderlayer/GC\"},{\"text\":\"内存泄漏\",\"link\":\"/md/java/javaUnderlayer/MemoryLeak\"},{\"text\":\"哈希(Hash)\",\"link\":\"/md/java/javaUnderlayer/Hash\"},{\"text\":\"类加载器\",\"link\":\"/md/java/javaUnderlayer/ClassLoader\"}]},{\"text\":\"JavaWeb\",\"collapsed\":true,\"items\":[{\"text\":\"JavaWeb杂叙\",\"link\":\"/md/java/javaWeb/JavaWeb\"}]},{\"text\":\"Java其他\",\"collapsed\":true,\"items\":[{\"text\":\"Java8\",\"link\":\"/md/java/javaOther/Java8\"},{\"text\":\"锁\",\"link\":\"/md/java/javaOther/Lock\"},{\"text\":\"Synchronized\",\"link\":\"/md/java/javaOther/Synchronized\"},{\"text\":\"浅谈设计模式\",\"link\":\"/md/java/javaOther/DesignPatterns\"},{\"text\":\"进程，线程，线程池，调度\",\"link\":\"/md/java/javaOther/Thread\"},{\"text\":\"正则表达式\",\"link\":\"/md/java/javaOther/RegularExpression\"},{\"text\":\"Java面试题\",\"link\":\"/md/java/javaOther/JavaInterviewQuestions\"}]},{\"text\":\"Mybatis\",\"collapsed\":true,\"items\":[{\"text\":\"Mybatis杂叙\",\"link\":\"/md/java/mybatis/Mybatis\"},{\"text\":\"Mybatis-Plus\",\"link\":\"/md/java/mybatis/MybatisPlus\"}]}]}],\"/md/database/\":[{\"text\":\"数据库\",\"link\":\"/md/database/\",\"items\":[{\"text\":\"MySQL\",\"link\":\"/md/database/Mysql\"},{\"text\":\"Oracle\",\"link\":\"/md/database/Oracle\"},{\"text\":\"Redis\",\"link\":\"/md/database/Redis\"},{\"text\":\"ELK Stack\",\"link\":\"/md/database/ElkStack\"},{\"text\":\"MongoDB\",\"link\":\"/md/database/MongoDB\"},{\"text\":\"缓存\",\"link\":\"/md/database/Cache\"}]}],\"/md/network/\":[{\"text\":\"网络\",\"link\":\"/md/network/\",\"items\":[{\"text\":\"网络模型\",\"link\":\"/md/network/Model\"},{\"text\":\"HTTP\",\"link\":\"/md/network/Http\"},{\"text\":\"HTTPS\",\"link\":\"/md/network/Https\"},{\"text\":\"TCP\",\"link\":\"/md/network/Tcp\"},{\"text\":\"IP\",\"link\":\"/md/network/Ip\"},{\"text\":\"MAC\",\"link\":\"/md/network/Mac\"},{\"text\":\"DNS\",\"link\":\"/md/network/Dns\"},{\"text\":\"会话技术\",\"link\":\"/md/network/ConversationTechnolog\"},{\"text\":\"常见的网络设备\",\"link\":\"/md/network/NetworkDevices\"},{\"text\":\"负载均衡\",\"link\":\"/md/network/LoadBalance\"}]}],\"/md/environment/\":[{\"text\":\"环境\",\"link\":\"/md/environment/\",\"items\":[{\"text\":\"Linux\",\"link\":\"/md/environment/Linux\"},{\"text\":\"Shell\",\"link\":\"/md/environment/Shell\"},{\"text\":\"Docker\",\"link\":\"/md/environment/Docker\"}]}],\"/md/distributed/\":[{\"text\":\"分布式\",\"items\":[{\"text\":\"单点登陆\",\"link\":\"/md/distributed/SingleSignOn\"},{\"text\":\"分布式系统\",\"link\":\"/md/distributed/\"}]}],\"/md/middleware/\":[{\"text\":\"中间件\",\"link\":\"/md/middleware/\",\"items\":[{\"text\":\"Nginx\",\"link\":\"/md/middleware/Nginx\"},{\"text\":\"RabbitMQ\",\"link\":\"/md/middleware/Rabbitmq\"},{\"text\":\"Zookeeper\",\"link\":\"/md/middleware/Zookeeper\"},{\"text\":\"Arthas\",\"link\":\"/md/middleware/Arthas\"},{\"text\":\"JMS\",\"link\":\"/md/middleware/Jms\"},{\"text\":\"ActiveMQ\",\"link\":\"/md/middleware/ActiveMq\"},{\"text\":\"Kafka\",\"link\":\"/md/middleware/Kafka\"}]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/CharleZhuJJ/charles-blog\"}],\"outline\":{\"level\":\"deep\",\"label\":\"目录\"},\"darkModeSwitchLabel\":\"切换日光/暗黑模式\",\"sidebarMenuLabel\":\"文章\",\"returnToTopLabel\":\"返回顶部\",\"lastUpdatedText\":\"最后更新\",\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"search\":{\"provider\":\"local\"}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>