import{_ as t}from"./chunks/ArticleMetadata.8b6b367a.js";import{_ as c,H as r,o as l,c as y,J as A,E as i,C as p,a as D,V as C,D as B,G as F}from"./chunks/framework.981adca9.js";const E="/charles-blog/assets/Persistence.9985f8c2.png",u="/charles-blog/assets/Transaction.8aa289ff.png",T=JSON.parse('{"title":"ActiveMQ","description":"","frontmatter":{"title":"ActiveMQ","author":"Charles Chu","date":"2021/09/30","isOriginal":true},"headers":[],"relativePath":"md/middleware/ActiveMq.md","filePath":"md/middleware/ActiveMq.md","lastUpdated":1695547548000}'),d={name:"md/middleware/ActiveMq.md"},g=p("h1",{id:"activemq",tabindex:"-1"},[D("ActiveMQ "),p("a",{class:"header-anchor",href:"#activemq","aria-label":'Permalink to "ActiveMQ"'},"​")],-1),m=C('<p>  Apache ActiveMQ是Apache软件基金会所研发的开放源代码消息中间件；由于ActiveMQ是一个纯Java程序，因此只需要操作系统支持Java虚拟机，ActiveMQ便可执行。</p><h2 id="消息持久化" tabindex="-1">消息持久化 <a class="header-anchor" href="#消息持久化" aria-label="Permalink to &quot;消息持久化&quot;">​</a></h2><p>  ActiveMQ提供了以下三种的消息存储方式：</p><ol><li>Memory 消息存储-基于内存的消息存储。</li><li>基于日志消息存储方式，KahaDB是ActiveMQ的默认日志存储方式，它提供了容量的提升和恢复能力。</li><li>基于JDBC的消息存储方式-数据存储于数据库（例如：MySQL）中。</li></ol><h3 id="activemq持久化机制流程图" tabindex="-1">ActiveMQ持久化机制流程图 <a class="header-anchor" href="#activemq持久化机制流程图" aria-label="Permalink to &quot;ActiveMQ持久化机制流程图&quot;">​</a></h3><p><img src="'+E+`" alt="Persistence"></p><h3 id="基于jdbc的消息持久化实现" tabindex="-1">基于jdbc的消息持久化实现 <a class="header-anchor" href="#基于jdbc的消息持久化实现" aria-label="Permalink to &quot;基于jdbc的消息持久化实现&quot;">​</a></h3><ol><li>application.yml</li></ol><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#8DDB8C;">server</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">port</span><span style="color:#ADBAC7;">: </span><span style="color:#6CB6FF;">9001</span></span>
<span class="line"><span style="color:#8DDB8C;">spring</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">activemq</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#8DDB8C;">broker-url</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">tcp://192.168.66.133:61616</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#8DDB8C;">user</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">admin</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#8DDB8C;">password</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">admin</span></span>
<span class="line"><span style="color:#8DDB8C;">jms</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">pub-sub-domain</span><span style="color:#ADBAC7;">: </span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;"> </span><span style="color:#768390;"># false：点对点队列模式， true：发布/订阅模式</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">template</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#8DDB8C;">delivery-mode</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">persistent</span><span style="color:#ADBAC7;"> </span><span style="color:#768390;"># 持久化</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#8DDB8C;">activemq</span><span style="color:#ADBAC7;">:</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">name</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">springboot-queue01</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">server</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9001</span></span>
<span class="line"><span style="color:#22863A;">spring</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">activemq</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">broker-url</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tcp://192.168.66.133:61616</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">user</span><span style="color:#24292E;">: </span><span style="color:#032F62;">admin</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">password</span><span style="color:#24292E;">: </span><span style="color:#032F62;">admin</span></span>
<span class="line"><span style="color:#22863A;">jms</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">pub-sub-domain</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># false：点对点队列模式， true：发布/订阅模式</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">delivery-mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">persistent</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 持久化</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#22863A;">activemq</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">springboot-queue01</span></span></code></pre></div><ol start="2"><li>activemq.xml</li></ol><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">&lt;!--配置数据库连接池--&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;</span><span style="color:#8DDB8C;">bean</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">name</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;mysql-ds&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">class</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">destroy-method</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;close&quot;</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">property</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">name</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;driverClassName&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">value</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;com.mysql.jdbc.Driver&quot;</span><span style="color:#ADBAC7;"> /&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">property</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">name</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;url&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">value</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;jdbc:mysql://192.168.66.133:3306/db_activemq&quot;</span><span style="color:#ADBAC7;"> /&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">property</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">name</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;username&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">value</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;root&quot;</span><span style="color:#ADBAC7;"> /&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">property</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">name</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;password&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">value</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;123456&quot;</span><span style="color:#ADBAC7;">/&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;/</span><span style="color:#8DDB8C;">bean</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">&lt;!--JDBC Jdbc用于master/slave模式的数据库分享 --&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;</span><span style="color:#8DDB8C;">persistenceAdapter</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">jdbcPersistenceAdapter</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">dataSource</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;#mysql-ds&quot;</span><span style="color:#ADBAC7;">/&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;/</span><span style="color:#8DDB8C;">persistenceAdapter</span><span style="color:#ADBAC7;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">&lt;!--配置数据库连接池--&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">bean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;mysql-ds&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">class</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">destroy-method</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;close&quot;</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">property</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;driverClassName&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;com.mysql.jdbc.Driver&quot;</span><span style="color:#24292E;"> /&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">property</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;url&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;jdbc:mysql://192.168.66.133:3306/db_activemq&quot;</span><span style="color:#24292E;"> /&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">property</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;username&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;root&quot;</span><span style="color:#24292E;"> /&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">property</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;password&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;123456&quot;</span><span style="color:#24292E;">/&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">bean</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">&lt;!--JDBC Jdbc用于master/slave模式的数据库分享 --&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">persistenceAdapter</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">jdbcPersistenceAdapter</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">dataSource</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;#mysql-ds&quot;</span><span style="color:#24292E;">/&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">persistenceAdapter</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><ol start="3"><li>拷贝mysql及durid数据源的jar包到activemq的lib目录下</li><li>重启activemq</li></ol><h2 id="消息事务" tabindex="-1">消息事务 <a class="header-anchor" href="#消息事务" aria-label="Permalink to &quot;消息事务&quot;">​</a></h2><p>  消息事务，是保证消息传递原子性的一个重要特征，和JDBC的事务特征类似。</p><p>  一个事务性发送，其中一组消息要么能够全部保证到达服务器，要么都不到达服务器。</p><p>  生产者、消费者与消息服务器直接都支持事务性；ActionMQ的事务主要偏向在生产者的应用。</p><p><img src="`+u+`" alt="Transaction"></p><h3 id="生产者事务-一" tabindex="-1">生产者事务（一） <a class="header-anchor" href="#生产者事务-一" aria-label="Permalink to &quot;生产者事务（一）&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">sendMessageTx</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">    ConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> jmsMessagingTemplate.</span><span style="color:#DCBDFB;">getConnectionFactory</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    Session</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">session</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">        Connection</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connection</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connectionFactory.</span><span style="color:#DCBDFB;">createConnection</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">        * 参数一：是否开启消息事务</span></span>
<span class="line"><span style="color:#768390;">        */</span></span>
<span class="line"><span style="color:#ADBAC7;">        session </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connection.</span><span style="color:#DCBDFB;">createSession</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">        MessageProducer</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">producer</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;">  session.</span><span style="color:#DCBDFB;">createProducer</span><span style="color:#ADBAC7;">(session.</span><span style="color:#DCBDFB;">createQueue</span><span style="color:#ADBAC7;">(name));</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F47067;">=</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">;i</span><span style="color:#F47067;">&lt;=</span><span style="color:#6CB6FF;">10</span><span style="color:#ADBAC7;">;i</span><span style="color:#F47067;">++</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//模拟异常</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;">(i</span><span style="color:#F47067;">==</span><span style="color:#6CB6FF;">4</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">a</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">10</span><span style="color:#F47067;">/</span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">            TextMessage</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">textMessage</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createTextMessage</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息--&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">  i);</span></span>
<span class="line"><span style="color:#ADBAC7;">            producer.</span><span style="color:#DCBDFB;">send</span><span style="color:#ADBAC7;">(textMessage);</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//注意：一旦开启事务发送，那么就必须使用commit方法进行事务提交，否则消息无法到达MQ服务器</span></span>
<span class="line"><span style="color:#ADBAC7;">        session.</span><span style="color:#DCBDFB;">commit</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//消息事务回滚</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">            session.</span><span style="color:#DCBDFB;">rollback</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e1</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            e1.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sendMessageTx</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">    ConnectionFactory connectionFactory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> jmsMessagingTemplate.</span><span style="color:#6F42C1;">getConnectionFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    Session session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        Connection connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connectionFactory.</span><span style="color:#6F42C1;">createConnection</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">        * 参数一：是否开启消息事务</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#24292E;">        session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connection.</span><span style="color:#6F42C1;">createSession</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#24292E;">        MessageProducer producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  session.</span><span style="color:#6F42C1;">createProducer</span><span style="color:#24292E;">(session.</span><span style="color:#6F42C1;">createQueue</span><span style="color:#24292E;">(name));</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;i</span><span style="color:#D73A49;">&lt;=</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//模拟异常</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(i</span><span style="color:#D73A49;">==</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            TextMessage textMessage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createTextMessage</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息--&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;">  i);</span></span>
<span class="line"><span style="color:#24292E;">            producer.</span><span style="color:#6F42C1;">send</span><span style="color:#24292E;">(textMessage);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//注意：一旦开启事务发送，那么就必须使用commit方法进行事务提交，否则消息无法到达MQ服务器</span></span>
<span class="line"><span style="color:#24292E;">        session.</span><span style="color:#6F42C1;">commit</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//消息事务回滚</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            session.</span><span style="color:#6F42C1;">rollback</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e1</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            e1.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="生产者事务-二" tabindex="-1">生产者事务（二） <a class="header-anchor" href="#生产者事务-二" aria-label="Permalink to &quot;生产者事务（二）&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 配置类</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Configuration</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ActiveMqConfig</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> PlatformTransactionManager </span><span style="color:#DCBDFB;">transactionManager</span><span style="color:#ADBAC7;">(ConnectionFactory </span><span style="color:#F69D50;">connectionFactory</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">JmsTransactionManager</span><span style="color:#ADBAC7;">(connectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// 业务类</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Service</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">MessageService</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Autowired</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> JmsMessagingTemplate</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">jmsMessagingTemplate;</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Value</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;\${activemq.name}&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">name;</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Transactional</span><span style="color:#ADBAC7;"> </span><span style="color:#768390;">// 对消息发送加入事务管理（同时也对JDBC数据库的事务生效）</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">sendMessage</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F47067;">=</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">;i</span><span style="color:#F47067;">&lt;=</span><span style="color:#6CB6FF;">10</span><span style="color:#ADBAC7;">;i</span><span style="color:#F47067;">++</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//模拟异常</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;">(i</span><span style="color:#F47067;">==</span><span style="color:#6CB6FF;">4</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">a</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">10</span><span style="color:#F47067;">/</span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">        jmsMessagingTemplate.</span><span style="color:#DCBDFB;">convertAndSend</span><span style="color:#ADBAC7;">(name, </span><span style="color:#96D0FF;">&quot;消息---&quot;</span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;">i);</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 配置类</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Configuration</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ActiveMqConfig</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> PlatformTransactionManager </span><span style="color:#6F42C1;">transactionManager</span><span style="color:#24292E;">(ConnectionFactory </span><span style="color:#E36209;">connectionFactory</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JmsTransactionManager</span><span style="color:#24292E;">(connectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 业务类</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Service</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MessageService</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> JmsMessagingTemplate jmsMessagingTemplate;</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;\${activemq.name}&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> String name;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Transactional</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 对消息发送加入事务管理（同时也对JDBC数据库的事务生效）</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sendMessage</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;i</span><span style="color:#D73A49;">&lt;=</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//模拟异常</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(i</span><span style="color:#D73A49;">==</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        jmsMessagingTemplate.</span><span style="color:#6F42C1;">convertAndSend</span><span style="color:#24292E;">(name, </span><span style="color:#032F62;">&quot;消息---&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">i);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="消费者事务" tabindex="-1">消费者事务 <a class="header-anchor" href="#消费者事务" aria-label="Permalink to &quot;消费者事务&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Component</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">Consumer</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#768390;">    /**</span></span>
<span class="line"><span style="color:#768390;">    * 接收消息的方法</span></span>
<span class="line"><span style="color:#768390;">    */</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">JmsListener</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">destination</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;\${activemq.name}&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">containerFactory</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">receiveMessage</span><span style="color:#ADBAC7;">(TextMessage </span><span style="color:#F69D50;">textMessage</span><span style="color:#ADBAC7;">,Session </span><span style="color:#F69D50;">session</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">throws</span><span style="color:#ADBAC7;"> JMSException {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">            System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息内容：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getText</span><span style="color:#ADBAC7;">() </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;,是否重发：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getJMSRedelivered</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">100</span><span style="color:#F47067;">/</span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">; </span><span style="color:#768390;">//模拟异常</span></span>
<span class="line"><span style="color:#ADBAC7;">            session.</span><span style="color:#DCBDFB;">commit</span><span style="color:#ADBAC7;">();</span><span style="color:#768390;">//提交事务</span></span>
<span class="line"><span style="color:#ADBAC7;">        } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">                session.</span><span style="color:#DCBDFB;">rollback</span><span style="color:#ADBAC7;">();</span><span style="color:#768390;">//回滚事务</span></span>
<span class="line"><span style="color:#ADBAC7;">            } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e1</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            }</span></span>
<span class="line"><span style="color:#ADBAC7;">            e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Component</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Consumer</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#6A737D;">    /**</span></span>
<span class="line"><span style="color:#6A737D;">    * 接收消息的方法</span></span>
<span class="line"><span style="color:#6A737D;">    */</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">JmsListener</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">destination</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;\${activemq.name}&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">containerFactory</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">receiveMessage</span><span style="color:#24292E;">(TextMessage </span><span style="color:#E36209;">textMessage</span><span style="color:#24292E;">,Session </span><span style="color:#E36209;">session</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> JMSException {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息内容：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getText</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;,是否重发：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getJMSRedelivered</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">//模拟异常</span></span>
<span class="line"><span style="color:#24292E;">            session.</span><span style="color:#6F42C1;">commit</span><span style="color:#24292E;">();</span><span style="color:#6A737D;">//提交事务</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                session.</span><span style="color:#6F42C1;">rollback</span><span style="color:#24292E;">();</span><span style="color:#6A737D;">//回滚事务</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e1</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="消息确认机制" tabindex="-1">消息确认机制 <a class="header-anchor" href="#消息确认机制" aria-label="Permalink to &quot;消息确认机制&quot;">​</a></h2><p>  JMS消息只有在被确认之后，才认为已经被成功地消费了。消息的成功消费通常包含三个阶段：客户接收消息、客户处理消息和消息被确认。在事务性会话中，当一个事务被提交的时候，确认自动发生。在非事务性会话中，消息何时被确认取决于创建会话时的应答模式（acknowledgement mode）。该参数有以下三个可选值：</p><table><thead><tr><th>值</th><th>描述</th></tr></thead><tbody><tr><td>Session.AUTO_ACKNOWLEDGE</td><td>当客户成功的从receive方法返回的时候，或者从MessageListener.onMessage方法成功返回的时候，会话自动确认客户收到的消息</td></tr><tr><td>Session.CLIENT_ACKNOWLEDGE</td><td>客户通过消息的acknowledge方法确认消息。需要注意的是，在这种模式中，确认是在会话层上进行：确认一个被消费的消息将自动确认所有已被会话消费的消息。例如，如果一个消息消费者消费了10个消息，然后确认第5个消息，那么所有10个消息都被确认</td></tr><tr><td>Session.DUPS_ACKNOWLEDGE</td><td>该选择只是会话迟钝确认消息的提交。如果JMS provider失败，那么可能会导致一些重复的消息。如果是重复的消息，那么JMS provider必须把消息头的MSRedelivered字段设置为true</td></tr></tbody></table><p>  注意：消息确认机制与事务机制是冲突的，只能选其中一种。所以演示消息确认前，先关闭事务。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 配置类</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Configuration</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ActiveMqConfig</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">name</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> DefaultJmsListenerContainerFactory </span><span style="color:#DCBDFB;">jmsListenerContainerFactory</span><span style="color:#ADBAC7;">(ConnectionFactory </span><span style="color:#F69D50;">connectionFactory</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">        DefaultJmsListenerContainerFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">factory</span><span style="color:#F47067;">=new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">DefaultJmsListenerContainerFactory</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setConnectionFactory</span><span style="color:#ADBAC7;">(connectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setSessionTransacted</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">); </span><span style="color:#768390;">// 不开启事务操作</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setSessionAcknowledgeMode</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">); </span><span style="color:#768390;">//自动确认</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">// factory.setSessionAcknowledgeMode(4); //手动确认</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> factory;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// auto_acknowledge 自动确认</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">JmsListener</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">destination</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;\${activemq.name}&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">containerFactory</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">receiveMessage</span><span style="color:#ADBAC7;">(TextMessage textMessage){</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息内容：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getText</span><span style="color:#ADBAC7;">() </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;,是否重发：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getJMSRedelivered</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">throw</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">RuntimeException</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;test&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">// client_acknowledge 手动确认</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">JmsListener</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">destination</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;\${activemq.name}&quot;</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">containerFactory</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">receiveMessage</span><span style="color:#ADBAC7;">(TextMessage textMessage){</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息内容：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getText</span><span style="color:#ADBAC7;">() </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;,是否重发：&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> textMessage.</span><span style="color:#DCBDFB;">getJMSRedelivered</span><span style="color:#ADBAC7;">());</span></span>
<span class="line"><span style="color:#ADBAC7;">        textMessage.</span><span style="color:#DCBDFB;">acknowledge</span><span style="color:#ADBAC7;">(); </span><span style="color:#768390;">// 确认收到消息，一旦消息确认，消息不会重新发送</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">throw</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">RuntimeException</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;test&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (JMSException </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 配置类</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Configuration</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ActiveMqConfig</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> DefaultJmsListenerContainerFactory </span><span style="color:#6F42C1;">jmsListenerContainerFactory</span><span style="color:#24292E;">(ConnectionFactory </span><span style="color:#E36209;">connectionFactory</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        DefaultJmsListenerContainerFactory factory</span><span style="color:#D73A49;">=new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DefaultJmsListenerContainerFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setConnectionFactory</span><span style="color:#24292E;">(connectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setSessionTransacted</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// 不开启事务操作</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setSessionAcknowledgeMode</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">//自动确认</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// factory.setSessionAcknowledgeMode(4); //手动确认</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> factory;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// auto_acknowledge 自动确认</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">JmsListener</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">destination</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;\${activemq.name}&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">containerFactory</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">receiveMessage</span><span style="color:#24292E;">(TextMessage textMessage){</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息内容：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getText</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;,是否重发：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getJMSRedelivered</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RuntimeException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// client_acknowledge 手动确认</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">JmsListener</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">destination</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;\${activemq.name}&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">containerFactory</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">receiveMessage</span><span style="color:#24292E;">(TextMessage textMessage){</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息内容：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getText</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;,是否重发：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> textMessage.</span><span style="color:#6F42C1;">getJMSRedelivered</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        textMessage.</span><span style="color:#6F42C1;">acknowledge</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 确认收到消息，一旦消息确认，消息不会重新发送</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RuntimeException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (JMSException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="消息投递方式" tabindex="-1">消息投递方式 <a class="header-anchor" href="#消息投递方式" aria-label="Permalink to &quot;消息投递方式&quot;">​</a></h2><h3 id="同步发送" tabindex="-1">同步发送 <a class="header-anchor" href="#同步发送" aria-label="Permalink to &quot;同步发送&quot;">​</a></h3><p>  消息生产者使用持久（Persistent）传递模式发送消息的时候，Producer.send() 方法会被阻塞，直到broker 发送一个确认消息给生产者(ProducerAck)，这个确认消息暗示broker已经成功接收到消息并把消息保存到二级存储中。</p><h3 id="异步发送" tabindex="-1">异步发送 <a class="header-anchor" href="#异步发送" aria-label="Permalink to &quot;异步发送&quot;">​</a></h3><p>  如果应用程序能够容忍一些消息的丢失，那么可以使用异步发送。异步发送不会在受到broker的确认之前一直阻塞 Producer.send方法。</p><p>  默认情况(alwaysSyncSend=false,useAsyncSend=false)，非持久化消息、事务内的消息均采用异步发送；对于持久化消息采用同步发送。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Configuration</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ActiveConfig</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#768390;">    /**</span></span>
<span class="line"><span style="color:#768390;">    * 配置用于异步发送的非持久化JmsTemplate</span></span>
<span class="line"><span style="color:#768390;">    */</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Autowired</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> JmsTemplate </span><span style="color:#DCBDFB;">asynJmsTemplate</span><span style="color:#ADBAC7;">(PooledConnectionFactory </span><span style="color:#F69D50;">pooledConnectionFactory</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        JmsTemplate</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">template</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">JmsTemplate</span><span style="color:#ADBAC7;">(pooledConnectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">        template.</span><span style="color:#DCBDFB;">setExplicitQosEnabled</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        template.</span><span style="color:#DCBDFB;">setDeliveryMode</span><span style="color:#ADBAC7;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> template;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#768390;">    /**</span></span>
<span class="line"><span style="color:#768390;">    * 配置用于同步发送的持久化JmsTemplate</span></span>
<span class="line"><span style="color:#768390;">    */</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Autowired</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> JmsTemplate </span><span style="color:#DCBDFB;">synJmsTemplate</span><span style="color:#ADBAC7;">(PooledConnectionFactory </span><span style="color:#F69D50;">pooledConnectionFactory</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        JmsTemplate</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">template</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">JmsTemplate</span><span style="color:#ADBAC7;">(pooledConnectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> template;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">* 异步投递，回调函数，以确认消息是否发送成功！</span></span>
<span class="line"><span style="color:#768390;">* </span><span style="color:#F47067;">@return</span></span>
<span class="line"><span style="color:#768390;">*/</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">RequestMapping</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;/send&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> String </span><span style="color:#DCBDFB;">sendQueue</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">    Connection</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connection</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    Session</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">session</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    ActiveMQMessageProducer</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">producer</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 获取连接工厂</span></span>
<span class="line"><span style="color:#ADBAC7;">    ConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> jmsMessagingTemplate.</span><span style="color:#DCBDFB;">getConnectionFactory</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">        connection </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connectionFactory.</span><span style="color:#DCBDFB;">createConnection</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        session </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connection.</span><span style="color:#DCBDFB;">createSession</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">        Queue</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queue</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createQueue</span><span style="color:#ADBAC7;">(name);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">count</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">10</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        producer </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createProducer</span><span style="color:#ADBAC7;">(queue);</span></span>
<span class="line"><span style="color:#ADBAC7;">        producer.</span><span style="color:#DCBDFB;">setDeliveryMode</span><span style="color:#ADBAC7;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">long</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">start</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> System.</span><span style="color:#DCBDFB;">currentTimeMillis</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">for</span><span style="color:#ADBAC7;"> (</span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">i</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">; i </span><span style="color:#F47067;">&lt;</span><span style="color:#ADBAC7;"> count; i</span><span style="color:#F47067;">++</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//创建需要发送的消息</span></span>
<span class="line"><span style="color:#ADBAC7;">            TextMessage</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">textMessage</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createTextMessage</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;Hello&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span><span style="color:#768390;">//设置消息唯一ID</span></span>
<span class="line"><span style="color:#ADBAC7;">            String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">msgid</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> UUID.</span><span style="color:#DCBDFB;">randomUUID</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">toString</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">            textMessage.</span><span style="color:#DCBDFB;">setJMSMessageID</span><span style="color:#ADBAC7;">(msgid);</span></span>
<span class="line"><span style="color:#ADBAC7;">            producer.</span><span style="color:#DCBDFB;">send</span><span style="color:#ADBAC7;">(textMessage, </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">AsyncCallback</span><span style="color:#ADBAC7;">() {</span></span>
<span class="line"><span style="color:#ADBAC7;">                @</span><span style="color:#F47067;">Override</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">onSuccess</span><span style="color:#ADBAC7;">() {</span></span>
<span class="line"><span style="color:#ADBAC7;">                    </span><span style="color:#768390;">// 使用msgid标识来进行消息发送成功的处理</span></span>
<span class="line"><span style="color:#ADBAC7;">                    System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(msgid</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot; 消息发送成功&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">                }</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span></span>
<span class="line"><span style="color:#ADBAC7;">                @</span><span style="color:#F47067;">Override</span></span>
<span class="line"><span style="color:#ADBAC7;">                </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">onException</span><span style="color:#ADBAC7;">(JMSException </span><span style="color:#F69D50;">exception</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">                    </span><span style="color:#768390;">// 使用msgid表示进行消息发送失败的处理</span></span>
<span class="line"><span style="color:#ADBAC7;">                    System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(msgid</span><span style="color:#F47067;">+</span><span style="color:#96D0FF;">&quot; 消息发送失败&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">                    exception.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">                }</span></span>
<span class="line"><span style="color:#ADBAC7;">            });</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">        session.</span><span style="color:#DCBDFB;">commit</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (Exception </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;ok&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Configuration</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ActiveConfig</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#6A737D;">    /**</span></span>
<span class="line"><span style="color:#6A737D;">    * 配置用于异步发送的非持久化JmsTemplate</span></span>
<span class="line"><span style="color:#6A737D;">    */</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> JmsTemplate </span><span style="color:#6F42C1;">asynJmsTemplate</span><span style="color:#24292E;">(PooledConnectionFactory </span><span style="color:#E36209;">pooledConnectionFactory</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        JmsTemplate template </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JmsTemplate</span><span style="color:#24292E;">(pooledConnectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">        template.</span><span style="color:#6F42C1;">setExplicitQosEnabled</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        template.</span><span style="color:#6F42C1;">setDeliveryMode</span><span style="color:#24292E;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> template;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;">    /**</span></span>
<span class="line"><span style="color:#6A737D;">    * 配置用于同步发送的持久化JmsTemplate</span></span>
<span class="line"><span style="color:#6A737D;">    */</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> JmsTemplate </span><span style="color:#6F42C1;">synJmsTemplate</span><span style="color:#24292E;">(PooledConnectionFactory </span><span style="color:#E36209;">pooledConnectionFactory</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        JmsTemplate template </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JmsTemplate</span><span style="color:#24292E;">(pooledConnectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> template;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* 异步投递，回调函数，以确认消息是否发送成功！</span></span>
<span class="line"><span style="color:#6A737D;">* </span><span style="color:#D73A49;">@return</span></span>
<span class="line"><span style="color:#6A737D;">*/</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">RequestMapping</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/send&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> String </span><span style="color:#6F42C1;">sendQueue</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">    Connection connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    Session session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    ActiveMQMessageProducer producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取连接工厂</span></span>
<span class="line"><span style="color:#24292E;">    ConnectionFactory connectionFactory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> jmsMessagingTemplate.</span><span style="color:#6F42C1;">getConnectionFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connectionFactory.</span><span style="color:#6F42C1;">createConnection</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connection.</span><span style="color:#6F42C1;">createSession</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#24292E;">        Queue queue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createQueue</span><span style="color:#24292E;">(name);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> count </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createProducer</span><span style="color:#24292E;">(queue);</span></span>
<span class="line"><span style="color:#24292E;">        producer.</span><span style="color:#6F42C1;">setDeliveryMode</span><span style="color:#24292E;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> start </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> System.</span><span style="color:#6F42C1;">currentTimeMillis</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> count; i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//创建需要发送的消息</span></span>
<span class="line"><span style="color:#24292E;">            TextMessage textMessage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createTextMessage</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Hello&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//设置消息唯一ID</span></span>
<span class="line"><span style="color:#24292E;">            String msgid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> UUID.</span><span style="color:#6F42C1;">randomUUID</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">toString</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            textMessage.</span><span style="color:#6F42C1;">setJMSMessageID</span><span style="color:#24292E;">(msgid);</span></span>
<span class="line"><span style="color:#24292E;">            producer.</span><span style="color:#6F42C1;">send</span><span style="color:#24292E;">(textMessage, </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AsyncCallback</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">                @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">onSuccess</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 使用msgid标识来进行消息发送成功的处理</span></span>
<span class="line"><span style="color:#24292E;">                    System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(msgid</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot; 消息发送成功&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                </span></span>
<span class="line"><span style="color:#24292E;">                @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">onException</span><span style="color:#24292E;">(JMSException </span><span style="color:#E36209;">exception</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 使用msgid表示进行消息发送失败的处理</span></span>
<span class="line"><span style="color:#24292E;">                    System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(msgid</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot; 消息发送失败&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                    exception.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            });</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        session.</span><span style="color:#6F42C1;">commit</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Exception </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ok&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="延迟投递" tabindex="-1">延迟投递 <a class="header-anchor" href="#延迟投递" aria-label="Permalink to &quot;延迟投递&quot;">​</a></h3><p>  生产者提供两个发送消息的方法，一个是即时发送消息，一个是延时发送消息。</p><ol><li>修改activemq.xml</li></ol><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">&lt;</span><span style="color:#8DDB8C;">broker</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">xmlns</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;http://activemq.apache.org/schema/core&quot;</span><span style="color:#ADBAC7;"> ...</span></span>
<span class="line"><span style="color:#6CB6FF;">schedulerSupport</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;true&quot;</span><span style="color:#ADBAC7;"> &gt;  </span><span style="color:#768390;">&lt;!-- 添加schedulerSupport=&quot;true&quot;配置 --&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">......</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;/</span><span style="color:#8DDB8C;">broker</span><span style="color:#ADBAC7;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">broker</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">xmlns</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;http://activemq.apache.org/schema/core&quot;</span><span style="color:#24292E;"> ...</span></span>
<span class="line"><span style="color:#6F42C1;">schedulerSupport</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;"> &gt;  </span><span style="color:#6A737D;">&lt;!-- 添加schedulerSupport=&quot;true&quot;配置 --&gt;</span></span>
<span class="line"><span style="color:#24292E;">......</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">broker</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><ol start="2"><li>在代码中设置延迟时长</li></ol><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">/**</span></span>
<span class="line"><span style="color:#768390;">* 延时投递</span></span>
<span class="line"><span style="color:#768390;">*/</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> String </span><span style="color:#DCBDFB;">sendQueue</span><span style="color:#ADBAC7;">() {</span></span>
<span class="line"><span style="color:#ADBAC7;">    Connection</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connection</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    Session</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">session</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    ActiveMQMessageProducer</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">producer</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 获取连接工厂</span></span>
<span class="line"><span style="color:#ADBAC7;">    ConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">connectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> jmsMessagingTemplate.</span><span style="color:#DCBDFB;">getConnectionFactory</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">try</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">        connection </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connectionFactory.</span><span style="color:#DCBDFB;">createConnection</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        session </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> connection.</span><span style="color:#DCBDFB;">createSession</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#ADBAC7;">        Queue</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">queue</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createQueue</span><span style="color:#ADBAC7;">(name);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">int</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">count</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">10</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">        producer </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> (ActiveMQMessageProducer) session.</span><span style="color:#DCBDFB;">createProducer</span><span style="color:#ADBAC7;">(queue);</span></span>
<span class="line"><span style="color:#ADBAC7;">        producer.</span><span style="color:#DCBDFB;">setDeliveryMode</span><span style="color:#ADBAC7;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//创建需要发送的消息</span></span>
<span class="line"><span style="color:#ADBAC7;">        TextMessage</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">textMessage</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> session.</span><span style="color:#DCBDFB;">createTextMessage</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;Hello&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//设置延时时长(延时10秒)</span></span>
<span class="line"><span style="color:#ADBAC7;">        textMessage.</span><span style="color:#DCBDFB;">setLongProperty</span><span style="color:#ADBAC7;">(ScheduledMessage.AMQ_SCHEDULED_DELAY, </span><span style="color:#6CB6FF;">10000</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        producer.</span><span style="color:#DCBDFB;">send</span><span style="color:#ADBAC7;">(textMessage);</span></span>
<span class="line"><span style="color:#ADBAC7;">        session.</span><span style="color:#DCBDFB;">commit</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    } </span><span style="color:#F47067;">catch</span><span style="color:#ADBAC7;"> (Exception </span><span style="color:#F69D50;">e</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        e.</span><span style="color:#DCBDFB;">printStackTrace</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;ok&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* 延时投递</span></span>
<span class="line"><span style="color:#6A737D;">*/</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> String </span><span style="color:#6F42C1;">sendQueue</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    Connection connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    Session session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    ActiveMQMessageProducer producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取连接工厂</span></span>
<span class="line"><span style="color:#24292E;">    ConnectionFactory connectionFactory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> jmsMessagingTemplate.</span><span style="color:#6F42C1;">getConnectionFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        connection </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connectionFactory.</span><span style="color:#6F42C1;">createConnection</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        session </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connection.</span><span style="color:#6F42C1;">createSession</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, Session.AUTO_ACKNOWLEDGE);</span></span>
<span class="line"><span style="color:#24292E;">        Queue queue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createQueue</span><span style="color:#24292E;">(name);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> count </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        producer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (ActiveMQMessageProducer) session.</span><span style="color:#6F42C1;">createProducer</span><span style="color:#24292E;">(queue);</span></span>
<span class="line"><span style="color:#24292E;">        producer.</span><span style="color:#6F42C1;">setDeliveryMode</span><span style="color:#24292E;">(DeliveryMode.NON_PERSISTENT);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//创建需要发送的消息</span></span>
<span class="line"><span style="color:#24292E;">        TextMessage textMessage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.</span><span style="color:#6F42C1;">createTextMessage</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Hello&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//设置延时时长(延时10秒)</span></span>
<span class="line"><span style="color:#24292E;">        textMessage.</span><span style="color:#6F42C1;">setLongProperty</span><span style="color:#24292E;">(ScheduledMessage.AMQ_SCHEDULED_DELAY, </span><span style="color:#005CC5;">10000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        producer.</span><span style="color:#6F42C1;">send</span><span style="color:#24292E;">(textMessage);</span></span>
<span class="line"><span style="color:#24292E;">        session.</span><span style="color:#6F42C1;">commit</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Exception </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ok&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="定时投递" tabindex="-1">定时投递 <a class="header-anchor" href="#定时投递" aria-label="Permalink to &quot;定时投递&quot;">​</a></h3><ol><li>启动类添加定时注解</li></ol><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">SpringBootApplication</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">EnableScheduling</span><span style="color:#ADBAC7;"> </span><span style="color:#768390;">// 开启定时功能</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">MyActiveMQApplication</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">static</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">main</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">String</span><span style="color:#ADBAC7;">[] </span><span style="color:#F69D50;">args</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        SpringApplication.</span><span style="color:#DCBDFB;">run</span><span style="color:#ADBAC7;">(MyActiveMQApplication.class,args);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">SpringBootApplication</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">EnableScheduling</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 开启定时功能</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MyActiveMQApplication</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        SpringApplication.</span><span style="color:#6F42C1;">run</span><span style="color:#24292E;">(MyActiveMQApplication.class,args);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ol start="2"><li>在生产者添加@Scheduled设置定时</li></ol><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#768390;">// 消息生产者</span></span>
<span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Component</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ProducerController3</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Value</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;\${activemq.name}&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> String</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">name;</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Autowired</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">private</span><span style="color:#ADBAC7;"> JmsMessagingTemplate</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">jmsMessagingTemplate;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 设置延时投递，每隔3秒定投</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Scheduled</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">fixedDelay</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">3000</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">void</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">sendQueue</span><span style="color:#ADBAC7;">() {</span></span>
<span class="line"><span style="color:#ADBAC7;">        jmsMessagingTemplate.</span><span style="color:#DCBDFB;">convertAndSend</span><span style="color:#ADBAC7;">(name, </span><span style="color:#96D0FF;">&quot;消息ID:&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">+</span><span style="color:#ADBAC7;"> UUID.</span><span style="color:#DCBDFB;">randomUUID</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">toString</span><span style="color:#ADBAC7;">().</span><span style="color:#DCBDFB;">substring</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">,</span><span style="color:#6CB6FF;">6</span><span style="color:#ADBAC7;">));</span></span>
<span class="line"><span style="color:#ADBAC7;">        System.out.</span><span style="color:#DCBDFB;">println</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;消息发送成功...&quot;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 消息生产者</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Component</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ProducerController3</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;\${activemq.name}&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> String name;</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> JmsMessagingTemplate jmsMessagingTemplate;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 设置延时投递，每隔3秒定投</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Scheduled</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">fixedDelay</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sendQueue</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">        jmsMessagingTemplate.</span><span style="color:#6F42C1;">convertAndSend</span><span style="color:#24292E;">(name, </span><span style="color:#032F62;">&quot;消息ID:&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> UUID.</span><span style="color:#6F42C1;">randomUUID</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">toString</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">substring</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">6</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;消息发送成功...&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="死信队列" tabindex="-1">死信队列 <a class="header-anchor" href="#死信队列" aria-label="Permalink to &quot;死信队列&quot;">​</a></h2><p>  DLQ-Dead Letter Queue，死信队列，用来保存处理失败或者过期的消息。</p><p>  出现以下情况时，消息会被重发：</p><ul><li>A transacted session is used and rollback() is called.</li><li>A transacted session is closed before commit is called.</li><li>A session is using CLIENT_ACKNOWLEDGE and Session.recover() is called.</li></ul><p>  当一个消息被重发超过6(缺省为6次)次数时，会给broker发送一个&quot;Poison ack&quot;，这个消息被认为是apoison pill，这时broker会将这个消息发送到死信队列，以便后续处理。</p><p>  注意两点：</p><ol><li>缺省持久消息过期，会被送到DLQ，非持久消息不会送到DLQ</li><li>缺省的死信队列是ActiveMQ.DLQ，如果没有特别指定，死信都会被发送到这个队列。可以通过配置文件(activemq.xml)来调整死信发送策略。</li></ol><h3 id="java代码" tabindex="-1">java代码 <a class="header-anchor" href="#java代码" aria-label="Permalink to &quot;java代码&quot;">​</a></h3><ol><li>activemq.xml，为每个队列建立独立的死信队列</li></ol><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">&lt;</span><span style="color:#8DDB8C;">destinationPolicy</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">policyMap</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">        &lt;</span><span style="color:#8DDB8C;">policyEntries</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">            &lt;</span><span style="color:#8DDB8C;">policyEntry</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">queue</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;&gt;&quot;</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                &lt;</span><span style="color:#8DDB8C;">deadLetterStrategy</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                    &lt;</span><span style="color:#8DDB8C;">individualDeadLetterStrategy</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">queuePrefix</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;DLQ.&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">useQueueForQueueMessages</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;true&quot;</span><span style="color:#ADBAC7;"> /&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                &lt;/</span><span style="color:#8DDB8C;">deadLetterStrategy</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">            &lt;/</span><span style="color:#8DDB8C;">policyEntry</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">            </span></span>
<span class="line"><span style="color:#ADBAC7;">            &lt;</span><span style="color:#8DDB8C;">policyEntry</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">topic</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;&gt;&quot;</span><span style="color:#ADBAC7;"> &gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                &lt;</span><span style="color:#8DDB8C;">pendingMessageLimitStrategy</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                    &lt;</span><span style="color:#8DDB8C;">constantPendingMessageLimitStrategy</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">limit</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;1000&quot;</span><span style="color:#ADBAC7;">/&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">                &lt;/</span><span style="color:#8DDB8C;">pendingMessageLimitStrategy</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">            &lt;/</span><span style="color:#8DDB8C;">policyEntry</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">        &lt;/</span><span style="color:#8DDB8C;">policyEntries</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;/</span><span style="color:#8DDB8C;">policyMap</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;/</span><span style="color:#8DDB8C;">destinationPolicy</span><span style="color:#ADBAC7;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">destinationPolicy</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">policyMap</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">        &lt;</span><span style="color:#22863A;">policyEntries</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">            &lt;</span><span style="color:#22863A;">policyEntry</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">queue</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;&gt;&quot;</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">                &lt;</span><span style="color:#22863A;">deadLetterStrategy</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">                    &lt;</span><span style="color:#22863A;">individualDeadLetterStrategy</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">queuePrefix</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;DLQ.&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">useQueueForQueueMessages</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;"> /&gt;</span></span>
<span class="line"><span style="color:#24292E;">                &lt;/</span><span style="color:#22863A;">deadLetterStrategy</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">            &lt;/</span><span style="color:#22863A;">policyEntry</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">            </span></span>
<span class="line"><span style="color:#24292E;">            &lt;</span><span style="color:#22863A;">policyEntry</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">topic</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;&gt;&quot;</span><span style="color:#24292E;"> &gt;</span></span>
<span class="line"><span style="color:#24292E;">                &lt;</span><span style="color:#22863A;">pendingMessageLimitStrategy</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">                    &lt;</span><span style="color:#22863A;">constantPendingMessageLimitStrategy</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">limit</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;1000&quot;</span><span style="color:#24292E;">/&gt;</span></span>
<span class="line"><span style="color:#24292E;">                &lt;/</span><span style="color:#22863A;">pendingMessageLimitStrategy</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">            &lt;/</span><span style="color:#22863A;">policyEntry</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">        &lt;/</span><span style="color:#22863A;">policyEntries</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;/</span><span style="color:#22863A;">policyMap</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">destinationPolicy</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><ol start="2"><li>RedeliveryPolicy重发策略设置</li></ol><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark-dimmed vp-code-dark"><code><span class="line"><span style="color:#ADBAC7;">@</span><span style="color:#F47067;">Configuration</span></span>
<span class="line"><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">class</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">ActiveMqConfig</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//RedeliveryPolicy重发策略设置</span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> RedeliveryPolicy </span><span style="color:#DCBDFB;">redeliveryPolicy</span><span style="color:#ADBAC7;">(){</span></span>
<span class="line"><span style="color:#ADBAC7;">        RedeliveryPolicy</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">redeliveryPolicy</span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">RedeliveryPolicy</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//是否在每次尝试重新发送失败后,增长这个等待时间</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setUseExponentialBackOff</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//重发次数,默认为6次 这里设置为10次</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setMaximumRedeliveries</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">10</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//重发时间间隔,默认为1秒</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setInitialRedeliveryDelay</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//第一次失败后重新发送之前等待500毫秒,第二次失败再等待500 * 2毫秒,这里的2就是value</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setBackOffMultiplier</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">2</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//是否避免消息碰撞</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setUseCollisionAvoidance</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">false</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">//设置重发最大拖延时间-1 表示没有拖延只有UseExponentialBackOff(true)为true时生效</span></span>
<span class="line"><span style="color:#ADBAC7;">        redeliveryPolicy.</span><span style="color:#DCBDFB;">setMaximumRedeliveryDelay</span><span style="color:#ADBAC7;">(</span><span style="color:#F47067;">-</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> redeliveryPolicy;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> ActiveMQConnectionFactory </span><span style="color:#DCBDFB;">activeMQConnectionFactory</span><span style="color:#ADBAC7;"> (</span></span>
<span class="line"><span style="color:#ADBAC7;">        @</span><span style="color:#F47067;">Value</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&quot;\${spring.activemq.broker-url}&quot;</span><span style="color:#ADBAC7;">)String </span><span style="color:#F69D50;">url</span><span style="color:#ADBAC7;">,RedeliveryPolicy </span><span style="color:#F69D50;">redeliveryPolicy</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        ActiveMQConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">activeMQConnectionFactory</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">ActiveMQConnectionFactory</span><span style="color:#ADBAC7;">( </span><span style="color:#96D0FF;">&quot;admin&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;admin&quot;</span><span style="color:#ADBAC7;">, url);</span></span>
<span class="line"><span style="color:#ADBAC7;">        activeMQConnectionFactory.</span><span style="color:#DCBDFB;">setRedeliveryPolicy</span><span style="color:#ADBAC7;">(redeliveryPolicy);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> activeMQConnectionFactory;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> PlatformTransactionManager </span><span style="color:#DCBDFB;">transactionManager</span><span style="color:#ADBAC7;">(ConnectionFactory </span><span style="color:#F69D50;">connectionFactory</span><span style="color:#ADBAC7;">) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">JmsTransactionManager</span><span style="color:#ADBAC7;">(connectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span></span>
<span class="line"><span style="color:#ADBAC7;">    @</span><span style="color:#F47067;">Bean</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">name</span><span style="color:#F47067;">=</span><span style="color:#96D0FF;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#ADBAC7;">)</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">public</span><span style="color:#ADBAC7;"> DefaultJmsListenerContainerFactory </span><span style="color:#DCBDFB;">jmsListenerContainerFactory</span><span style="color:#ADBAC7;">(</span></span>
<span class="line"><span style="color:#ADBAC7;">        ConnectionFactory </span><span style="color:#F69D50;">connectionFactory</span><span style="color:#ADBAC7;">,PlatformTransactionManager </span><span style="color:#F69D50;">transactionManager</span><span style="color:#ADBAC7;">){</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span></span>
<span class="line"><span style="color:#ADBAC7;">        DefaultJmsListenerContainerFactory</span><span style="color:#F69D50;"> </span><span style="color:#ADBAC7;">factory</span><span style="color:#F47067;">=new</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">DefaultJmsListenerContainerFactory</span><span style="color:#ADBAC7;"> ();</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setTransactionManager</span><span style="color:#ADBAC7;">(transactionManager);</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setConnectionFactory</span><span style="color:#ADBAC7;">(connectionFactory);</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setSessionTransacted</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">); </span><span style="color:#768390;">// 开启事务</span></span>
<span class="line"><span style="color:#ADBAC7;">        factory.</span><span style="color:#DCBDFB;">setSessionAcknowledgeMode</span><span style="color:#ADBAC7;">(</span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> factory;</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Configuration</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ActiveMqConfig</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//RedeliveryPolicy重发策略设置</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> RedeliveryPolicy </span><span style="color:#6F42C1;">redeliveryPolicy</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        RedeliveryPolicy redeliveryPolicy</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RedeliveryPolicy</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//是否在每次尝试重新发送失败后,增长这个等待时间</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setUseExponentialBackOff</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//重发次数,默认为6次 这里设置为10次</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setMaximumRedeliveries</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//重发时间间隔,默认为1秒</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setInitialRedeliveryDelay</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//第一次失败后重新发送之前等待500毫秒,第二次失败再等待500 * 2毫秒,这里的2就是value</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setBackOffMultiplier</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//是否避免消息碰撞</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setUseCollisionAvoidance</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//设置重发最大拖延时间-1 表示没有拖延只有UseExponentialBackOff(true)为true时生效</span></span>
<span class="line"><span style="color:#24292E;">        redeliveryPolicy.</span><span style="color:#6F42C1;">setMaximumRedeliveryDelay</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> redeliveryPolicy;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> ActiveMQConnectionFactory </span><span style="color:#6F42C1;">activeMQConnectionFactory</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">        @</span><span style="color:#D73A49;">Value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;\${spring.activemq.broker-url}&quot;</span><span style="color:#24292E;">)String </span><span style="color:#E36209;">url</span><span style="color:#24292E;">,RedeliveryPolicy </span><span style="color:#E36209;">redeliveryPolicy</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        ActiveMQConnectionFactory activeMQConnectionFactory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ActiveMQConnectionFactory</span><span style="color:#24292E;">( </span><span style="color:#032F62;">&quot;admin&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;admin&quot;</span><span style="color:#24292E;">, url);</span></span>
<span class="line"><span style="color:#24292E;">        activeMQConnectionFactory.</span><span style="color:#6F42C1;">setRedeliveryPolicy</span><span style="color:#24292E;">(redeliveryPolicy);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> activeMQConnectionFactory;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> PlatformTransactionManager </span><span style="color:#6F42C1;">transactionManager</span><span style="color:#24292E;">(ConnectionFactory </span><span style="color:#E36209;">connectionFactory</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JmsTransactionManager</span><span style="color:#24292E;">(connectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Bean</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;jmsQueryListenerFactory&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> DefaultJmsListenerContainerFactory </span><span style="color:#6F42C1;">jmsListenerContainerFactory</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        ConnectionFactory </span><span style="color:#E36209;">connectionFactory</span><span style="color:#24292E;">,PlatformTransactionManager </span><span style="color:#E36209;">transactionManager</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        DefaultJmsListenerContainerFactory factory</span><span style="color:#D73A49;">=new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DefaultJmsListenerContainerFactory</span><span style="color:#24292E;"> ();</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setTransactionManager</span><span style="color:#24292E;">(transactionManager);</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setConnectionFactory</span><span style="color:#24292E;">(connectionFactory);</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setSessionTransacted</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// 开启事务</span></span>
<span class="line"><span style="color:#24292E;">        factory.</span><span style="color:#6F42C1;">setSessionAcknowledgeMode</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> factory;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div>`,58);function v(s,q,M,h,b,S){const o=t,e=r("ClientOnly");return l(),y("div",null,[g,A(e,null,{default:i(()=>{var n,a;return[(((n=s.$frontmatter)==null?void 0:n.aside)??!0)&&(((a=s.$frontmatter)==null?void 0:a.showArticleMetadata)??!0)?(l(),B(o,{key:0,article:s.$frontmatter},null,8,["article"])):F("",!0)]}),_:1}),m])}const f=c(d,[["render",v]]);export{T as __pageData,f as default};
